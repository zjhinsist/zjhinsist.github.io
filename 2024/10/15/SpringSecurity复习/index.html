<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>SpringSecurity | Nuyoah</title><meta name="author" content="Nuyoah"><meta name="copyright" content="Nuyoah"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringSecurity"><meta name="application-name" content="SpringSecurity"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="SpringSecurity"><meta property="og:url" content="http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/index.html"><meta property="og:site_name" content="Nuyoah"><meta property="og:description" content="第一章：SpringSecurity入门  功能  身份认证（authentication）  身份认证是验证谁正在访问系统资源 ，判断用户是否为合法用户。认证用户的常见方式是要求用户输入用户名和密码。   授权（authorization）  用户进行身份认证后，系统会控制谁能访问哪些资源，这个"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://s2.loli.net/2022/11/10/1dfka8LsM9ZKpVc.jpg?_r_=46ac48e8-86c9-d59d-624d-fef0a432f8c9"><meta property="article:author" content="Nuyoah"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://s2.loli.net/2022/11/10/1dfka8LsM9ZKpVc.jpg?_r_=46ac48e8-86c9-d59d-624d-fef0a432f8c9"><meta name="description" content="第一章：SpringSecurity入门  功能  身份认证（authentication）  身份认证是验证谁正在访问系统资源 ，判断用户是否为合法用户。认证用户的常见方式是要求用户输入用户名和密码。   授权（authorization）  用户进行身份认证后，系统会控制谁能访问哪些资源，这个"><link rel="shortcut icon" href="https://s1.ax1x.com/2022/11/27/zUFla6.png"><link rel="canonical" href="http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"404！加载失败！","backTitle":"加载成功！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.262259.xyz/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"","mailMd5":"a665f8c80fd739329dd0d3f3fe7d90fc"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Nuyoah","link":"链接: ","source":"来源: Nuyoah","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":true,"delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Nuyoah',
  title: 'SpringSecurity',
  postAI: '',
  pageFillDescription: ' 第一章：SpringSecurity入门,  功能,  案例-身份认证,  pom文件依赖,  创建基础启动类,  创建Controller对象,  创建前台页面,  SpringSecurity页面加载慢,  SpringSecurity做了什么,  SpringSecurity底层原理,  程序启动和运行,  DefaultSecurityFilterChain,  SecurityProperties,  第二章 SpringSecurity自定义配置,  基于内存的用户认证,  创建自定义配置,  基于内存的用户认证流程,  基于数据库的用户认证,  引入依赖,  配置数据源,  基于数据库的用户认证流程,  创建DBUserDetailsManager对象,  SpringSecurity的默认配置,  添加用户功能,  创建Controller,  创建Service,  实现DBUserDetailsManager方法,  密码加密算法,  密码加密方式,  PasswordEncoder,  DelegatingPasswordEncoder,  自定义登录页面,  创建登录页面,  更改配置项,  注意点,  第三章 前后端分离,  认证流程,  引入FastJson依赖,  认证成功响应,  认证失败相应,  注销处理,  请求未认证的接口,  跨越问题,  第四章 身份认证,  用户认证信息,  基本概念,  获取用户详细信息,  会话并发处理,  实现处理器接口,  配置接口,  第五章 授权,  基于Request的授权,  用户-权限-资源,  用户-角色-资源,  用户-角色-权限-资源,  基于方法的授权,  开启其方法授权,  给用户授予角色和权限,  常用授权注解,  第六章 OAuth2,  OAuth2简介,  是什么,  角色,  使用场景,  开放系统间授权,  社交登录,  开放API,  现代微服务安全,  单块应用安全,  微服务安全,  企业内部应用认证授权,  OAuth2四种授权方式,  第一种方式：授权码,  第二种方式：隐藏式,  第三种方式：密码式,  第四种方式：凭证式,  授权类型的选择,  Spring实现OAuth2,  Spring实现,  依赖,  授权登录的实现思路,  Github登录案例,  创建应用,  创建测试项目,  配置OAuth客户端属性,  创建Controller,  创建html页面,  启动应用程序,  案例分析,  登录流程,  CommonOAuth2Provider第一章入门功能身份认证身份认证是验证谁正在访问系统资源判断用户是否为合法用户认证用户的常见方式是要求用户输入用户名和密码授权用户进行身份认证后系统会控制谁能访问哪些资源这个过程叫做授权用户无法访问没有权限的资源防御常见攻击案例身份认证创建项目引入依赖文件依赖创建基础启动类创建对象创建前台页面页面加载慢引入之后会自动判断请求是否已经登录如果没有登录则会跳转到的自带登录页面可以使用登出系统自带登录页样式加载不出来会引入一个依赖我们需要开启梯子之后才能访问器样式做了什么保护应用的所有要求在访问该系统的的时候都需要进行身份验证自动生成了一个初始用户密码在控制台上生成登录页和登出页对于未登录的请求重定向到登录页面对应服务请求返回未授权处理跨站请求伪造攻击处理会话劫持攻击写入以确保写入以处理嗅探攻击写入头来保护经过身份验证的资源写入以处理点击劫持攻击底层原理是通过层层过滤器来进行操作的客户端进行访问请求的时候需要通过层层过滤器然后到达端传统的应用启动时需要将过滤器全部注册进中但是希望可以将过滤器设置成对象放到容器中进行管理通过来进行容器的代理可以将我们注册容器的中的对象中的过滤器加载到生命周期中方式先将自己的过滤器注册进对象中通过将自己注册的对象加载到生命周期中也是一个会被注册进行容器链中这样我们注册在容器中的过滤器就可以通过代理进容器中通常我们注册的都不只是一个所以管理的是一个链容器中可以有很多个链所以需要通过一个来进行过滤器链的管理链中可以有多个通过多个让我们程序更加灵活客户端通过向服务端发送请求的时候通过判断请求地址将请求送到指定的中进行处理如果中没有指定路径的请求则会送到最后一个中进行处理帮助调用中注册的帮助我们管理多个可以处理各种业务逻辑程序启动和运行实现了接口是的实现体默认实现个过滤器配置初始化用户名和密码用户名为密码为也可以通过配置文件来配置初始化用户名和密码在配置文件中修改默认用户第二章自定义配置基于内存的用户认证创建自定义配置用来管理用户信息是的一个实现用来管理内存用户信息创建对象表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解创建基于内存的用户管理对象使用来管理对象创建对象用于管理用户名用户密码用户角色用户权限等内容自定义用户名自定义密码自定义角色基于内存的用户认证流程程序启动时创建对象创建对象封装用户名密码通过我们创建的的对象中实现将初始化对象设置到内存管理对象中校验用户时在中拦截到发送的请求通过去校验用户名密码来获取用户对象并校验获取用户对象使用通过我们输入的用户名去内存中寻找该用户名的用户调用的方法去校验密码因为用户名已经在的方法中校验成功了如果无法根据我们输入的用户名来获取到指定用户则表明用户校验失败基于数据库的用户认证引入依赖配置数据源在文件中配置数据源基于数据库的用户认证流程类似基于内存的用户认证流程中首先创建了管理用户对象然后再通过创建对象来设置一个初始化对象放到内存中等后续来了用户之后使用中的方法从内存中获取我们初始化的用户对象在中的方法将用户输入的用户名和密码进行对比校验基于数据库的用户认证流程和基于内存的用户认证流程的区别是无需通过初始化用户到内存中重构方法通过用户名去数据库中获取相应的用户信息基于数据库的用户认证流程程序启动时创建对象实现这两个接口用户校验时通过调用的方法从数据库中获取对应的用户对象在中的方法对用户输入的账号密码和从数据库中查到的账号密码进行比对创建对象通过查询数据库对象用户名查询的用户对象异常通过查看中的方法当查不到该用户的时候出错误判断账号是否过期判断用户平判断用户是否为被锁定配置对象来进行用户获取表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解创建基于数据库的用户管理创建我们自己实现的的上述在配置文件中注册我们自己创建的对象是根据基于内存的用户创建方式类比过来的其实我们通过创建类实现了两个类我们创建的通过注解可以将放到的上下文中无需通过配置文件再次引入的默认配置表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护对所有请求开启授权保护已认证的请求会被自动授权表单授权方式基本授权方式添加用户功能创建创建自定义用户名自定义密码自定义角色实现方法密码加密算法密码加密方式明文密码密码以明文形式存储在数据库中但是恶意用户可能会通过注入等手段获取到明文密码或者程序员将数据库数据泄露的情况也可能发生算法的接口用于对密码进行单向转换从而将密码安全地存储对密码单向转换需要用到哈希算法例如等哈希算法是单向的只能加密不能解密因此数据库中存储的是单向转换后的密码在进行用户身份验证时需要将用户输入的密码进行单向转换然后与数据库的密码进行比较因此如果发生数据泄露只有密码的单向哈希会被暴露由于哈希是单向的并且在给定哈希的情况下只能通过暴力破解的方式猜测密码彩虹表彩虹表就是一个庞大的针对各种可能的字母组合预先生成的哈希值集合有了它可以快速破解各类密码越是复杂的密码需的彩虹表就越大主流的彩虹表都是以上目前主要的算法有加盐密码为了减轻彩虹表的效果开发人员开始使用加盐密码不再只使用密码作为哈希函数的输入而是为每个用户的密码生成随机字节称为盐盐和用户的密码将一起经过哈希函数运算生成一个唯一的哈希盐将以明文形式与用户的密码一起存储然后当用户尝试进行身份验证时盐和用户输入的密码一起经过哈希函数运算再与存储的密码进行比较唯一的盐意味着彩虹表不再有效因为对于每个盐和密码的组合哈希都是不同的自适应单向函数随着硬件的不断发展加盐哈希也不再安全原因是计算机可以每秒执行数十亿次哈希计算这意味着我们可以轻松地破解每个密码现在开发人员开始使用自适应单向函数来存储密码使用自适应单向函数验证密码时故意占用资源故意使用大量的内存或其他资源自适应单向函数允许配置一个工作因子随着硬件的改进而增加我们建议将工作因子调整到系统中验证密码需要约一秒钟的时间这种权衡是为了让攻击者难以破解密码自适应单向函数包括和使用广泛支持的算法来对密码进行哈希为了增加对密码破解的抵抗力故意设计得较慢和其他自适应单向函数一样应该调整其参数使其在您的系统上验证一个密码大约需要秒的时间的默认实现使用强度建议您在自己的系统上调整和测试强度参数以便验证密码时大约需要秒的时间使用算法对密码进行哈希处理是密码哈希比赛的获胜者为了防止在自定义硬件上进行密码破解是一种故意缓慢的算法需要大量内存与其他自适应单向函数一样它应该在您的系统上调整为大约秒来验证一个密码当前的实现需要使用库使用算法对密码进行哈希处理为了防止密码破解是一种故意缓慢的算法与其他自适应单户函数一样它应该在您的系统上调整为大约秒来验证一个密码当需要认证时这种算法是一个很好的选设置工作因子默认值是最小值最大值值越大运算速度越慢明文密文即使明文密码相同每次生成的密文也不一样密码校验密码不一致表中存储的密码形式通过如下源码可以知道可以通过前缀动态获取和密码的形式类型一致的对象目的方便随时做密码策略的升级兼容数据库中的老版本密码策略生成的密码自定义登录页面创建登录页面登录登录错误的用户名和密码用户名密码登录即使配置了登录页面也同样会跳转到默认登录页面更改配置项因为在配置中配置的了登录验证的页面配置的是默认的页面我们需要将自定义的登录页面配置到验证中并设置如果不设置该选项则会一直重定向因为不设置这个无需授权的选项登录页也需要授权但是当时我们并没有登录所以会跳转到自定义登录页面自定义登录页面有需要授权由此会重定向过多导致出错表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护对所有请求开启授权保护已认证的请求会被自动授权表单授权方式关闭网络攻击注意点登录参数必须是和如果参数名不是这两个则需要进行单独配置表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护对所有请求开启授权保护已认证的请求会被自动授权表单授权方式配置登录用户名参数默认是配置登录用户密码参数默认是关闭网络攻击配置失败的返回页面表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护对所有请求开启授权保护已认证的请求会被自动授权表单授权方式配置登录用户名参数默认是配置登录用户密码参数默认是配置登录失败的返回页面关闭网络攻击第三章前后端分离后端需要在登录成功或失败的时候返回给前端一个字符串而不是让控制前台页面跳转到登录页面认证流程用户在输入账号密码的时候是需要调用过滤器生成一个对象通过管理器来进行登录用户的认证登录成功最后调用处理器来处理成功结果失败最后调用来处理失败请求引入依赖认证成功响应配置认证成功处理器获取用户身份信息获取用户凭证信息如果用密码登录则获取的是密码获取用户权限信息设置返回结果设置相应结果将放回结果返回给前端将处理器注册进配置中表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护对所有请求开启授权保护已认证的请求会被自动授权表单授权方式配置登录用户名参数默认是配置登录用户密码参数默认是配置登录失败的返回页面注册登录成功处理器关闭网络攻击认证失败相应通认证成功相似先创建认证失败处理器获取登录失败信息设置响应头信息将失败信息返回给前台页面将认证失败处理器注册进配置中获取登录失败信息设置响应头信息将失败信息返回给前台页面注销处理类似登陆成功是登录失败处理流程先创建注销处理器注销成功注册进配置文件中表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解注册注销成功处理器关闭网络攻击请求未认证的接口当我们访问一个需要认证的的接口的时候会判断是否已经认证成功如果认证成功则可以访问如果未成功会自动调转到登录页面请求用户认证期望登录不成功的时候不进行页面的跳转而是返回信息我们需要实现接口获取未认证条件信息进行配置注册表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解为认证处理结果注册未认证结果处理器跨越问题跨域在网络请求中前台请求后台默认需要在同一台服务器上需要相同的和协议如果不同的话则会进行跨域拦截在前后台分离系统中可能前台系统和后台系统部署在不同的服务器中这时候前台系统的地址和后台服务的地址就不相同这时候我们需要进行跨域解决跨域全称是跨域资源共享它是浏览器的保护机制只允许网页请求统一域名下的服务同一域名指协议域名端口号都要保持一致如果有一项不同那么就是跨域请求在前后端分离的项目中需要解决跨域的问题在中解决跨域很简单在配置文件中添加如下配置即可跨域第四章身份认证用户认证信息基本概念在中与身份认证有关的是可以直接获取到用户信息和他们之间的关系是是存储用户详细信息的地方是从中获取的内容包含当前已认证的用户的信息表示用户的身份认证信息包含了和对象表示用户的身份标识通常是一个表示用户的实体对象例如用户名可以通过的方法获取表示用户的凭证信息例如密码证书或其他认证凭据可以通过对象的方法获取表示用户被授予的权限总结起来用于管理当前线程的安全上下文存储已认证用户的详细信息其中包含了对象该对象包含了对象后者表示用户的身份验证信息包括用户的身份标识和用户的凭证信息获取用户详细信息通过对象来获取用户上下文通过用户上下文来获取认证对象获取用户身份对象获取用户权限获取用登录凭证获取登录用户名设置相应信息会话并发处理选择同一个账号可以在几个设备进行登录如果超出规定设备数量的时候需要将前面的设备的会话注销通过接口来实现该功能实现处理器接口当超时被强制退出的时候需要调用该方法获取响应头向响应头中添加返回信息设置响应格式格式该账号已从其他设备登录配置接口在中配置表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解用户会话相关配置设置最大登录数量注册被强制退出之后才处理器第五章授权有两种授权形式用户权限资源将权限分配至用户上用户权限的用户才能访问指定的接口和指定的前台菜单或按钮用户角色权限资源将权限分配到角色上拥有该角色的用户都可以使用该角色的权限更加灵活基于的授权用户权限资源需求拥有权限的用户可以访问的接口拥有权限的用户可以访问的接口配置在配置项中配置指定资源需要的权限信息接口信息只有拥有权限的用户才能访问表明该类是一个配置类开的自定义配置在项目中可以省略项目会在引入的时候加载该注解开启授权保护配置权限只有拥有后面权限的用户才嫩访问对应的接口对所有请求开启授权保护已认证的请求会被自动授权配置用户信息在的方法中来获取用户信息并设置用户权限通过查看中的方法当查不到该用户的时候出错误手动设置用户权限判断账号是否过期判断用户平判断用户是否为被锁定在配置好用户信息之后如果拥有指定权限访问指定接口的时候可以访问通过如果没有指定权限访问指定接口的时候会返回无权限用户角色资源需求角色为的用户才可以访问路径下的资源和用户角色权限资源设置方法类似也是需要在过滤器中配置只是把改成即可过滤器配置开启授权保护配置权限只有拥有后面权限的用户才嫩访问对应的接口对所有请求开启授权保护已认证的请求会被自动授权在类中配置获取角色信息带上角色权限可以在数据库中配置角色信息这里就使用硬编码直接给用户附上角色之前的是通过新建一个用户通过查看中的方法当查不到该用户的时候出错误判断账号是否过期判断用户平判断用户是否为被锁定上面该方法无法直接个用户角色赋值使用方法来创建用户可以附带角色信息通过查看中的方法当查不到该用户的时候出错误判断账号是否没有过期判断用户平判断用户是否为被锁定用户名用户密码用户是否禁用用户是否过期账号是否锁定用户角色权限本质也是将角色信息放到权限中是将角色信息在前面添加一个标志例如上面的角色放到中是用户角色权限资源基于角色的访问控制是一种常用的数据库设计方案它将用户的权限分配和管理与角色相关联以下是一个基本的数据库设计方案的示例用户表包含用户的基本信息例如用户名密码和其他身份验证信息列名数据类型描述用户用户名密码电子邮件地址角色表存储所有可能的角色及其描述列名数据类型描述角色角色名称角色描述权限表定义系统中所有可能的权限列名数据类型描述权限权限名称权限描述用户角色关联表将用户与角色关联起来列名数据类型描述用户角色关联用户角色角色权限关联表将角色与权限关联起来列名数据类型描述角色权限关联角色权限在这个设计方案中用户可以被分配一个或多个角色而每个角色又可以具有一个或多个权限通过对用户角色关联和角色权限关联表进行操作可以实现灵活的权限管理和访问控制当用户尝试访问系统资源时系统可以根据用户的角色和权限决定是否允许访问这样的设计方案使得权限管理更加简单和可维护因为只需调整角色和权限的分配即可而不需要针对每个用户进行单独的设置基于方法的授权上述基于的授权是通过连接器实现的基于方法的授权是通过在方法上设置权授权注解实现的开启其方法授权在配置文件中添加上注解给用户授予角色和权限中的方法常用授权注解使用注解来进行权限校验使用和来进行权限认证方法需要拥有角色才能访问下面需要拥有权限才能访问也可以写复杂的权限表达式来进行判断下面就是同时需要拥有角色的用户和用户名是的用户才能访问接口第六章简介是什么表示授权是的简称表示开放连在一起就表示开放授权是一种开放授权协议首先需要有一个资源服务器来存放管理用户资源其次需要有一个客户应用来访问资源服务器通过资源服务器来获取指定资源信息如果有恶意程序来访问资源服务器时候如果资源服务器不加以检查则会导致用户数据泄露这时候需要给客户端应用颁发一个来进行用户认证拥有的应用才能访问用户数据谁给客户端颁发呢授权服务器授权服务器何时给用户颁发呢在客户端想要访问资源服务器的时候发现需要进而去授权服务器上要求授权服务器给自己颁发授权服务器去征求该用户的同意如果用户同意则进行颁发客户端就可以通过去资源服务器上访问该用户的资源了角色协议包含以下角色资源所有者即用户资源的拥有人想要通过客户应用访问资源服务器上的资源客户应用通常是一个或者无线应用它需要访问用户的受保护资源资源服务器存储受保护资源的服务器或定义了可以访问到资源的接收并验证客户端的访问令牌以决定是否授权访问资源授权服务器负责验证资源所有者的身份并向客户端颁发访问令牌代理授权资源所有者本身就拥有访问资源服务器上自己的资源信息但是现在想要通过客户应用来代理用户去访问资源服务器上对应用户的信息使用场景开放系统间授权社交登录在传统的身份验证中用户需要提供用户名和密码还有很多网站登录时允许使用第三方网站的身份这称为第三方登录所谓第三方登录实质就是授权用户想要登录网站网站让用户提供第三方网站的数据证明自己的身份获取第三方网站的身份数据就需要授权开放例如云冲印服务的实现现代微服务安全单块应用安全微服务安全企业内部应用认证授权单点登录身份识别与访问管理四种授权方式阮一峰的四种方式阮一峰的网络日志四种模式授权码隐藏式密码式客户端凭证第一种方式授权码授权码指的是第三方应用先申请一个授权码然后再用该码获取令牌这种方式是最常用最复杂也是最安全的它适用于那些有后端的应用授权码通过前端传送令牌则是储存在后端而且所有与资源服务器的通信都在后端完成这样的前后端分离可以避免令牌泄漏注册客户应用客户应用如果想要访问资源服务器需要有凭证需要在授权服务器上注册客户应用注册后会获取到一个和例如下图资源拥有者想通过前台页面去访问服务端内容类似我们在登陆的时候想要访问我们自己的仓库需要先登录我们通过身份认证来登录首先需要携带和跳转到的授权页面如果没有登录则需要先登录是用户认证的操作例如输入密码之类的操作进行用户认证之后返回授权码给后台获取到之后通过携带和去访问服务端去请求进行校验之后返回给认证登陆成功这时候就可以访问的一些受保护资源例如用户的昵称基本信息之类的东西第二种方式隐藏式隐藏式也叫简化模式有些应用是纯前端应用没有后端这时就不能用上面的方式了必须将令牌储存在前端规定了这种方式允许直接向前端颁发令牌这种方式没有授权码这个中间步骤所以称为隐藏式这种方式把令牌直接传给前端是很不安全的因此只能用于一些安全要求不高的场景并且令牌的有效期必须非常短通常就是会话期间有效浏览器关掉令牌就失效了资源拥有者通过前台页面方位授权服务器授权服务器直接返回携带的网址但是返回的地址无法直接解析前台页面通过访问一个专门的解析网址发服务资源服务端解析出之后前台页面通过访问端将访问令牌包含在锚点中的好处锚点在请求中不会发送到服务器减少了泄漏令牌的风险第三种方式密码式密码式如果你高度信任某个应用也允许用户把用户名和密码直接告诉该应用该应用就使用你的密码申请令牌就是像如果我想通过登录我不能直接在这里输入我的账号密码这样就会将资源服务器的账号密码暴漏给客户应用非常不安全客户端应用可能会通过此账号密码来对资源进行删除操作风险极大这种方式需要用户给出自己的用户名密码显然风险很大因此只适用于其他授权方式都无法采用的情况而且必须是用户高度信任的应用第四种方式凭证式凭证式也叫客户端模式适用于没有前端的命令行应用即在命令行下请求令牌这种方式给出的令牌是针对第三方应用的而不是针对用户的即有可能多个用户共享同一个令牌授权类型的选择实现实现可以实现的客户应用客户端功能中包含资源服务器需要独立实现的授权服务器它是在之上的一个单独的项目依赖资源服务器客户应用授权服务器授权登录的实现思路使用只需要实现客户应用对应的资源服务器和授权服务器都由别人设计好登录案例创建应用注册客户应用登录在开发者设置中找到创建一个为客户应用创建访问的凭据填写应用信息默认的重定向模板为是的唯一标识符获取应用程序生成应用程序密钥创建测试项目创建一个项目创建时引入如下依赖示例代码参考配置客户端属性创建创建页面启动应用程序启动程序并访问浏览器将被重定向到默认的自动生成的登录页面该页面显示了一个用于登录的链接点击链接浏览器将被重定向到进行身份验证使用账户凭据进行身份验证后用户会看到授权页面询问用户是否允许或拒绝客户应用访问上的用户数据点击允许以授权客户端访问用户的基本个人资料信息此时客户端访问的获取用户信息的接口获取基本个人资料信息并建立一个已认证的会话案例分析登录流程网站让用户跳转到并携带参数以及要求用户登录然后询问用户网站要求获取用户信息的权限你是否同意用户同意就会重定向回网站同时发回一个授权码网站使用授权码向请求令牌返回令牌网站使用令牌向请求用户数据返回用户数据网站使用用户数据登录是一个预定义的通用为一些知名资源服务提供商如预定义了一组默认的属性例如授权令牌和用户信息通常不经常变化因此提供默认值以减少所需的配置因此当我们配置客户端时只需要提供和属性授权回调地址向客户应用发送回调请求并携带授权码授权页面客户应用使用授权码向请求令牌客户应用使用令牌向请求用户数据属性显示中获取的哪个属性的信息登录页面超链接的文本',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-05 21:38:32',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 7.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://s1.ax1x.com/2022/11/27/zUFla6.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://262259.xyz/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://262259.xyz/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.262259.xyz/" title="博客后端"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://unpkg.com/qexo-static@1.4.0/assets/img/brand/qexo.png" alt="博客后端"/><span class="back-menu-item-text">博客后端</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Nuyoah</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Gitee/" style="font-size: 1.05rem;">Gitee<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 1.05rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JAVA<sup>5</sup></a><a href="/tags/JS/" style="font-size: 1.05rem;">JS<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>1</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>7</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>4</sup></a><a href="/tags/win10/" style="font-size: 1.05rem;">win10<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/" style="font-size: 1.05rem;">个人日记<sup>1</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 1.05rem;">人工智能<sup>15</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 1.05rem;">工作<sup>3</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF%E4%BA%8E%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字电路于逻辑<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" style="font-size: 1.05rem;">算法实现<sup>12</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">计算机基础<sup>13</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">SpringSecurity</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-10-15T00:39:29.000Z" title="发表于 2024-10-15 08:39:29">2024-10-15</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-11-05T13:38:32.602Z" title="更新于 2024-11-05 21:38:32">2024-11-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">11.9k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>44分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为石家庄"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>石家庄</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://s2.loli.net/2022/11/10/1dfka8LsM9ZKpVc.jpg?_r_=46ac48e8-86c9-d59d-624d-fef0a432f8c9"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/"><header><h1 id="CrawlerTitle" itemprop="name headline">SpringSecurity</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Nuyoah</span><time itemprop="dateCreated datePublished" datetime="2024-10-15T00:39:29.000Z" title="发表于 2024-10-15 08:39:29">2024-10-15</time><time itemprop="dateCreated datePublished" datetime="2024-11-05T13:38:32.602Z" title="更新于 2024-11-05 21:38:32">2024-11-05</time></header><h1 id="第一章springsecurity入门"><a class="markdownIt-Anchor" href="#第一章springsecurity入门"></a> 第一章：SpringSecurity入门</h1>
<h2 id="功能"><a class="markdownIt-Anchor" href="#功能"></a> 功能</h2>
<ul>
<li>身份认证（authentication）
<ul>
<li>身份认证是验证<code>谁正在访问系统资源</code> ，判断用户是否为合法用户。认证用户的常见方式是要求用户输入用户名和密码。</li>
</ul>
</li>
<li>授权（authorization）
<ul>
<li>用户进行身份认证后，系统会控制<code>谁能访问哪些资源</code>，这个过程叫做授权。用户无法访问没有权限的资源。</li>
</ul>
</li>
<li>防御常见攻击（protection against common attacks）
<ul>
<li>CSRF</li>
<li>HTTP Headers</li>
<li>HTTP Requests</li>
</ul>
</li>
</ul>
<h2 id="案例-身份认证"><a class="markdownIt-Anchor" href="#案例-身份认证"></a> 案例-身份认证</h2>
<p>创建项目引入依赖</p>
<h3 id="pom文件依赖"><a class="markdownIt-Anchor" href="#pom文件依赖"></a> pom文件依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建基础启动类"><a class="markdownIt-Anchor" href="#创建基础启动类"></a> 创建基础启动类</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSecurityDemoApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringSecurityDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建controller对象"><a class="markdownIt-Anchor" href="#创建controller对象"></a> 创建Controller对象</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建前台页面"><a class="markdownIt-Anchor" href="#创建前台页面"></a> 创建前台页面</h3>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello Security!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Security<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span>&gt;</span>Log Out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="springsecurity页面加载慢"><a class="markdownIt-Anchor" href="#springsecurity页面加载慢"></a> SpringSecurity页面加载慢</h3>
<p><strong>引入SpringSecurity之后，Security会自动判断请求是否已经登录，如果没有登录则会跳转到Security的自带登录页面，可以使用logout登出系统</strong></p>
<p><strong>SpringSecurity自带登录页样式加载不出来：</strong> SpringSecurity会引入一个Bootstrap依赖，我们需要开启梯子之后才能访问器样式</p>
<h3 id="springsecurity做了什么"><a class="markdownIt-Anchor" href="#springsecurity做了什么"></a> SpringSecurity做了什么</h3>
<ul>
<li>保护应用的所有URL，要求在访问该系统的URL的时候都需要进行身份验证</li>
<li>自动生成了一个初始用户user，密码在控制台上</li>
<li>生成登录页和登出页</li>
<li>对于未登录的web请求，重定向到登录页面</li>
<li>对应服务请求，返回401，未授权</li>
<li>处理跨站请求伪造（CSRF）攻击</li>
<li>处理会话劫持攻击</li>
<li>写入Strict-Transport-Security以确保HTTPS</li>
<li>写入X-Content-Type-Options以处理嗅探攻击</li>
<li>写入Cache-Control头来保护经过身份验证的资源</li>
<li>写入X-Frame-Options以处理点击劫持攻击</li>
</ul>
<h2 id="springsecurity底层原理"><a class="markdownIt-Anchor" href="#springsecurity底层原理"></a> SpringSecurity底层原理</h2>
<p>SpringSecurity是通过层层过滤器来进行操作的</p>
<p><strong>客户端进行访问请求的时候需要通过层层过滤器，然后到达Servlet端</strong></p>
<p>传统的应用启动时，<strong>需要将过滤器全部注册进Servlet中</strong>，但是Spring希望可以将过滤器设置成Bean对象，<strong>放到Spring容器中进行管理</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/PG5KDTaHVRvUgm4.png" alt="image-20241022220032015" /></p>
<p>通过<strong>DelegatingFilterProxy</strong>来进行Bean容器的代理，DelegatingFilterProxy可以将我们<strong>注册Spring容器的中的bean对象中的过滤器加载到Servlet生命周期中</strong></p>
<p>方式：先将自己的过滤器注册进Spring对象中，通过DelegatingFilterProxy将自己注册的filter对象加载到Servlet生命周期中</p>
<p>DelegatingFilterProxy也是一个FIlter，<strong>会被注册进行Servlet容器链中</strong>，这样我们注册在SpringBean容器中的过滤器就可以通过DelegatingFilterProxy代理进Servlet容器中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/7vruzeXDVdCkbJc.png" alt="image-20241022220521696" /></p>
<p>通常我们注册的Filter都不只是一个，所以DelegatingFilterProxy管理的是一个FIlter链</p>
<p>Spring容器中可以有很多个Filter链，所以DelegatingFilterProxy需要通过一个FilterChainProxy来进行过滤器链的管理</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/FzNAyHEgevSk1ml.png" alt="image-20241022221326815" style="zoom:67%;" />
<p>SpringFilter链中可以有多个Filter</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/MoZBORJ6zbGQuIf.png" alt="image-20241022221459823" style="zoom:67%;" />
<p>通过多个FilterChain让我们程序更加灵活</p>
<p>客户端通过向服务端发送请求的时候，FilterChainProxy通过判断请求地址，将请求送到指定的SecurityFilterChain中进行处理，如果SecurityFilterChain中没有指定路径的请求，则会送到最后一个SecurityFilterChain中进行处理</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/VdK4LDoRx5NI7fn.png" alt="image-20241022221619703" style="zoom: 67%;" />
<p><strong>DelegatingFilterProxy帮助调用Spring中注册的Filter，FilterChainProxy帮助我们管理多个SecurityFilterChain，SecurityFilterChain0 - n可以处理各种业务逻辑</strong></p>
<h2 id="程序启动和运行"><a class="markdownIt-Anchor" href="#程序启动和运行"></a> 程序启动和运行</h2>
<h3 id="defaultsecurityfilterchain"><a class="markdownIt-Anchor" href="#defaultsecurityfilterchain"></a> DefaultSecurityFilterChain</h3>
<p>DefaultSecurityFilterChain实现了SecurityFilterChain接口，是SecurityFilterChain的实现体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityFilterChain</span> <span class="keyword">implements</span> <span class="title class_">SecurityFilterChain</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultSecurityFilterChain默认实现15个过滤器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/vyClYwmaP54T8ou.png" alt="image-20241022223029593" /></p>
<h3 id="securityproperties"><a class="markdownIt-Anchor" href="#securityproperties"></a> SecurityProperties</h3>
<p>SecurityProperties配置Security初始化用户名和密码</p>
<p>用户名为user，密码为UUID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/a2bApQ3O9ru6RF7.png" alt="image-20241022223429771" /></p>
<p>也可以通过配置文件来配置初始化用户名和密码</p>
<p>在spring配置文件中修改默认用户</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SpringSecurityDemo</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<h1 id="第二章-springsecurity自定义配置"><a class="markdownIt-Anchor" href="#第二章-springsecurity自定义配置"></a> 第二章 SpringSecurity自定义配置</h1>
<h2 id="基于内存的用户认证"><a class="markdownIt-Anchor" href="#基于内存的用户认证"></a> 基于内存的用户认证</h2>
<h3 id="创建自定义配置"><a class="markdownIt-Anchor" href="#创建自定义配置"></a> 创建自定义配置</h3>
<p><strong>UserDetailsService</strong>用来管理用户信息， <strong>InMemoryUserDetailsServiceManager</strong>是UserDetailsService的一个实现，用来管理内存用户信息。</p>
<p>创建webSecurityConfig对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建基于内存的用户管理对象</span></span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        <span class="comment">// 使用InMemoryUserDetailsManager来管理UserDetails对象</span></span><br><span class="line">        manager.createUser(</span><br><span class="line">                <span class="comment">// 创建UserDetails对象，用于管理用户名，用户密码，用户角色，用户权限等内容</span></span><br><span class="line">                User.withDefaultPasswordEncoder()</span><br><span class="line">                        .username(<span class="string">&quot;user&quot;</span>)  <span class="comment">// 自定义用户名</span></span><br><span class="line">                        .password(<span class="string">&quot;password&quot;</span>) <span class="comment">// 自定义密码</span></span><br><span class="line">                        .roles(<span class="string">&quot;USER&quot;</span>) <span class="comment">// 自定义角色</span></span><br><span class="line">                        .build()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于内存的用户认证流程"><a class="markdownIt-Anchor" href="#基于内存的用户认证流程"></a> 基于内存的用户认证流程</h3>
<ul>
<li>程序启动时：
<ul>
<li>创建InMemoryUserDetailsManager对象</li>
<li>创建UserDetails对象，封装用户名密码</li>
<li>通过我们创建的userDetailsService的Bean对象中实现<strong>将初始化对象设置到InMemoryUserDetailsManager内存管理对象中</strong></li>
</ul>
</li>
<li>校验用户时：
<ul>
<li>在AbstractAuthenticationProcessingFilter中拦截到发送的请求</li>
<li>通过UsernamePasswordAuthenticationFilter去校验用户名密码</li>
<li>AbstractUserDetailsAuthenticationProvider来获取用户对象，并校验</li>
<li>DaoAuthenticationProvider获取用户对象</li>
<li>InMemoryUserDetailsServiceManager使用loadUserByUsername通过我们输入的用户名去内存中寻找该用户名的用户</li>
<li>AbstractUserDetailsAuthenticationProvider调用DaoAuthenticationProvider的additionalAuthenticationChecks方法去校验密码，因为用户名已经在InMemoryUserDetailsServiceManager的loadUserByUsername方法中校验成功了，如果loadUserByUsername无法根据我们输入的用户名来获取到指定用户，则表明用户校验失败</li>
</ul>
</li>
</ul>
<h2 id="基于数据库的用户认证"><a class="markdownIt-Anchor" href="#基于数据库的用户认证"></a> 基于数据库的用户认证</h2>
<h3 id="引入依赖"><a class="markdownIt-Anchor" href="#引入依赖"></a> 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.baomidou/mybatis-plus-boot-starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置数据源"><a class="markdownIt-Anchor" href="#配置数据源"></a> 配置数据源</h3>
<p>在application.yml文件中配置数据源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SpringSecurityDemo</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db2024</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<h3 id="基于数据库的用户认证流程"><a class="markdownIt-Anchor" href="#基于数据库的用户认证流程"></a> 基于数据库的用户认证流程</h3>
<p>类似<strong>基于内存的用户认证</strong>流程中</p>
<ul>
<li>
<p>首先<strong>创建了InMemoryUserDetailsManager管理用户对象</strong></p>
</li>
<li>
<p>然后再通过<strong>创建UserDetails对象来设置一个初始化对象放到内存中</strong></p>
</li>
<li>
<p>等后续来了用户之后，使用InMemoryUserDetailsServiceManager中的<strong>loadUserByUserName方法从内存中获取</strong>我们初始化的用户对象</p>
</li>
<li>
<p>在UsernamePasswordAuthenticationFilter中的attemptAuthentication方法将用户输入的用户名和密码进行对比校验</p>
</li>
</ul>
<p>基于数据库的用户认证流程和基于内存的用户认证流程的区别是</p>
<ul>
<li>无需通过初始化用户到内存中</li>
<li>重构loadUserByUserName方法，通过用户名去数据库中获取相应的用户信息</li>
</ul>
<p><strong>基于数据库的用户认证流程</strong><br />
程序启动时</p>
<ul>
<li>创建DBUserDetailsManager对象，实现 UserDetailsManager, UserDetailsPasswordService这两个接口</li>
</ul>
<p>用户校验时</p>
<ul>
<li>SpringSecurity通过调用DBUserDetailsManager的loadUserByUserName方法从数据库中获取对应的用户对象</li>
<li>在<strong>UsernamePasswordAuthenticationFilter</strong>中的<strong>attemptAuthentication</strong>方法对用户输入的账号密码和从数据库中查到的账号密码进行比对</li>
</ul>
<h3 id="创建dbuserdetailsmanager对象"><a class="markdownIt-Anchor" href="#创建dbuserdetailsmanager对象"></a> 创建DBUserDetailsManager对象</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBUserDetailsManager</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsManager</span>, UserDetailsPasswordService &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">updatePassword</span><span class="params">(UserDetails user, String newPassword)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(String oldPassword, String newPassword)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">userExists</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过Username查询数据库对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询的用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;().eq(User::getUsername, username));</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 通过查看InMemoryUserDetailsManager中的loadUserByUsername方法，当查不到该用户的时候throw出UsernameNotFoundException错误</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(username);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User(</span><br><span class="line">                    user.getUsername(),</span><br><span class="line">                    user.getPassword(),</span><br><span class="line">                    user.getEnabled(),</span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">// 判断账号是否过期</span></span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">// 判断用户平</span></span><br><span class="line">                    <span class="literal">true</span>, <span class="comment">// 判断用户是否为被锁定</span></span><br><span class="line">                    authorities);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置SecurityConfig对象来进行用户获取</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建基于数据库的用户管理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建我们自己实现的的DBUserDetailsManagers</span></span><br><span class="line">        <span class="type">DBUserDetailsManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DBUserDetailsManager</span>();</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述在配置文件中注册我们自己创建的DBUserDetailsManager对象，是根据基于内存的用户创建方式类比过来的。</p>
<p>其实我们通过创建DBUserDetailsManager类实现了UserDetailsManager, UserDetailsPasswordService两个类，我们创建的DBUserDetailsManager，通过@Configuration注解可以将DBUserDetailsManager放到SpringBoot的上下文中，无需通过配置文件再次引入</p>
<h2 id="springsecurity的默认配置"><a class="markdownIt-Anchor" href="#springsecurity的默认配置"></a> SpringSecurity的默认配置</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 表单授权方式</span></span><br><span class="line">                .formLogin(withDefaults())</span><br><span class="line">                <span class="comment">// 基本授权方式</span></span><br><span class="line">                .httpBasic(withDefaults());</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="添加用户功能"><a class="markdownIt-Anchor" href="#添加用户功能"></a> 添加用户功能</h2>
<h3 id="创建controller"><a class="markdownIt-Anchor" href="#创建controller"></a> 创建Controller</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUserDetail</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">    userService.saveUserDetail(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建service"><a class="markdownIt-Anchor" href="#创建service"></a> 创建Service</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUserDetail</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> org.springframework.security.core.userdetails.User.withDefaultPasswordEncoder()</span><br><span class="line">        .username(<span class="string">&quot;user&quot;</span>)  <span class="comment">// 自定义用户名</span></span><br><span class="line">        .password(<span class="string">&quot;password&quot;</span>) <span class="comment">// 自定义密码</span></span><br><span class="line">        .roles(<span class="string">&quot;USER&quot;</span>) <span class="comment">// 自定义角色</span></span><br><span class="line">        .build();</span><br><span class="line">    dbUserDetailsManager.createUser(userDetails);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现dbuserdetailsmanager方法"><a class="markdownIt-Anchor" href="#实现dbuserdetailsmanager方法"></a> 实现DBUserDetailsManager方法</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails userDetails)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setUsername(userDetails.getUsername());</span><br><span class="line">    user.setPassword(userDetails.getPassword());</span><br><span class="line">    userService.save(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="密码加密算法"><a class="markdownIt-Anchor" href="#密码加密算法"></a> 密码加密算法</h2>
<h3 id="密码加密方式"><a class="markdownIt-Anchor" href="#密码加密方式"></a> 密码加密方式</h3>
<p><strong>明文密码</strong>：</p>
<ul>
<li>密码以明文形式存储在数据库中。但是恶意用户可能会通过SQL注入等手段获取到明文密码，或者程序员将数据库数据泄露的情况也可能发生。</li>
</ul>
<p><strong>Hash算法</strong>：</p>
<ul>
<li>Spring Security的<strong>PasswordEncoder</strong> 接口用于对密码进行<strong>单向转换</strong>，从而将密码安全地存储。<strong>对密码单向转换需要用到哈希算法</strong> ，例如MD5、SHA-256、SHA-512等，哈希算法是单向的，<strong>只能加密，不能解密</strong></li>
<li>因此，<strong>数据库中存储的是单向转换后的密码</strong>，Spring Security在进行用户身份验证时需要将用户输入的密码进行单向转换，然后与数据库的密码进行比较</li>
<li>因此，如果发生数据泄露，只有密码的单向哈希会被暴露。由于哈希是单向的，并且在给定哈希的情况下只能通过<strong>暴力破解的方式猜测密码</strong>。</li>
</ul>
<p><strong>彩虹表：</strong></p>
<ul>
<li>彩虹表就是一个庞大的、针对各种可能的字母组合预先生成的哈希值集合，有了它可以快速破解各类密码。越是复杂的密码，需的彩虹表就越大，主流的彩虹表都是188G以上，目前主要的算法有LM，NTLM，MD5，SHA1，MYSQLSHA1，HALFLMCHALL，NTLMCHALL, ORACLE-SYSTEM, MD5-HALF</li>
</ul>
<p><strong>加盐密码：</strong></p>
<ul>
<li>为了减轻彩虹表的效果，开发人员开始使用加盐密码。不再只使用密码作为哈希函数的输入，而是<strong>为每个用户的密码生成随机字节</strong>(称为盐)。<strong>盐和用户的密码将一起经过哈希函数运算</strong>，生成一个唯一的哈希。盐将以明文形式与用户的密码一起存储。然后，当用户尝试进行身份验证时，盐和用户输入的密码一起经过哈希函数运算，再与存储的密码进行比较。唯一的盐意味着彩虹表不再有效，因为对于每个盐和密码的组合，哈希都是不同的。</li>
</ul>
<p><strong>自适应单向函数：</strong></p>
<ul>
<li>随着硬件的不断发展，加盐哈希也不再安全。原因是，计算机可以每秒执行数十亿次哈希计算。这意味着我们可以轻松地破解每个密码。</li>
<li>现在，开发人员开始使用自适应单向函数来存储密码。使用自适应单向函数验证密码时，<strong>故意占用资源(故意使用大量的CPU、内存或其他资源)</strong>。自适应单向函数允许配置一个“工作因子”，随着硬件的改进而增加。我们建议将“工作因子”调整到系统中验证密码需要约一秒钟的时间。这种权衡是为了<strong>让攻击者难以破解密码</strong>。</li>
<li>自适应单向函数包括bcrypt、PBKDF2、scrypt和argon2。</li>
</ul>
<h3 id="passwordencoder"><a class="markdownIt-Anchor" href="#passwordencoder"></a> PasswordEncoder</h3>
<p><strong>BcryptPasswordEncoder</strong></p>
<p>使用广泛支持的bcrypt算法来对密码进行哈希。为了增加对密码破解的抵抗力，bcrypt故意设计得较慢。和其他自适应单向函数一样，应该调整其参数，使其在您的系统上验证一个密码大约需要1秒的时间。</p>
<p>BCryptPasswordEncoder的默认实现使用强度10。建议您在自己的系统上调整和测试强度参数，以便验证密码时大约需要1秒的时间。</p>
<p><strong>Argon2PasswordEncoder</strong></p>
<p>使用Argon2算法对密码进行哈希处理。Argon2是密码哈希比赛的获胜者。为了防止在自定义硬件上进行密码破解，Argon2是一种故意缓慢的算法，需要大量内存。与其他自适应单向函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。</p>
<p>当前的Argon2PasswordEncoder实现需要使用BouncyCastle库。</p>
<p><strong>Pbkdf2PasswordEncoder</strong></p>
<p>使用PBKDF2算法对密码进行哈希处理。为了防止密码破解，PBKDF2是一种故意缓慢的算法。与其他自适应单户函数一样，它应该在您的系统上调整为大约1秒来验证一个密码。当需要FIPS认证时，这种算法是一个很好的选</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPassword</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 设置工作因子，默认值是0，最小值4，最大值31，值越大运算速度越慢</span></span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">// 明文：password</span></span><br><span class="line">    <span class="comment">// 密文：result,即使明文密码相同，每次生成的密文也不一样</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> encoder.encode(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    System.out.println(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密码校验</span></span><br><span class="line">    Assert.isTrue(encoder.matches(<span class="string">&quot;password&quot;</span>, result), <span class="string">&quot;密码不一致&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="delegatingpasswordencoder"><a class="markdownIt-Anchor" href="#delegatingpasswordencoder"></a> DelegatingPasswordEncoder</h3>
<ul>
<li>表中存储的密码形式:<strong>(bcrypt}</strong>$2aS10SGRLdNijsQMUvl/au9ofL.eDwmoohzzS7.mmNSJZ.0FxO/BTk76klW</li>
<li>通过如下源码可以知道:可以通过(bcrypt}前缀动态获取和密码的形式类型一致的PasswordEncoder对象</li>
<li>目的:方便随时做密码策略的升级，兼容数据库中的老版本密码策略生成的密码</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/27/2LSNKn7FPWAHZgk.png" alt="image-20241027213512881" /></p>
<h2 id="自定义登录页面"><a class="markdownIt-Anchor" href="#自定义登录页面"></a> 自定义登录页面</h2>
<h3 id="创建登录页面"><a class="markdownIt-Anchor" href="#创建登录页面"></a> 创建登录页面</h3>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;param.error&#125;&quot;</span>&gt;</span>错误的用户名和密码<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/login&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;用户名&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;密码&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>即使配置了登录页面，也同样会跳转到默认登录页面</strong></p>
<h3 id="更改配置项"><a class="markdownIt-Anchor" href="#更改配置项"></a> 更改配置项</h3>
<p>因为在SpringSecurity配置中配置的了登录验证的页面，配置的是默认的页面。</p>
<p>我们需要将自定义的登录页面，配置到验证中，<strong>并设置permitAll()</strong>，如果不设置该选项，则会一直重定向</p>
<p>因为不设置这个无需授权的选项，登录页也需要授权，但是当时我们并没有登录，所以会跳转到自定义登录页面，自定义登录页面有需要授权，由此会重定向过多导致出错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 表单授权方式</span></span><br><span class="line">                .formLogin(from -&gt; &#123;</span><br><span class="line">                    from.loginPage(<span class="string">&quot;/login&quot;</span>).permitAll();</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 关闭csrf网络攻击</span></span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="注意点"><a class="markdownIt-Anchor" href="#注意点"></a> 注意点</h3>
<p>登录参数必须是username和password，如果参数名不是这两个则需要进行单独配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 表单授权方式</span></span><br><span class="line">                .formLogin(from -&gt; &#123;</span><br><span class="line">                    from.loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                            .permitAll()</span><br><span class="line">                            .usernameParameter(<span class="string">&quot;myUsername&quot;</span>) <span class="comment">// 配置登录用户名参数 默认是username</span></span><br><span class="line">                            .passwordParameter(<span class="string">&quot;myPassword&quot;</span>); <span class="comment">// 配置登录用户密码参数，默认是password</span></span><br><span class="line">                    </span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 关闭csrf网络攻击</span></span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置失败的返回页面</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 表单授权方式</span></span><br><span class="line">                .formLogin(from -&gt; &#123;</span><br><span class="line">                    from.loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                            .permitAll()</span><br><span class="line">                            .usernameParameter(<span class="string">&quot;myUsername&quot;</span>) <span class="comment">// 配置登录用户名参数 默认是username</span></span><br><span class="line">                            .passwordParameter(<span class="string">&quot;myPassword&quot;</span>) <span class="comment">// 配置登录用户密码参数，默认是password</span></span><br><span class="line">                            .failureUrl(<span class="string">&quot;/login?failure&quot;</span>) <span class="comment">// 配置登录失败的返回页面</span></span><br><span class="line">                    ; </span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 关闭csrf网络攻击</span></span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="第三章-前后端分离"><a class="markdownIt-Anchor" href="#第三章-前后端分离"></a> 第三章 前后端分离</h1>
<p><strong>后端需要在登录成功或失败的时候返回给前端一个JSON字符串</strong>，而不是让控制前台页面跳转到登录页面</p>
<h2 id="认证流程"><a class="markdownIt-Anchor" href="#认证流程"></a> 认证流程</h2>
<p>用户在输入账号密码的时候是需要调用<strong>UsernamePasswordAuthenticationFilter</strong>过滤器<strong>生成一个UsernamePasswordAuthenticationToken对象</strong>，通过<strong>AuthenticationManager</strong>管理器来进行登录用户的认证。</p>
<p>登录成功最后调用AuthenticationSuccessHandler处理器来处理成功结果</p>
<p>失败最后调用AuthenticationFailureHandler来处理失败请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/10/28/fdOir54wERC8v7N.png" alt="usernamepasswordauthenticationfilter-16822329079281" /></p>
<h2 id="引入fastjson依赖"><a class="markdownIt-Anchor" href="#引入fastjson依赖"></a> 引入FastJson依赖</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="认证成功响应"><a class="markdownIt-Anchor" href="#认证成功响应"></a> 认证成功响应</h2>
<p>配置认证成功处理器AuthenticationSuccessHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal(); <span class="comment">// 获取用户身份信息</span></span><br><span class="line"><span class="comment">//        Object credentials = authentication.getCredentials(); // 获取用户凭证信息，如果用密码登录则获取的是密码</span></span><br><span class="line"><span class="comment">//        Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities(); // 获取用户权限信息</span></span><br><span class="line"></span><br><span class="line">        SysResult&lt;Object&gt; sysResult = <span class="keyword">new</span> <span class="title class_">SysResult</span>&lt;&gt;(); <span class="comment">// 设置返回结果</span></span><br><span class="line">        sysResult.ok(principal);</span><br><span class="line">        <span class="comment">// 设置Json相应结果</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 将放回结果返回给前端</span></span><br><span class="line">        response.getWriter().println(JSON.toJSONString(sysResult));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将处理器注册进SpringSecurity配置中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// 表单授权方式</span></span><br><span class="line">                .formLogin(from -&gt; &#123;</span><br><span class="line">                    from.loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                            .permitAll()</span><br><span class="line">                            .usernameParameter(<span class="string">&quot;username&quot;</span>) <span class="comment">// 配置登录用户名参数 默认是username</span></span><br><span class="line">                            .passwordParameter(<span class="string">&quot;password&quot;</span>) <span class="comment">// 配置登录用户密码参数，默认是password</span></span><br><span class="line">                            .failureUrl(<span class="string">&quot;/login?failure&quot;</span>) <span class="comment">// 配置登录失败的返回页面</span></span><br><span class="line">                            .successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>()) <span class="comment">// 注册登录成功处理器</span></span><br><span class="line">                    ;</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 关闭csrf网络攻击</span></span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="认证失败相应"><a class="markdownIt-Anchor" href="#认证失败相应"></a> 认证失败相应</h2>
<p>通认证成功相似</p>
<p><strong>先创建认证失败处理器</strong></p>
<p>MyAuthenticationFailureHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 获取登录失败信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localizedMessage</span> <span class="operator">=</span> exception.getLocalizedMessage();</span><br><span class="line">        <span class="comment">// 设置响应头信息</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 将失败信息返回给前台页面</span></span><br><span class="line">        response.getWriter().println(JSON.toJSONString(SysResult.errorResult(-<span class="number">1</span>, localizedMessage)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将认证失败处理器注册进SpringSecurity配置中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 获取登录失败信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localizedMessage</span> <span class="operator">=</span> exception.getLocalizedMessage();</span><br><span class="line">        <span class="comment">// 设置响应头信息</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 将失败信息返回给前台页面</span></span><br><span class="line">        response.getWriter().println(JSON.toJSONString(SysResult.errorResult(-<span class="number">1</span>, localizedMessage)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注销处理"><a class="markdownIt-Anchor" href="#注销处理"></a> 注销处理</h2>
<p>类似登陆成功是登录失败处理流程</p>
<p>先创建注销处理器</p>
<p>MyLogoutSuccessHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(JSON.toJSONString(SysResult.okResult(<span class="number">200</span>, <span class="string">&quot;注销成功&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册进Security配置文件中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.logout(logout -&gt; &#123;</span><br><span class="line">            logout.logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>()); <span class="comment">// 注册注销成功处理器</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 关闭csrf网络攻击</span></span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="请求未认证的接口"><a class="markdownIt-Anchor" href="#请求未认证的接口"></a> 请求未认证的接口</h2>
<p>当我们访问一个需要认证的的接口的时候，<strong>SpringSecurity会判断是否已经认证成功</strong>，如果认证成功，则可以访问，如果未成功，<strong>SpringSecurity会自动调转到登录页面</strong>，请求用户认证</p>
<p><strong>期望登录不成功的时候不进行页面的跳转，而是返回JSON信息</strong></p>
<p><strong>我们需要实现AuthenticationEntryPoint接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 获取未认证条件信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localizedMessage</span> <span class="operator">=</span> authException.getLocalizedMessage();</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(JSON.toJSONString(SysResult.errorResult(-<span class="number">1</span>, localizedMessage)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>进行配置注册</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">webSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         <span class="comment">// 为认证处理结果</span></span><br><span class="line">        http.exceptionHandling(exception -&gt; &#123;</span><br><span class="line">            exception.authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">MyAuthenticationEntryPoint</span>());  <span class="comment">// 注册未认证结果处理器</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="跨越问题"><a class="markdownIt-Anchor" href="#跨越问题"></a> 跨越问题</h2>
<p>跨域：在网络请求中，前台请求后台，<strong>默认需要在同一台服务器上</strong>，<strong>需要相同的IP和协议</strong>，如果不同的话，则会进行跨域拦截</p>
<p>在前后台分离系统中可能前台系统和后台系统部署在不同的服务器中，这时候前台系统的IP地址和后台服务的IP地址就不相同，这时候我们需要进行跨域解决</p>
<p>跨域全称是跨域资源共享(Cross-Origin Resources Sharing,CORS)，它是浏览器的保护机制，只允许网页请求统一域名下的服务，同一域名指=&gt;协议、域名、端口号都要保持一致，如果有一项不同，那么就是跨域请求。在前后端分离的项目中，需要解决跨域的问题。</p>
<p>在SpringSecurity中解决跨域很简单，在配置文件中添加如下配置即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跨域</span></span><br><span class="line">http.cors(withDefaults());</span><br></pre></td></tr></table></figure>
<h1 id="第四章-身份认证"><a class="markdownIt-Anchor" href="#第四章-身份认证"></a> 第四章 身份认证</h1>
<h2 id="用户认证信息"><a class="markdownIt-Anchor" href="#用户认证信息"></a> 用户认证信息</h2>
<h3 id="基本概念"><a class="markdownIt-Anchor" href="#基本概念"></a> 基本概念</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/securitycontextholder.png" alt="securitycontextholder" /></p>
<p>在SpringSecurity中与身份认证有关的是Authentication===》可以直接获取到用户信息，SecurityContext和SecurityContextHolder</p>
<p>他们之间的关系是：</p>
<ol>
<li>SecurityContextHolder：是SpringSecurity<strong>存储用户详细信息的地方</strong></li>
<li>SecurityContext：是从SecurityContextHolder中获取的内容，包含当前<strong>已认证的用户的Authentication信息</strong></li>
<li>Authentication：<strong>表示用户的身份认证信息</strong>，包含了Principal，Credentials和Authorities对象</li>
<li>Principal：表示用户的身份标识，通常是一个<strong>表示用户的实体对象</strong>，例如用户名，Principal可以通过Authentication的getPrincipal方法获取</li>
<li>Credentials：表示用户的凭证信息，例如密码、证书或其他认证凭据。Credential可以通过Authentication对象的getCredentials()方法获取。</li>
<li>Authorities：表示用户被授予的权限</li>
</ol>
<p>总结起来，<strong>SecurityContextHolder用于管理当前线程的安全上下文</strong>，存储已认证用户的详细信息，其中包含了SecurityContext对象，该对象包含了Authentication对象，后者表示用户的身份验证信息，包括Principal（用户的身份标识）和Credential（用户的凭证信息）。</p>
<h3 id="获取用户详细信息"><a class="markdownIt-Anchor" href="#获取用户详细信息"></a> 获取用户详细信息</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SysResult&lt;HashMap&lt;String, Object&gt;&gt; <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 通过SecurityContextHolder对象来获取Security用户上下文</span></span><br><span class="line">        <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">        <span class="comment">// 通过用户上下文来获取认证对象</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> context.getAuthentication();</span><br><span class="line">        <span class="comment">// 获取用户身份对象</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal();</span><br><span class="line">        <span class="comment">// 获取用户权限</span></span><br><span class="line">        Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line">        <span class="comment">// 获取用登录凭证</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">credentials</span> <span class="operator">=</span> authentication.getCredentials();</span><br><span class="line">        <span class="comment">// 获取登录用户名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">        <span class="comment">// 设置相应信息</span></span><br><span class="line">        HashMap&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;username&quot;</span>, name);</span><br><span class="line">        result.put(<span class="string">&quot;authorities&quot;</span>, authorities);</span><br><span class="line">        result.put(<span class="string">&quot;principal&quot;</span>, principal);</span><br><span class="line">        <span class="keyword">return</span> SysResult.okResult(result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="会话并发处理"><a class="markdownIt-Anchor" href="#会话并发处理"></a> 会话并发处理</h2>
<p>选择同一个账号可以在几个设备进行登录，如果超出规定设备数量的时候，需要将前面的设备的Session会话注销</p>
<p><strong>Security通过SessionInformationExpiredStrategy接口来实现该功能</strong></p>
<h3 id="实现处理器接口"><a class="markdownIt-Anchor" href="#实现处理器接口"></a> 实现处理器接口</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySessionInformationExpireStrategy</span> <span class="keyword">implements</span> <span class="title class_">SessionInformationExpiredStrategy</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当Session超时被强制退出的时候需要调用该方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent event)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 获取响应头，向响应头中添加返回信息</span></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">        <span class="comment">// 设置响应格式JSON格式</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().println(JSON.toJSONString(SysResult.errorResult(-<span class="number">1</span>, <span class="string">&quot;该账号已从其他设备登录&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置接口"><a class="markdownIt-Anchor" href="#配置接口"></a> 配置接口</h3>
<p>在WebSecurityConfig中配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 用户会话相关配置</span></span><br><span class="line">        http.sessionManagement(session -&gt; &#123;</span><br><span class="line">            <span class="comment">// 设置最大登录数量</span></span><br><span class="line">            session.maximumSessions(<span class="number">1</span>)</span><br><span class="line">                    <span class="comment">// 注册Session被强制退出之后才处理器</span></span><br><span class="line">                    .expiredSessionStrategy(<span class="keyword">new</span> <span class="title class_">MySessionInformationExpireStrategy</span>());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="第五章-授权"><a class="markdownIt-Anchor" href="#第五章-授权"></a> 第五章 授权</h1>
<p>SpringSecurity有两种授权形式：</p>
<ul>
<li>用户-权限-资源：将权限分配至用户上，用户权限的用户，才能访问指定的接口和指定的前台菜单或按钮</li>
<li>用户-角色-权限-资源：将权限分配到角色上，拥有该角色的用户都可以使用该角色的权限，更加灵活</li>
</ul>
<h2 id="基于request的授权"><a class="markdownIt-Anchor" href="#基于request的授权"></a> 基于Request的授权</h2>
<h3 id="用户-权限-资源"><a class="markdownIt-Anchor" href="#用户-权限-资源"></a> 用户-权限-资源</h3>
<p><strong>需求：</strong></p>
<ul>
<li>拥有USER_LIST权限的用户可以访问/user/list的接口</li>
<li>拥有USER_ADD权限的用户可以访问/user/add的接口</li>
</ul>
<p><strong>配置</strong>：在配置项中配置指定资源需要的权限信息</p>
<p>/user/list接口信息只有拥有USER_LIST权限的用户才能访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="comment">// 开SpringSecurity的自定义配置 在SpringBoot项目中可以省略， SpringBoot项目会在引入SpringSecurity的时候加载该注解</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 开启授权保护</span></span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                authorize -&gt; authorize</span><br><span class="line">                                     <span class="comment">// 配置权限，只有拥有后面权限的用户才嫩访问对应的接口</span></span><br><span class="line">                                     .requestMatchers(<span class="string">&quot;/user/list&quot;</span>).hasAuthority(<span class="string">&quot;USER_LIST&quot;</span>)</span><br><span class="line">                                     .requestMatchers(<span class="string">&quot;/user/add&quot;</span>).hasAuthority(<span class="string">&quot;USER_ADD&quot;</span>)</span><br><span class="line">                                     <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">                                     .anyRequest()</span><br><span class="line">                                     <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">                                     .authenticated()</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> http.bulid();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置用户信息</p>
<p>在DBUserDetailsManager的loadUserByUsername方法中来获取用户信息，并设置用户权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;().eq(User::getUsername, username));</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过查看InMemoryUserDetailsManager中的loadUserByUsername方法，当查不到该用户的时候throw出UsernameNotFoundException错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(username);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 手动设置用户权限</span></span><br><span class="line">        authorities.add(() -&gt; <span class="string">&quot;USER_LIST&quot;</span>);</span><br><span class="line">        authorities.add(() -&gt; <span class="string">&quot;USER_ADD&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User(</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getPassword(),</span><br><span class="line">            user.getEnabled(),</span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断账号是否过期</span></span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断用户平</span></span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断用户是否为被锁定</span></span><br><span class="line">            authorities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在配置好用户信息之后，<strong>如果拥有指定权限访问指定接口的时候可以访问通过</strong>，<strong>如果没有指定权限访问指定接口的时候会返回403无权限</strong></p>
<h3 id="用户-角色-资源"><a class="markdownIt-Anchor" href="#用户-角色-资源"></a> 用户-角色-资源</h3>
<p>需求：角色为ADMIN的用户才可以访问/user/**路径下的资源</p>
<p>和<strong>用户-角色-权限-资源</strong>设置方法类似，也是需要在过滤器中配置，只是把hasAuthority，改成hasRole即可</p>
<p><strong>过滤器配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 开启授权保护</span></span><br><span class="line">    http.authorizeHttpRequests(</span><br><span class="line">        authorize -&gt; authorize</span><br><span class="line">        <span class="comment">// 配置权限，只有拥有后面权限的用户才嫩访问对应的接口</span></span><br><span class="line">        <span class="comment">//.requestMatchers(&quot;/user/list&quot;).hasAuthority(&quot;USER_LIST&quot;)</span></span><br><span class="line">        <span class="comment">//.requestMatchers(&quot;/user/add&quot;).hasAuthority(&quot;USER_ADD&quot;)</span></span><br><span class="line">        .requestMatchers(<span class="string">&quot;user/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        <span class="comment">// 对所有请求开启授权保护</span></span><br><span class="line">        .anyRequest()</span><br><span class="line">        <span class="comment">// 已认证的请求会被自动授权</span></span><br><span class="line">        .authenticated()</span><br></pre></td></tr></table></figure>
<p>在loadUserByUsername类中配置获取角色信息，带上角色权限</p>
<p>可以在数据库中配置角色信息，这里就使用硬编码直接给用户附上角色</p>
<p><strong>之前的loadUserByUsername是通过new org.springframework.security.core.userdetails.User新建一个用户</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;().eq(User::getUsername, username));</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过查看InMemoryUserDetailsManager中的loadUserByUsername方法，当查不到该用户的时候throw出UsernameNotFoundException错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(username);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        authorities.add(() -&gt; <span class="string">&quot;USER_LIST&quot;</span>);</span><br><span class="line">        authorities.add(() -&gt; <span class="string">&quot;USER_ADD&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User(</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getPassword(),</span><br><span class="line">            user.getEnabled(),</span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断账号是否过期</span></span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断用户平</span></span><br><span class="line">            <span class="literal">true</span>, <span class="comment">// 判断用户是否为被锁定</span></span><br><span class="line">            authorities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面该方法无法直接个用户角色赋值</p>
<p>使用org.springframework.security.core.userdetails.User.withUsername()方法来创建用户，可以附带角色信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;().eq(User::getUsername, username));</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过查看InMemoryUserDetailsManager中的loadUserByUsername方法，当查不到该用户的时候throw出UsernameNotFoundException错误</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(username);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//            Collection&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();</span></span><br><span class="line">        <span class="comment">//            authorities.add(() -&gt; &quot;USER_LIST&quot;);</span></span><br><span class="line">        <span class="comment">//            authorities.add(() -&gt; &quot;USER_ADD&quot;);</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//            return new org.springframework.security.core.userdetails.User(</span></span><br><span class="line">        <span class="comment">//                    user.getUsername(),</span></span><br><span class="line">        <span class="comment">//                    user.getPassword(),</span></span><br><span class="line">        <span class="comment">//                    user.getEnabled(),</span></span><br><span class="line">        <span class="comment">//                    true, // 判断账号是否没有过期</span></span><br><span class="line">        <span class="comment">//                    true, // 判断用户平</span></span><br><span class="line">        <span class="comment">//                    true, // 判断用户是否为被锁定</span></span><br><span class="line">        <span class="comment">//                    authorities);</span></span><br><span class="line">        <span class="keyword">return</span> org.springframework.security.core.userdetails.User</span><br><span class="line">            .withUsername(user.getUsername()) <span class="comment">// 用户名</span></span><br><span class="line">            .password(user.getPassword()) <span class="comment">// 用户密码</span></span><br><span class="line">            .disabled(!user.getEnabled()) <span class="comment">// 用户是否禁用</span></span><br><span class="line">            .credentialsExpired(<span class="literal">false</span>) <span class="comment">// 用户是否过期</span></span><br><span class="line">            .accountLocked(<span class="literal">false</span>)  <span class="comment">// 账号是否锁定</span></span><br><span class="line">            .roles(List.of(<span class="string">&quot;ADMIN&quot;</span>).toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]))</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>用户角色权限：本质也是将角色信息放到Authorities（权限）中，是将角色信息在前面添加一个ROLE标志，例如上面的ADMIN角色，放到Authorities中是ROLE_ADMIN</p>
<h3 id="用户-角色-权限-资源"><a class="markdownIt-Anchor" href="#用户-角色-权限-资源"></a> 用户-角色-权限-资源</h3>
<p>RBAC(Role_Based_Assess_Control，基于角色的访问控制)是一种常用的数据库设计方案，它将用户的权限分配和管理与角色相关联。</p>
<p>以下是一个基本的RBAC数据库设计方案的示例:</p>
<ol>
<li>用户表（User table）：包含用户的基本信息，例如用户名、密码和其他身份验证信息。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户ID</td>
</tr>
<tr>
<td>username</td>
<td>varchar</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>varchar</td>
<td>密码</td>
</tr>
<tr>
<td>email</td>
<td>varchar</td>
<td>电子邮件地址</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>角色表（Role table）：存储所有可能的角色及其描述。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>role_name</td>
<td>varchar</td>
<td>角色名称</td>
</tr>
<tr>
<td>description</td>
<td>varchar</td>
<td>角色描述</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>权限表（Permission table）：定义系统中所有可能的权限。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>permission_id</td>
<td>int</td>
<td>权限ID</td>
</tr>
<tr>
<td>permission_name</td>
<td>varchar</td>
<td>权限名称</td>
</tr>
<tr>
<td>description</td>
<td>varchar</td>
<td>权限描述</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<ol start="4">
<li>用户角色关联表（User-Role table）：将用户与角色关联起来。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_role_id</td>
<td>int</td>
<td>用户角色关联ID</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<ol start="5">
<li>角色权限关联表（Role-Permission table）：将角色与权限关联起来。</li>
</ol>
<table>
<thead>
<tr>
<th>列名</th>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>role_permission_id</td>
<td>int</td>
<td>角色权限关联ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>角色ID</td>
</tr>
<tr>
<td>permission_id</td>
<td>int</td>
<td>权限ID</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>在这个设计方案中，用户可以被分配一个或多个角色，而每个角色又可以具有一个或多个权限。通过对用户角色关联和角色权限关联表进行操作，可以实现灵活的权限管理和访问控制。</p>
<p>当用户尝试访问系统资源时，系统可以根据用户的角色和权限决定是否允许访问。这样的设计方案使得权限管理更加简单和可维护，<strong>因为只需调整角色和权限的分配即可</strong>，而<strong>不需要针对每个用户进行单独的设置</strong>。</p>
<h2 id="基于方法的授权"><a class="markdownIt-Anchor" href="#基于方法的授权"></a> 基于方法的授权</h2>
<p>上述基于Request的授权，是通过request连接器实现的。</p>
<p>基于方法的授权是通过在方法上<strong>设置权授权注解实现的</strong></p>
<h3 id="开启其方法授权"><a class="markdownIt-Anchor" href="#开启其方法授权"></a> 开启其方法授权</h3>
<p>在SpringSecurity配置文件中添加上@EnableMethodSecurity注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableMethodSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="给用户授予角色和权限"><a class="markdownIt-Anchor" href="#给用户授予角色和权限"></a> 给用户授予角色和权限</h3>
<p>DBUserDetailsManager中的loadUserByUsername方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> org.springframework.security.core.userdetails.User</span><br><span class="line">        .withUsername(user.getUsername())</span><br><span class="line">        .password(user.getPassword())</span><br><span class="line">        .roles(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">        .authorities(<span class="string">&quot;USER_ADD&quot;</span>, <span class="string">&quot;USER_UPDATE&quot;</span>)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>
<h3 id="常用授权注解"><a class="markdownIt-Anchor" href="#常用授权注解"></a> 常用授权注解</h3>
<p>使用@PreAuthorize注解来进行权限校验，使用hasRole 和hasAuthority来进行权限认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUserList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;USER_SAVE&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUserDetail</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        userService.saveUserDetail(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>list方法需要拥有角色ADMIN才能访问，下面save需要拥有权限USER_SAVE才能访问</p>
<p>也可以写复杂的权限表达式来进行判断，下面就是同时<strong>需要拥有ADMIN角色的用户和用户名是admin的用户才能访问list接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) and authentication.name == &#x27;admin&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUserList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="第六章-oauth2"><a class="markdownIt-Anchor" href="#第六章-oauth2"></a> 第六章 OAuth2</h1>
<h2 id="oauth2简介"><a class="markdownIt-Anchor" href="#oauth2简介"></a> OAuth2简介</h2>
<h3 id="是什么"><a class="markdownIt-Anchor" href="#是什么"></a> 是什么</h3>
<p>“Auth” 表示 “授权” Authorization</p>
<p>“O” 是 Open 的简称，表示 “开放”</p>
<p>连在一起就表示 <strong>“开放授权”</strong>，OAuth2是一种开放授权协议。</p>
<p><strong>首先</strong>需要有一个资源服务器来<strong>存放管理用户资源</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20241105170931050.png" alt="image-20241105170931050" /></p>
<p><strong>其次</strong>需要有一个客户应用来访问资源服务器，通过资源服务器来获取指定资源信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/VarEO5YPR9tHJue.png" alt="image-20241105171847690" /></p>
<p>如果有恶意程序来访问资源服务器时候，如果资源服务器不加以检查则会导致用户数据泄露</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20241105172001488.png" alt="image-20241105172001488" /></p>
<p>这时候需要<strong>给客户端应用颁发一个AssetsToken来进行用户认证</strong>，<strong>拥有AssetsToken的应用才能访问用户数据</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/mR8sYFML2wIH59N.png" alt="image-20241105172246054" /></p>
<p><strong>谁给客户端颁发AssetsToken呢？</strong> === <strong>授权服务器</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20241105172603906.png" alt="image-20241105172603906" /></p>
<p>授权服务器何时给用户颁发AssetsToken呢？</p>
<p><strong>在客户端想要访问资源服务器的时候，发现需要AssetsToken，进而去授权服务器上要求授权服务器给自己颁发AssetsToken，授权服务器去征求该用户的同意，如果用户同意，则进行颁发AssetsToken，客户端就可以通过AssetsToken去资源服务器上访问该用户的资源了</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/yr52IMRwaGOgz7Q.png" alt="image-20241105172912163" /></p>
<h3 id="角色"><a class="markdownIt-Anchor" href="#角色"></a> 角色</h3>
<p>OAuth 2协议包含以下角色：</p>
<ol>
<li>资源所有者（Resource Owner）：即用户，资源的拥有人，想要通过客户应用访问资源服务器上的资源。</li>
<li>客户应用（Client）：通常是一个Web或者无线应用，它需要访问用户的受保护资源。</li>
<li>资源服务器（Resource Server）：存储受保护资源的服务器或定义了可以访问到资源的API，接收并验证客户端的访问令牌，以决定是否授权访问资源。</li>
<li>授权服务器（Authorization Server）：负责验证资源所有者的身份并向客户端颁发访问令牌。</li>
</ol>
<p><strong>代理授权</strong>：资源所有者本身就拥有访问资源服务器上自己的资源信息，但是现在想要<strong>通过客户应用来代理用户</strong>去访问资源服务器上对应用户的信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/1w9zjDgtiNdoLVp.png" alt="image-20241105173726776" /></p>
<h3 id="使用场景"><a class="markdownIt-Anchor" href="#使用场景"></a> 使用场景</h3>
<h4 id="开放系统间授权"><a class="markdownIt-Anchor" href="#开放系统间授权"></a> 开放系统间授权</h4>
<h5 id="社交登录"><a class="markdownIt-Anchor" href="#社交登录"></a> 社交登录</h5>
<p>在传统的身份验证中，用户需要提供用户名和密码，还有很多网站登录时，允许使用第三方网站的身份，这称为&quot;第三方登录&quot;。所谓第三方登录，实质就是 OAuth 授权。用户想要登录 A 网站，A 网站让用户提供第三方网站的数据，证明自己的身份。获取第三方网站的身份数据，就需要 OAuth 授权。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/dloDzqupvWmX71a.png" alt="image-20231222131233025" /></p>
<h5 id="开放api"><a class="markdownIt-Anchor" href="#开放api"></a> 开放API</h5>
<p>例如云冲印服务的实现</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/Bu5rf9etmPxMhyn.png" alt="image-20231222131118611" /></p>
<h4 id="现代微服务安全"><a class="markdownIt-Anchor" href="#现代微服务安全"></a> 现代微服务安全</h4>
<h5 id="单块应用安全"><a class="markdownIt-Anchor" href="#单块应用安全"></a> 单块应用安全</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/wGM7EgDae9NJHYu.png" alt="image-20231222152734546" /></p>
<h5 id="微服务安全"><a class="markdownIt-Anchor" href="#微服务安全"></a> 微服务安全</h5>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/saMlgNuVUrCcbyG.png" alt="image-20231222152557861" /></p>
<h4 id="企业内部应用认证授权"><a class="markdownIt-Anchor" href="#企业内部应用认证授权"></a> 企业内部应用认证授权</h4>
<ul>
<li>
<p>SSO：Single Sign On 单点登录</p>
</li>
<li>
<p>IAM：Identity and Access Management 身份识别与访问管理</p>
</li>
</ul>
<h3 id="oauth2四种授权方式"><a class="markdownIt-Anchor" href="#oauth2四种授权方式"></a> OAuth2四种授权方式</h3>
<p>RFC6749：</p>
<p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6749">RFC 6749 - The OAuth 2.0 Authorization Framework (ietf.org)</a></p>
<p>阮一峰：</p>
<p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html">OAuth 2.0 的四种方式 - 阮一峰的网络日志 (ruanyifeng.com)</a></p>
<p><strong>四种模式：</strong></p>
<ul>
<li>授权码（authorization-code）</li>
<li>隐藏式（implicit）</li>
<li>密码式（password）</li>
<li>客户端凭证（client credentials）</li>
</ul>
<h4 id="第一种方式授权码"><a class="markdownIt-Anchor" href="#第一种方式授权码"></a> 第一种方式：授权码</h4>
<p><strong>授权码（authorization code），指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</strong></p>
<p>这种方式是最常用，最复杂，也是最安全的，它适用于那些有后端的 Web 应用。授权码通过前端传送，令牌则是储存在后端，<strong>而且所有与资源服务器的通信都在后端完成。这样的前后端分离，可以避免令牌泄漏</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231220180422742.png" alt="image-20231220180422742" /></p>
<ul>
<li><strong>注册客户应用</strong>：客户应用如果想要访问资源服务器需要有凭证，需要在授权服务器上注册客户应用。注册后会<strong>获取到一个ClientID和ClientSecrets</strong></li>
</ul>
<p>例如下图，ResourceOwner资源拥有者，想通过前台页面UserAgent去访问Client服务端内容，<strong>类似我们在登陆Gitee的时候想要访问我们自己的仓库需要先登录</strong>，我们通过Github身份认证来登录Gitee，</p>
<p>首先需要Gitee<strong>携带ClientIdentifier和Redirection</strong>跳转到Github的授权页面，如果没有登录则需要先登录。</p>
<p>UserAuthenticates是GIthub用户认证的操作例如输入密码之类的操作</p>
<p><strong>Github进行用户认证之后返回Authorization(授权码)给Gitee</strong>，Gitee后台获取到Authorization之后，通过携带Authorization和RedirectUrl去访问Github服务端去请求AssetsToken，Github进行Authorization校验之后返回AssetsToken给Gitee，Gitee认证登陆成功，这时候<strong>Gitee就可以访问Github的一些受保护资源</strong>，例如用户的昵称基本信息之类的东西</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231222203153125.png" alt="image-20231222203153125" /></p>
<h4 id="第二种方式隐藏式"><a class="markdownIt-Anchor" href="#第二种方式隐藏式"></a> 第二种方式：隐藏式</h4>
<p><strong>隐藏式（implicit），也叫简化模式，有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。</strong></p>
<p>RFC 6749 规定了这种方式，<strong>允许直接向前端颁发令牌</strong>。这种方式没有授权码这个中间步骤，所以称为隐藏式。这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p>
<p>​								<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231220185958063.png" alt="image-20231220185958063" /></p>
<p>资源拥有者通过前台页面方位授权服务器，授权服务器直接返回携带AssetsToken的URL网址，<strong>但是返回的URL地址Client无法直接解析</strong>，前台页面通过访问一个专门的解析网址发服务资源服务端，解析出AssetsToken之后，前台页面通过AssetsToken访问Client端</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231222203218334.png" alt="image-20231222203218334" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://a.com/callback#token=ACCESS_TOKEN</span><br><span class="line">将访问令牌包含在URL锚点中的好处：锚点在HTTP请求中不会发送到服务器，减少了泄漏令牌的风险。</span><br></pre></td></tr></table></figure>
<h4 id="第三种方式密码式"><a class="markdownIt-Anchor" href="#第三种方式密码式"></a> 第三种方式：密码式</h4>
<p><strong>密码式（Resource Owner Password Credentials）：如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌。</strong></p>
<p><strong>就是像，如果我想通过GITHUB登录GITEE，我不能直接在GITEE这里输入我GITHUB的账号密码，这样就会将资源服务器的账号密码暴漏给客户应用非常不安全。客户端应用可能会通过此账号密码来对资源进行删除操作，风险极大</strong></p>
<p>这种方式需要用户给出自己的用户名/密码，显然风险很大，因此只适用于其他授权方式都无法采用的情况，而且必须是用户高度信任的应用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231220190152888.png" alt="image-20231220190152888" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231222203240921.png" alt="image-20231222203240921" /></p>
<h4 id="第四种方式凭证式"><a class="markdownIt-Anchor" href="#第四种方式凭证式"></a> 第四种方式：凭证式</h4>
<p><strong>凭证式（client credentials）：也叫客户端模式，适用于没有前端的命令行应用，即在命令行下请求令牌。</strong></p>
<p>这种方式给出的令牌，是针对第三方应用的，而不是针对用户的，即有可能多个用户共享同一个令牌。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231220185958063.png" alt="image-20231220185958063" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231222203259785.png" alt="image-20231222203259785" /></p>
<h3 id="授权类型的选择"><a class="markdownIt-Anchor" href="#授权类型的选择"></a> 授权类型的选择</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231223020052999.png" alt="image-20231223020052999" /></p>
<h2 id="spring实现oauth2"><a class="markdownIt-Anchor" href="#spring实现oauth2"></a> Spring实现OAuth2</h2>
<h3 id="spring实现"><a class="markdownIt-Anchor" href="#spring实现"></a> Spring实现</h3>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html">OAuth2 :: Spring Security</a></p>
<p><strong>Spring Security可以实现的</strong></p>
<ul>
<li>客户应用（OAuth2 Client）：OAuth2客户端功能中包含OAuth2 Login</li>
<li>资源服务器（OAuth2 Resource Server）</li>
</ul>
<p><strong>需要独立实现的</strong></p>
<ul>
<li>授权服务器（Spring Authorization Server）：它是在Spring Security之上的一个单独的项目。</li>
</ul>
<h3 id="依赖"><a class="markdownIt-Anchor" href="#依赖"></a> 依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 资源服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 客户应用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 授权服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-authorization-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="授权登录的实现思路"><a class="markdownIt-Anchor" href="#授权登录的实现思路"></a> 授权登录的实现思路</h3>
<p>使用OAuth2 Login，只需要实现客户应用，对应的资源服务器和授权服务器都由别人设计好</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/11/05/uSxbeJEZGvjqDlP.png" alt="image-20231223164128030" /></p>
<h2 id="github登录案例"><a class="markdownIt-Anchor" href="#github登录案例"></a> Github登录案例</h2>
<h3 id="创建应用"><a class="markdownIt-Anchor" href="#创建应用"></a> 创建应用</h3>
<p><strong>注册客户应用：</strong></p>
<p>登录GitHub，在开发者设置中找到OAuth Apps，创建一个application，为客户应用创建访问GitHub的凭据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20230510154255157.png" alt="image-20230510154255157" /></p>
<p>填写应用信息：<code>默认的重定向URI模板为&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;</code>。registrationId是ClientRegistration的唯一标识符。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231221000906168.png" alt="image-20231221000906168" /></p>
<p>获取应用程序id，生成应用程序密钥：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20230510163101376.png" alt="image-20230510163101376" /></p>
<h3 id="创建测试项目"><a class="markdownIt-Anchor" href="#创建测试项目"></a> 创建测试项目</h3>
<p>创建一个springboot项目oauth2-login-demo，创建时引入如下依赖</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20230510165314829.png" alt="image-20230510165314829" /></p>
<p>示例代码参考：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security-samples/tree/6.2.x/servlet/spring-boot/java/oauth2/login">spring-security-samples/servlet/spring-boot/java/oauth2/login at 6.2.x · spring-projects/spring-security-samples (github.com)</a></p>
<h3 id="配置oauth客户端属性"><a class="markdownIt-Anchor" href="#配置oauth客户端属性"></a> 配置OAuth客户端属性</h3>
<p>application.yml：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">security</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">oauth2</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">client</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">registration</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">github</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">client-id</span>: <span class="string">7807cc3bb1534abce9f2</span></span><br><span class="line">            <span class="attr">client-secret</span>: <span class="string">008dc141879134433f4db7f62b693c4a5361771b</span></span><br><span class="line"><span class="comment">#            redirectUri: http://localhost:8200/login/oauth2/code/github</span></span><br></pre></td></tr></table></figure>
<h3 id="创建controller-2"><a class="markdownIt-Anchor" href="#创建controller-2"></a> 创建Controller</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.oauthdemo.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(</span></span><br><span class="line"><span class="params">            Model model,</span></span><br><span class="line"><span class="params">            <span class="meta">@RegisteredOAuth2AuthorizedClient</span> OAuth2AuthorizedClient authorizedClient,</span></span><br><span class="line"><span class="params">            <span class="meta">@AuthenticationPrincipal</span> OAuth2User oauth2User)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;userName&quot;</span>, oauth2User.getName());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;clientName&quot;</span>, authorizedClient.getClientRegistration().getClientName());</span><br><span class="line">        model.addAttribute(<span class="string">&quot;userAttributes&quot;</span>, oauth2User.getAttributes());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建html页面"><a class="markdownIt-Anchor" href="#创建html页面"></a> 创建html页面</h3>
<p>resources/templates/index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span> <span class="attr">xmlns:sec</span>=<span class="string">&quot;https://www.thymeleaf.org/thymeleaf-extras-springsecurity5&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring Security - OAuth 2.0 Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float: right&quot;</span> <span class="attr">th:fragment</span>=<span class="string">&quot;logout&quot;</span> <span class="attr">sec:authorize</span>=<span class="string">&quot;isAuthenticated()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:left&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span>&gt;</span>User: <span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:none&quot;</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:right&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/logout&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Logout&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>OAuth 2.0 Login with Spring Security<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    You are successfully logged in <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    via the OAuth 2.0 Client <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;clientName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span>&gt;</span>User Attributes:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;userAttribute : $&#123;userAttributes&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-weight:bold&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userAttribute.key&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;userAttribute.value&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="启动应用程序"><a class="markdownIt-Anchor" href="#启动应用程序"></a> 启动应用程序</h3>
<ul>
<li>启动程序并访问localhost:8080。浏览器将被重定向到默认的自动生成的登录页面，该页面显示了一个用于GitHub登录的链接。</li>
<li>点击GitHub链接，浏览器将被重定向到GitHub进行身份验证。</li>
<li>使用GitHub账户凭据进行身份验证后，用户会看到授权页面，询问用户是否允许或拒绝客户应用访问GitHub上的用户数据。点击允许以授权OAuth客户端访问用户的基本个人资料信息。</li>
<li>此时，OAuth客户端访问GitHub的获取用户信息的接口获取基本个人资料信息，并建立一个已认证的会话。</li>
</ul>
<h2 id="案例分析"><a class="markdownIt-Anchor" href="#案例分析"></a> 案例分析</h2>
<h3 id="登录流程"><a class="markdownIt-Anchor" href="#登录流程"></a> 登录流程</h3>
<ol>
<li><strong>A 网站让用户跳转到 GitHub，并携带参数ClientID 以及 Redirection URI。</strong></li>
<li>GitHub 要求用户登录，然后询问用户&quot;A 网站要求获取用户信息的权限，你是否同意？&quot;</li>
<li>用户同意，GitHub 就会重定向回 A 网站，同时发回一个授权码。</li>
<li><strong>A 网站使用授权码，向 GitHub 请求令牌。</strong></li>
<li>GitHub 返回令牌.</li>
<li><strong>A 网站使用令牌，向 GitHub 请求用户数据。</strong></li>
<li>GitHub返回用户数据</li>
<li><strong>A 网站使用 GitHub用户数据登录</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringSecurity%E5%A4%8D%E4%B9%A0/image-20231223203225688.png" alt="image-20231223203225688" /></p>
<h3 id="commonoauth2provider"><a class="markdownIt-Anchor" href="#commonoauth2provider"></a> CommonOAuth2Provider</h3>
<p>CommonOAuth2Provider是一个预定义的通用OAuth2Provider，为一些知名资源服务API提供商（如Google、GitHub、Facebook）预定义了一组默认的属性。</p>
<p>例如，<strong>授权URI、令牌URI和用户信息URI</strong>通常不经常变化。因此，提供默认值以减少所需的配置。</p>
<p>因此，当我们配置GitHub客户端时，只需要提供client-id和client-secret属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GITHUB &#123;</span><br><span class="line">    <span class="keyword">public</span> ClientRegistration.Builder <span class="title function_">getBuilder</span><span class="params">(String registrationId)</span> &#123;</span><br><span class="line">        ClientRegistration.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="built_in">this</span>.getBuilder(</span><br><span class="line">        registrationId, </span><br><span class="line">        ClientAuthenticationMethod.CLIENT_SECRET_BASIC, </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//授权回调地址(GitHub向客户应用发送回调请求，并携带授权码)   </span></span><br><span class="line">		<span class="string">&quot;&#123;baseUrl&#125;/&#123;action&#125;/oauth2/code/&#123;registrationId&#125;&quot;</span>);</span><br><span class="line">        builder.scope(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;read:user&quot;</span>&#125;);</span><br><span class="line">        <span class="comment">//授权页面</span></span><br><span class="line">        builder.authorizationUri(<span class="string">&quot;https://github.com/login/oauth/authorize&quot;</span>);</span><br><span class="line">        <span class="comment">//客户应用使用授权码，向 GitHub 请求令牌</span></span><br><span class="line">        builder.tokenUri(<span class="string">&quot;https://github.com/login/oauth/access_token&quot;</span>);</span><br><span class="line">        <span class="comment">//客户应用使用令牌向GitHub请求用户数据</span></span><br><span class="line">        builder.userInfoUri(<span class="string">&quot;https://api.github.com/user&quot;</span>);</span><br><span class="line">        <span class="comment">//username属性显示GitHub中获取的哪个属性的信息</span></span><br><span class="line">        builder.userNameAttributeName(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="comment">//登录页面超链接的文本</span></span><br><span class="line">        builder.clientName(<span class="string">&quot;GitHub&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Nuyoah</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/')">SpringSecurity</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringSecurity&amp;url=http://262259.xyz/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/&amp;pic=https://s2.loli.net/2022/11/10/1dfka8LsM9ZKpVc.jpg?_r_=46ac48e8-86c9-d59d-624d-fef0a432f8c9" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://262259.xyz" target="_blank">Nuyoah</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/11/11/PRhut51DVxg9XBc.jpg?_r_=02db7499-72ba-2304-866d-b5c2b561abcc" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/835073650610b2a5.png?_r_=453d950a-ce62-6573-6287-b57caf3e0e31" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot响应式编程</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/27/%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/3b73e41bdfc1757c.png?_r_=72c3578e-ffe7-8573-6764-dc218b3f49ff" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">文件的上传和下载</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display: none">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Nuyoah</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/zjhinsist" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2152889763@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0springsecurity%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text"> 第一章：SpringSecurity入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.</span> <span class="toc-text"> 功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text"> 案例-身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom%E6%96%87%E4%BB%B6%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.1.</span> <span class="toc-text"> pom文件依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%A1%80%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 创建基础启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcontroller%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 创建Controller对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%89%8D%E5%8F%B0%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 创建前台页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springsecurity%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%85%A2"><span class="toc-number">1.2.5.</span> <span class="toc-text"> SpringSecurity页面加载慢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#springsecurity%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.6.</span> <span class="toc-text"> SpringSecurity做了什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springsecurity%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text"> SpringSecurity底层原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="toc-number">1.4.</span> <span class="toc-text"> 程序启动和运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#defaultsecurityfilterchain"><span class="toc-number">1.4.1.</span> <span class="toc-text"> DefaultSecurityFilterChain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#securityproperties"><span class="toc-number">1.4.2.</span> <span class="toc-text"> SecurityProperties</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-springsecurity%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text"> 第二章 SpringSecurity自定义配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">2.1.</span> <span class="toc-text"> 基于内存的用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text"> 创建自定义配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.2.</span> <span class="toc-text"> 基于内存的用户认证流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">2.2.</span> <span class="toc-text"> 基于数据库的用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.2.2.</span> <span class="toc-text"> 配置数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text"> 基于数据库的用户认证流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAdbuserdetailsmanager%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.4.</span> <span class="toc-text"> 创建DBUserDetailsManager对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springsecurity%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text"> SpringSecurity的默认配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-number">2.4.</span> <span class="toc-text"> 添加用户功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcontroller"><span class="toc-number">2.4.1.</span> <span class="toc-text"> 创建Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAservice"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 创建Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0dbuserdetailsmanager%E6%96%B9%E6%B3%95"><span class="toc-number">2.4.3.</span> <span class="toc-text"> 实现DBUserDetailsManager方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.5.</span> <span class="toc-text"> 密码加密算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-number">2.5.1.</span> <span class="toc-text"> 密码加密方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passwordencoder"><span class="toc-number">2.5.2.</span> <span class="toc-text"> PasswordEncoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delegatingpasswordencoder"><span class="toc-number">2.5.3.</span> <span class="toc-text"> DelegatingPasswordEncoder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.6.</span> <span class="toc-text"> 自定义登录页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.6.1.</span> <span class="toc-text"> 创建登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">2.6.2.</span> <span class="toc-text"> 更改配置项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">2.6.3.</span> <span class="toc-text"> 注意点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB"><span class="toc-number">3.</span> <span class="toc-text"> 第三章 前后端分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text"> 认证流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5fastjson%E4%BE%9D%E8%B5%96"><span class="toc-number">3.2.</span> <span class="toc-text"> 引入FastJson依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%93%8D%E5%BA%94"><span class="toc-number">3.3.</span> <span class="toc-text"> 认证成功响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E7%9B%B8%E5%BA%94"><span class="toc-number">3.4.</span> <span class="toc-text"> 认证失败相应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E9%94%80%E5%A4%84%E7%90%86"><span class="toc-number">3.5.</span> <span class="toc-text"> 注销处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%9C%AA%E8%AE%A4%E8%AF%81%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.6.</span> <span class="toc-text"> 请求未认证的接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E8%B6%8A%E9%97%AE%E9%A2%98"><span class="toc-number">3.7.</span> <span class="toc-text"> 跨越问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">4.</span> <span class="toc-text"> 第四章 身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.</span> <span class="toc-text"> 用户认证信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.1.</span> <span class="toc-text"> 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.2.</span> <span class="toc-text"> 获取用户详细信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text"> 会话并发处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%A4%84%E7%90%86%E5%99%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.1.</span> <span class="toc-text"> 实现处理器接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.2.</span> <span class="toc-text"> 配置接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%8E%88%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text"> 第五章 授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Erequest%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-number">5.1.</span> <span class="toc-text"> 基于Request的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7-%E6%9D%83%E9%99%90-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.1.</span> <span class="toc-text"> 用户-权限-资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7-%E8%A7%92%E8%89%B2-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.2.</span> <span class="toc-text"> 用户-角色-资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7-%E8%A7%92%E8%89%B2-%E6%9D%83%E9%99%90-%E8%B5%84%E6%BA%90"><span class="toc-number">5.1.3.</span> <span class="toc-text"> 用户-角色-权限-资源</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%96%B9%E6%B3%95%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-number">5.2.</span> <span class="toc-text"> 基于方法的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E5%85%B6%E6%96%B9%E6%B3%95%E6%8E%88%E6%9D%83"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 开启其方法授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E7%94%A8%E6%88%B7%E6%8E%88%E4%BA%88%E8%A7%92%E8%89%B2%E5%92%8C%E6%9D%83%E9%99%90"><span class="toc-number">5.2.2.</span> <span class="toc-text"> 给用户授予角色和权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8E%88%E6%9D%83%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.2.3.</span> <span class="toc-text"> 常用授权注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-oauth2"><span class="toc-number">6.</span> <span class="toc-text"> 第六章 OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#oauth2%E7%AE%80%E4%BB%8B"><span class="toc-number">6.1.</span> <span class="toc-text"> OAuth2简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%92%E8%89%B2"><span class="toc-number">6.1.2.</span> <span class="toc-text"> 角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.1.3.</span> <span class="toc-text"> 使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E7%B3%BB%E7%BB%9F%E9%97%B4%E6%8E%88%E6%9D%83"><span class="toc-number">6.1.3.1.</span> <span class="toc-text"> 开放系统间授权</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95"><span class="toc-number">6.1.3.1.1.</span> <span class="toc-text"> 社交登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%94%BEapi"><span class="toc-number">6.1.3.1.2.</span> <span class="toc-text"> 开放API</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8"><span class="toc-number">6.1.3.2.</span> <span class="toc-text"> 现代微服务安全</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E5%9D%97%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="toc-number">6.1.3.2.1.</span> <span class="toc-text"> 单块应用安全</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8"><span class="toc-number">6.1.3.2.2.</span> <span class="toc-text"> 微服务安全</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%86%85%E9%83%A8%E5%BA%94%E7%94%A8%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83"><span class="toc-number">6.1.3.3.</span> <span class="toc-text"> 企业内部应用认证授权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth2%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.4.</span> <span class="toc-text"> OAuth2四种授权方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%8E%88%E6%9D%83%E7%A0%81"><span class="toc-number">6.1.4.1.</span> <span class="toc-text"> 第一种方式：授权码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%E9%9A%90%E8%97%8F%E5%BC%8F"><span class="toc-number">6.1.4.2.</span> <span class="toc-text"> 第二种方式：隐藏式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%AF%86%E7%A0%81%E5%BC%8F"><span class="toc-number">6.1.4.3.</span> <span class="toc-text"> 第三种方式：密码式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%87%AD%E8%AF%81%E5%BC%8F"><span class="toc-number">6.1.4.4.</span> <span class="toc-text"> 第四种方式：凭证式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">6.1.5.</span> <span class="toc-text"> 授权类型的选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring%E5%AE%9E%E7%8E%B0oauth2"><span class="toc-number">6.2.</span> <span class="toc-text"> Spring实现OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.2.1.</span> <span class="toc-text"> Spring实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">6.2.2.</span> <span class="toc-text"> 依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">6.2.3.</span> <span class="toc-text"> 授权登录的实现思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#github%E7%99%BB%E5%BD%95%E6%A1%88%E4%BE%8B"><span class="toc-number">6.3.</span> <span class="toc-text"> Github登录案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text"> 创建应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.3.2.</span> <span class="toc-text"> 创建测试项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEoauth%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B1%9E%E6%80%A7"><span class="toc-number">6.3.3.</span> <span class="toc-text"> 配置OAuth客户端属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcontroller-2"><span class="toc-number">6.3.4.</span> <span class="toc-text"> 创建Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAhtml%E9%A1%B5%E9%9D%A2"><span class="toc-number">6.3.5.</span> <span class="toc-text"> 创建html页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">6.3.6.</span> <span class="toc-text"> 启动应用程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">6.4.</span> <span class="toc-text"> 案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-number">6.4.1.</span> <span class="toc-text"> 登录流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commonoauth2provider"><span class="toc-number">6.4.2.</span> <span class="toc-text"> CommonOAuth2Provider</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/12/30/LocalDate%E4%B8%8ELocalTime%E4%B8%8ELocalDateTime%E7%9A%84%E5%8C%BA%E5%88%AB%E4%B8%8E%E8%81%94%E7%B3%BB/" title="LocalDate与LocalTime与LocalDateTime的区别与联系"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/11/PRhut51DVxg9XBc.jpg?_r_=02db7499-72ba-2304-866d-b5c2b561abcc" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LocalDate与LocalTime与LocalDateTime的区别与联系"/></a><div class="content"><a class="title" href="/2025/12/30/LocalDate%E4%B8%8ELocalTime%E4%B8%8ELocalDateTime%E7%9A%84%E5%8C%BA%E5%88%AB%E4%B8%8E%E8%81%94%E7%B3%BB/" title="LocalDate与LocalTime与LocalDateTime的区别与联系">LocalDate与LocalTime与LocalDateTime的区别与联系</a><time datetime="2025-12-30T14:29:30.000Z" title="发表于 2025-12-30 22:29:30">2025-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/17/HttpServletRequest%E4%B8%ADInputStream%E8%AF%BB%E5%8F%96%E9%97%AE%E9%A2%98/" title="HttpServletRequest中InputStream读取问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/10/An5KBXLNYlODop3.jpg?_r_=2c4d7584-e768-bb6c-3a0a-5ad27f948644" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HttpServletRequest中InputStream读取问题"/></a><div class="content"><a class="title" href="/2025/02/17/HttpServletRequest%E4%B8%ADInputStream%E8%AF%BB%E5%8F%96%E9%97%AE%E9%A2%98/" title="HttpServletRequest中InputStream读取问题">HttpServletRequest中InputStream读取问题</a><time datetime="2025-02-17T13:21:05.000Z" title="发表于 2025-02-17 21:21:05">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/23/contains%E5%92%8Cfor%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%8C%BA%E5%88%AB/" title="contains和for循环的区别"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/19/v4brSR2Dn3BjXpt.jpg?_r_=e0547e9c-26e6-a1ca-6f51-0d079d6c85a3" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="contains和for循环的区别"/></a><div class="content"><a class="title" href="/2024/11/23/contains%E5%92%8Cfor%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%8C%BA%E5%88%AB/" title="contains和for循环的区别">contains和for循环的区别</a><time datetime="2024-11-23T13:08:43.000Z" title="发表于 2024-11-23 21:08:43">2024-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/27/%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD/" title="文件的上传和下载"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/3b73e41bdfc1757c.png?_r_=72c3578e-ffe7-8573-6764-dc218b3f49ff" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件的上传和下载"/></a><div class="content"><a class="title" href="/2024/10/27/%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD/" title="文件的上传和下载">文件的上传和下载</a><time datetime="2024-10-27T01:50:10.000Z" title="发表于 2024-10-27 09:50:10">2024-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/" title="SpringSecurity"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/10/1dfka8LsM9ZKpVc.jpg?_r_=46ac48e8-86c9-d59d-624d-fef0a432f8c9" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringSecurity"/></a><div class="content"><a class="title" href="/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/" title="SpringSecurity">SpringSecurity</a><time datetime="2024-10-15T00:39:29.000Z" title="发表于 2024-10-15 08:39:29">2024-10-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Nuyoah" target="_blank">Nuyoah</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">88</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://262259.xyz/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://262259.xyz/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.262259.xyz/" title="博客后端"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://unpkg.com/qexo-static@1.4.0/assets/img/brand/qexo.png" alt="博客后端"/><span class="back-menu-item-text">博客后端</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Gitee/" style="font-size: 0.88rem;">Gitee<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 0.88rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JAVA<sup>5</sup></a><a href="/tags/JS/" style="font-size: 0.88rem;">JS<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>7</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem;">hexo<sup>4</sup></a><a href="/tags/win10/" style="font-size: 0.88rem;">win10<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/" style="font-size: 0.88rem;">个人日记<sup>1</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 0.88rem;">人工智能<sup>15</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 0.88rem;">工作<sup>3</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF%E4%BA%8E%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字电路于逻辑<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" style="font-size: 0.88rem;">算法实现<sup>12</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">计算机基础<sup>13</sup></a></div></div><hr/></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Nuyoah 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.262259.xyz/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.262259.xyz/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.262259.xyz/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>