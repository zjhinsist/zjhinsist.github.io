<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>SpringBoot响应式编程 | Nuyoah</title><meta name="author" content="Nuyoah"><meta name="copyright" content="Nuyoah"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringBoot响应式编程"><meta name="application-name" content="SpringBoot响应式编程"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot响应式编程"><meta property="og:url" content="http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/index.html"><meta property="og:site_name" content="Nuyoah"><meta property="og:description" content="Function函数式编程 Function函数在java这个包中定义 java.util.function  消费者(consumer:接收参数不返回) Consumer是一个函数式接口**@FunctionalInterface在接口上添加这个注解可以帮助扫描该接口是否是函数式接口&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;amp;gt"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://s2.loli.net/2022/11/19/j5yB7kgfqsJA2cz.png?_r_=d1dd1143-5885-6436-3ff8-77d3dfd2c9f0"><meta property="article:author" content="Nuyoah"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://s2.loli.net/2022/11/19/j5yB7kgfqsJA2cz.png?_r_=d1dd1143-5885-6436-3ff8-77d3dfd2c9f0"><meta name="description" content="Function函数式编程 Function函数在java这个包中定义 java.util.function  消费者(consumer:接收参数不返回) Consumer是一个函数式接口**@FunctionalInterface在接口上添加这个注解可以帮助扫描该接口是否是函数式接口&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;amp;gt"><link rel="shortcut icon" href="https://s1.ax1x.com/2022/11/27/zUFla6.png"><link rel="canonical" href="http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与数百名博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"404！加载失败！","backTitle":"加载成功！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.262259.xyz/',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"","mailMd5":"a665f8c80fd739329dd0d3f3fe7d90fc"},
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Nuyoah","link":"链接: ","source":"来源: Nuyoah","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":true,"delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Nuyoah',
  title: 'SpringBoot响应式编程',
  postAI: '',
  pageFillDescription: ' Function函数式编程,  消费者(consumer接收参数不返回),  提供者(Supplier不接收参数但是返回),  多功能函数(Function有入参有串),  普通函数(无入参无出参),  断言(有入参返回Boolean),  StreamAPI,  并发？不并发,  创建流,  of,  builder,  concat,  empty,  ofNullable,  generate,  集合.stream() 常用,  中间操作,  filter,  map,  flatMap,  distinct,  sorted,  peek,  limit,  takeWhile,  终结操作,  forEach,  count,  toArray,  collect,  Collectors.toList(),  Collectors.toSet(),  Collectors.toMap(),  Reactive,  思想,  API组件,  Publisher,  Subscriber,  Processor,  总结,  Reactor,  引入依赖,  Flux和Mono简单应用,  Flux使用,  Mono使用,  doOnXXX的使用,  信号,  日志,  subscribe,  自定义回调方法,  subscribe(),  subscribe(consumer),  subscribe(consumer errorConsumer),  subscribe(consumer errorConsumer completeConsumer),  自定义消费者,  实现自定义消费者BaseSubscriber,  取消流,  背压（Backpressure）,  请求重塑（Reshape Request）,  .buffer,  .limitReat(N),  编程式创建流,  同步generate,  异步-多线程create,  自定义处理方法 handle,  线程和调度,  常用操作,  Filter,  FlatMap,  concatMap,  concat,  concatWith,  Transform,  transformDeferred,  Empty,  defaultIfEmpty,  merge,  mergeWith,  mergeSequential,  zip,  next,  错误处理,  默认,  onErrorReturn,  onErrorResume,  调用回调函数,  捕获并根据错误处理,  onErrorMap,  捕获并抛出自定义异常,  doOnError,  doFinally,  onErrorContinue,  onErrorStop,  onErrorComplete,  超时And重试,  Sinks工具类,  many,  unicast,  multicast,  replay,  cache 缓存数据,  block 阻塞获取,  parallel 并发线程,  Context,  WebFlux,  组件对比,  准备工作,  引入依赖,  示例,  流程转换,  处理流程,  简化开发,  SSE,  DispatcherHandler,  handle源码,  核心,  注解开发,  目标方法传参,  返回值写法,  文件上传,  错误处理,  自定义WebFlux配置,  Filter过滤器,  RDBC,  用例,  引入依赖,  代码,  优势,  整合SpringBoot,  引入依赖,  整合配置,  R2dbcEntityTemplate,  DatabaseClient,  R2dbcRepository,  简单查询,  复杂查询,  一对一,  一对多,  最佳实践,  SpringSecurity,  配置,  认证,  授权,  UserDetailsService,  PreAuthorize函数式编程函数在这个包中定义消费者接收参数不返回是一个函数式接口在接口上添加这个注解可以帮助扫描该接口是否是函数式接口只能有一个为实现的方法里面方法是唯一的为实现的方法接收参数但是不返回参数定义消费者提供者不接收参数但是返回里面的方法就是提供者方法不接收参数但是返回参数定义提供者调用提供者的函数多功能函数有入参有串中的多功能函数能接口参数也能返回参数普通函数无入参无出参例如开一个执行方法就是一个无入参无出参的函数断言有入参返回通过传入参数进行逻辑判断最后返回正向判断反向判断需要三部分将操作对象转换成流对流进行中间操作对流进行终结操作只有在终结操作结束开始后才会进行中间操作否则中间操作不会执行转换成流对流进行中间操作对流进行终结操作对结果进行处理并发不并发默认是不并发的和循环一样可以使用操作来让流转换成并发操作当时用并发之后需要注意多线程安全问题有状态流不推荐在流里面做出对流外面的数据进行操作无状态流推荐在流内部不对外部进行操作数据状态只在此函数内有效不溢出至流外创建流创建流将两个流合并到一起返回一个空的流如果传入参数是则返回一个空的流不是则创建一个流通过提供者函数提供的数据生成一个流集合常用中间操作流里面的每一个元素都需要走完一个完整的流水线之后才能轮到下一个元素走流程过滤操作函数内部传入的是一个断言操作需要返回或则这元素通过审核可以走下一步否则直接断在这一步轮到下一个元素上场同类转换操作一对一一个元素转换成另一个元素同类转换操作一对多一个元素转换成另多个元素通过操作需要返回一个流将一个元素变成两个元素最后输出有六个元素去重操作排序操作可传参数比较器不传则默认只对元素进行操作不需要返回元素限流对流进行限制约束限流将三个元素限成一个进行过滤和不同的是过滤结果不符合要求之后会检查下一个不符合操作之后直接中断终结操作遍历操作计数操作将结果返回成数组将结果转换成对象将结果转换成对象和的区别中的元素不允许重复并且是无需的中的元素允许重复并且是有序的将结果集转化成对象需要两个参数参数生成键的函数参数生成值的函数注意在使用的时候键不能重复否则会报键重复异常返回结果是面向流的库的标准和规范处理可能无限数量的元素有序在组件之间异步传递元素强制性非阻塞背压模式正压正向压力数据生产者给消费者的压力数据生产多少个数据消费者就需要去消费多少个数据一次性生产过多数据会导致消费时候压力巨大例如前台给后端发送一万个请求后台突然接到如此多的请求一下子服务器压力倍增导致服务器宕机背压背向压力不正面对压力使用流式处理通过一个缓冲区将多个数据放到缓冲区中一条条处理不管有再多的数据服务端都是一条条处理不会造成突然请求过多导致服务器崩溃线程的数量是越多越好还是越少越好答让线程的数量等于的数量的时候最好思想思想让线程一直处于忙碌状态不是让大量线程一直切换浪费时间当浏览器发送大量请求的时候原本做法会开好多个线程将请求接下然后把线程分配给让去处理这些请求这样会导致线程频繁切换浪费大量时间流式思想开一个线程去将这些请求全部接下然后放到缓冲区然后在开和核心数量相同的线程让线程去缓冲区中领任务当遇到需要等待的数据时会维护一个自己的缓冲区将需要数据等待的工程放到自己的缓冲区中等待数据的到来然后自己再去主缓冲区中领任务目的通过全异步的方式加缓存区构建一个实时的数据流系统能构建出大型分布式的响应式系统缺本地化的消息系统解决方案让所有的异步线程能互相监听消息处理消息构建实时消息处理流响应式声明式编程说清楚要干什么最终结果是怎么样即可数据是自动流的而不是靠迭代被动流动的推拉模型推流模式上流有数据自动流到下流拉迭代式自己遍历自己拉取数据组件发布者产生数据流订阅者消费数据流订阅关系订阅关系是发布者和订阅者之间的关键接口订阅者通过订阅来表示对发布者产生的数据的兴趣订阅者可以请求一定数量的元素也可以取消订阅处理器处理器是同时实现了发布者和订阅者接口的组件它可以接收来自一个发布者的数据进行处理并将结果发布给下一个订阅者处理器在中充当中间环节代表一个处理阶段允许你在数据流中进行转换过滤和其他操作这种模型遵循规范确保了异步流的一致性和可靠性用来发布数据将数据发布到缓冲区中创建创建一个发布者可以通过订阅者来订阅这个发布信息所以里面有个方法创建一个提交发布者向缓冲区中提交数据然后订阅者可以从缓冲区中取出数据通过方法将指定数据存入中的容器中通过调用方法将传入中有个订阅者调用方法将放入缓冲区中通过调用将数据放入的缓冲区中订阅者订阅发布者可以获取到发布者的数据在订阅时调用该方法通过传入订阅关系订阅关系发布者和订阅者之间的联系设置本地订阅者方便后续获取数据订阅开始了关系从发布者那获取一条数据只有获取之后才会给背压模式在下一个数据到来时调用此方法执行回调接收到新数据订阅者接收到新数据如果传入值等于则终端订阅那么也就不会调用方法再从发布者那获取一条数据发生错误时订阅者发生错误错误信息在完成时订阅者订阅结束主线程不能断否则不会有反应处理器定义中间操作每一个中间处理器都是一个发布者和订阅者通过绑定订阅者会有一个订阅者列表里面记录着所有的订阅者当有数据的时候所有的订阅者都可以获取到数据定义中间处理器中间处理器既是生产者又是消费者在订阅时调用该方法通过传入订阅关系订阅关系发布者和订阅者之间的联系设置本地订阅者方便后续获取数据中间处理器开始处理数据从发布者那获取一条数据只有获取之后才会给背压模式在下一个数据到来时调用此方法执行回调接收到新数据处理这开始处理数据将数据进行中间处理哈哈再将数据提交出去发生错误时处理器发生错误错误信息在完成时处理器订阅结束设置关系设置发布者中间处理器和订阅者之间的关系在订阅时调用该方法通过传入订阅关系订阅关系发布者和订阅者之间的联系设置本地订阅者方便后续获取数据订阅开始了关系从发布者那获取一条数据只有获取之后才会给背压模式在下一个数据到来时调用此方法执行回调接收到新数据订阅者接收到新数据如果传入值等于则终端订阅那么也就不会调用方法再从发布者那获取一条数据发生错误时订阅者发生错误错误信息在完成时订阅者订阅结束定义中间处理器进行绑定操作总结响应式编程底层基于数据缓冲队列消息驱动模型异步回调机制编码流式编程链式调用声明式效果优雅全异步消息实时处理高吞吐量占用少量资源解决痛点以前要做高并发系统缓存异步队排好需要我们手动控制整个逻辑现在全自动控制整个逻辑我们只需要组装好数据处理流水线即可少量线程一直运行大量线程切换等待官网三大核心核心非阻塞线程两种数据类型多数据或非阻塞引入依赖和简单应用数据流每一个元素从流的源头开始源源不断自己往下滚动当元素到达时需要处理的操作当元素都处理完之后进行的操作当元素处理出现错误的时候进行的操作一个数据流元素结束信号正常出错流经过运算之后会得到一个新流使用个元素的流流只有在消费的时候才会有用否则没用流可以有多个订阅者创建一个可以自增的流正常情况下不会自己中值流是异步的用子线程来进行流的操作要保证主线程的不能中断使用只能有一个元素或零个元素只有在订阅之后才会有结果的使用在链式中下面操作会消耗上面流在流中的元素消费结束之后的回调方法个元素的流流只有在消费的时候才会有用否则没用在中的内容消费结束之后会调用输出的方法整流操作将流中的的元素以相同的时间间隔发布出去当流中的元素的以不规律的方式传入流中的时候通过整流操作以规整的方式将数据传出去个元素的流流只有在消费的时候才会有用否则没用订阅的时候元素流动速度是一个当流被取消的时候调用此方法个元素的流当流出现错误的时候调用此方法个元素的流当流下一个元素到达时调用此方法个元素的流处理所有的流中的元素包括信号是处理流中的元素不包括信号当使用方法获取流的时候会调用此方法参数为请求的数量使用这种方法的时候会一次性调用所有的流个元素的流所有的方法都是消耗上面的流将转换成新流除出错消耗形成的新流在次操作之后的流并形成新流除出错信号被订阅被请求元素取消订阅的时候在订阅的时候在元素到达的时候在发生错误的时候在流正常完成的时候中断以后当前的上下文感知上下文日志使用方法同样的也是只会记录上一个流处理的操作将转换成新流在次操作之后的流并形成新流流只有在被订阅之后流中的元素才会被处理只要不被订阅则流中的元素所设置的操作都不会被执行的几种参数自定义回调方法空订阅者订阅之后对流中的元素没有进行任何操作生成一个流当流没有被订阅的时候中的操作不会被执行哈哈流被订阅则中的操作会背执行传入一个消费者生成一个流当流没有被订阅的时候中的操作不会被执行哈哈元素到达流被订阅则中的操作会背执行处理元素值返回值结果由此可见当流被订阅的时候流中的元素会依次进行处理元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈传入一个消费者和一个错误消费者当流中出现错误的时候可以由来进行处理也可由来进行处理生成一个流当流没有被订阅的时候中的操作不会被执行哈哈元素到达流被订阅则中的操作会背执行处理元素值对流进行操作出现错误当出现异常时由此消费者处理返回结果当出现错误的时候错误结果被进行处理流中值运行元素到达处理元素值哈哈元素到达处理元素值哈哈出现错误传入三个消费者第一个正常消费第二个捕获错误信息第三个捕获完成信息生成一个流当流没有被订阅的时候中的操作不会被执行哈哈元素到达流被订阅则中的操作会背执行处理元素值出现错误流正常结束结果显示元素到达处理元素值哈哈元素到达处理元素值哈哈元素到达处理元素值哈哈流正常结束自定义消费者实现进行消费者的自定义实现消费者中有各种回调方法可以实现如下方法实现自定义消费者中实现的很多方法方便我们调用例如等等生成一个流当流没有被订阅的时候中的操作不会被执行哈哈元素到达流被订阅则中的操作会背执行开始订阅元素到达取消流流可以被消费者使用方法随时取消流生成一个流当流没有被订阅的时候中的操作不会被执行哈哈元素到达流被订阅则中的操作会背执行开始订阅元素到达流被取消了背压是消费者像生产者请求数据的时候生产者才会给消费者数据请求一个给一个请求几个给几个好处虽然生产者多很多数据但是只有在消费者请求的时候才能给消费者数据不会因为生产数据过多导致消费者压力过大崩溃请求重塑通过设置缓冲区将流中的元素进行缓冲区分开默认缓冲区为找发布者请求次数据总共能得到个数据当不使用的时候我们通过是请求了一个数据当时用之后我们通过是请求了个数据和不一样表明一次请求三个数据那么生产者会一次发一条数据发三次使用生产者会一次发三个数据发一次用的话就是第一个触发了三次第二个触发了一次生成一个流当流没有被订阅的时候中的操作不会被执行哈哈流被订阅则中的操作会背执行开始订阅结果开始订阅哈哈哈哈哈哈限制请求速率并且有预抓取策略当设置的请求大小中已经与的数据被消费了之后会自动请求下一个请求速率的元素发布者发布个数据并设置请求速率为那么在第一次请求的时候会请求个当个中的数据被消费之后会自动请求下面的设置请求速率是个结果请求已经到了再从新请求的数据是放到缓冲区中一次请求个数据是一次性取设置的速率次数的值如果是是如果不适用限流的话会一次性全部取出进行限流之后第一次会请求次一次是大小的数据从第二次开始实行预抓取策略请求的次数是设置的编程式创建流想通过自定义一系列函数来创建序列可以有以下几种方式同步通过设置初始值来开始元素的生成通过的方法来处理我们需要发布什么数据出去通过来决定下一次处理数据的最新状态初始值元素传递完成信号异步多线程上线了自定义处理方法在上面的一系列方法中例如中进行流的中间操作现在可以使用自定义处理方法来处理操作和的区别需要返回值类型必须是统一的没有这个限制自定义处理方法自定义处理方法将处理后的值进行发布线程和调度默认线程池创建一个单个线程池创建一个多个线程池线程个数核心数存活时间使用切换发布者线程使用切换接受者线程池如果不切换线程池的话上面一些操作默认都是在主线程下执行的只要发布者不指定线程则默认使用订阅者的线程因为流只有在被订阅的时候才会流动常用操作过滤操作需要返回或的过滤掉结果只有为偶数的元素流下来了首先是流被订阅后来请求无限个元素最后偶数元素到达将日志打印在上面首先订阅元素其次是订阅者请求无限个元素第一个元素到达发现第一个元素无法对取余所以请求了下一个元素第二元素也无法对取余有请求了一次直到第三个符合要求就没有在请求了背压模式将流一个元素转换成多个元素无序的发往下流输入日志同样是将一个元素转换成多个元素但是是有序的为什么是无序的而是有序的因为是并发处理元素的当一个元素到达之后进行元素的处理不等这个元素处理完就会请求下一个元素当第一个元素处理慢而第二个元素处理快的时候第二个元素就会优先流往下流导致顺序出错将两个流转换合并成新流不做任何操作将老流连接上新流转换流中的数据将流中的数据整体转换成另一种数据接收的是一个上流传过来的流将流中的元素进行转换之后送个下流一个流的一个只会执行一次执行了执行结果执行了同样是将流转换成一个新流不过是有一个订阅者就会执行一次转换执行了执行结果执行了执行了发布出一个空元素如果想要发布出一个空元素需要使用来进行发布可以判断当流中的元素为空的时候设置一个默认值静态兜底方法动态兜底方法判断流中元素是否为空如果为空怎调用一个方法来返回值将多个流进行合并并且按照元素发布的时间进行合并将老流合并到新流中按照那个流先发先合并那个将多个流中的元素进行打包打包成一个元组直接获取第一个数据无需通过订阅者错误处理错误是一种中断信息不是流结束信息订阅者可以感知流的正确与错误信息默认在订阅的时候可以传入三个消费者流正常时的消费者流错误时的消费者流结束时的消费者捕获并返回在命令式编程中以下面这种方式捕获并返回信息在流式编程中使用方法实现上面的方式无法直接跟在流初始化的后面需要跟在中间操作后面特性会捕获处理异常消费者无异常感知返回一个默认值中断流操作流正常完成捕获并调用回调方法在命令式编程中此方法是捕获异常后调用此方法调用回调函数特性可以捕获异常消费者无感知当发生异常之后会调用一个自定义方法流中断正常返回捕获并根据错误处理捕获并抛出自定义异常使用执行该操作消费者会感知到异常使用来执行该操作特点捕获异常抛出新异常消费者有感知流异常结束捕获异常并且对异常进行记录消费者有感知在命令式编程中实现方法如此在响应式编程中实现方法如下感知到异常特点捕获异常并做一些自己的事情将异常继续向下抛出不吃掉异常只感知异常无论是流正常结束还是异常结束都会执行里面的方法当异常出现的时候处理异常并继续执行不会中断流的操作发现有问题并继续执行当发生错误的时候从源头中断流一个流有多个订阅者如果其中一个使用了之后并且发生异常了那么其他正常的订阅者也会被停止如果不适用该操作那么其中一个出现错误了其他的不会被停止将流错误信号转换成正常结束信号也会中断流超时重试设置超时时间如果流在规定的超时时间内无法到达下流则会异常超时啦设置重试机制重试的时候会将流中的元素从头到尾重新请求一遍将流中的元素从头到尾重新请求最多次工具类数据管道所有数据都是顺着这个管道向下走发送数据单播只有一条管道只能绑定一个消费者创建一个对象向中存放数据将转换成对象并订阅如果上述创建的对象被多个订阅者订阅的话会报错默认订阅者是从订阅开始的时候开始接受元素多播模式可以被多个订阅者订阅重放使用该方法会让管道能够重放是否给后来的订阅者发送之前发送过的数据底层用队列存放之前发送过的数据用来判断订阅者接受订阅之后发送的数据还是可以接受订阅之前发送的数据输出结果从第五秒开始一下订阅之前发过的三个元素缓存数据缓存发布的信息不设置缓存信息默认缓存所有阻塞获取阻塞当想要拿到流中的数据的时候可以使用来获取将流转换成数据阻塞获取所有的数据并发线程有哥数据现在想要通过个线程来处理操作每个线程处理个数据直到设置上下文操作通过设置中的内容让上流够拿到下流中的参数上流能够拿到下流中的最近一次的数据上流传下来的数据下流传上来的数据因为在响应式编程中整体的流程有所改变所以需要通过设置上下文的方式来进行参数的传递在响应式编程中先是通过层获取数据层定于层获取的数据最后层订阅处理的数据最后返回给前端在这个过程中作为资源发布者从数据库中读取数据最后经过一系列处理操作返回个前台以前浏览器现在浏览器底层基于完成一个全异步非阻塞的响应式框架底层异步消息队列事件回调整套系统优点使用少量资源处理大量请求组件对比功能阻塞式响应式前端控制器处理器请求响应过滤器异常处理器配置自定义配置返回结果任意任意返送请求准备工作引入依赖示例在这个里面返回值为类型用返回返回值为实体类型的用接受流程转换以前浏览器现在浏览器处理流程自己创建一个能处理请求的处理器参数请求相应返回值代表处理完成信号启动一个服务器监听端口接收数据拿到数据之后交给处理数据简化开发在开发中中的开放方式基本支持完整的处理流程构建设置数据设置设置评论设置事件建立操作和的区别是单通道只能后端持续的给前台发送数据是多通道后端可以给前台发送数据前台也能够给后台发送数据包含三个处理器请求映射处理器保存每个请求由那个方法进行处理处理适配器反射执行目标方法处理器结果处理器对比有一个方法来处理所有请求有一个方法来处理所有请求源码所有的请求和相应都封装在对象中通过方法进行处理首先如果没有任何请求映射器则直接返回错误信息新建一个错误信息并返回通过方式创建一个错误对象直到流被订阅的时候才会实例化错误对象如果不适用方法将操作进行封装那么在返回错误对象的时候都会新建一个对象这就会导致流还没有被订阅的时候错误对象已经创建出来了通过使用创建的错误流只有在流由订阅者并且流被激活的时候才会动态调用此方法延迟加载最后通过三元表达式来判断是否是跨域请求如果是跨域请求则需要预检查流式操作先找到在获取通过调用处理请求期间的错误由处理通过获取那个能够处理该请求通过获取第一个能处理该请求的如果是空则将流抛出异常通过异常处理方法处理此异常如果没有错误则通用处理此请求核心和编写了怎么处理请求处理结果注解开发目标方法传参参数描述封装了请求和相应请求和相应可以访问对象获取请求方法路径参数标注点请求参数获取请求头获取值获取请求体中包含的数据获取请求头和请求体获取文件上传数据数据校验获取对象获取转发请求返回值写法返回值描述将相应的数据写出去如果是对象则自动转换成支持快捷自定义相应内容没有响应体只有相应头快速构建错误相应返回字符串可以被视图解析器处理返回视图对象也是一种视图对象仅代表相应完成使用完成效果文件上传以前现在通过来获取上传文件错误处理自定义配置通过创建类实现类的自动装配配置跨域设置过滤器请求到目标方法执勤啊请求完目标方法之后官网用例引入依赖代码建立工厂连接配置项创建连接工厂通过连接工厂获取发布者信息并通过包装成流优势在传统的中如果我们通过分页查询数据的时候查询第一页就发送一条建立一个链接获取数据关闭链接在中我们一共建立一个链接并且不会关闭通过获取数据获取几个数据数据库就返回几个数据不用频繁查询构建连接整合引入依赖响应式响应式整合配置主要提供了连接工厂连接池等操作主要提供了可以进行操作操作数据的响应式客户端提供数据类型映射关系转换器自定义转换器组件数据类型转换等操作开启声明式接口方式例如提供了和等自带了操作提供了接口不用写任何实现类的情况下可直接具备操作使用情况很少几乎不用可以查看文档缺点操作不好做单表用贴近底层操作好做写测试简单查询类似中的和继承了很多实现方法实现配置信息开启表明是一个配置类继承接口泛型第一个是该接口的实体类第二个是该接口的主键类型继承了很多实现方法只限制单表复杂查询参数参数使用接口信息通过给接口命名来查询指定信息例如下面的信息只限制单表复杂查询参数参数通过指定查询语句来查询指定信息自定义查询语句返回指定结果信息复杂查询现在用户表和图书表一个图书对应一个作者一个作者对应多个图书一对一一对一查询图书的时候将其对应的作者的信息查询出来定义实体类在图书对象中封装用户信息标明次对象不是里面的表定义查询方法定义转换器将查询出来的结果生成对象并返回读取数据数据的时候将转换成对象设置图书对象设置用户对象注册转换器在配置中设置转换器查询操作直接查询出图书及其作者信息在发现方法签名返回值是对象的时候就会调用自己设置将返回值封装成对象缺陷如果设置了转化器那么中的所有返回类型是的方法都会去用这个转换器进行转换在转换器中设置了这个方式去获取作者的和姓名在使用简单查询的时候例如的时候返回值结果中没有这一项会导致转换器报错解决方法设置新类新新映射类进行结果映射在转换器中进行校验来判断返回结果是否有这一列如果有再进行结果映射一对多一对多通过查出作者及其所有图书信息结果信息方式一通过使用将分组一样的分为同一组可以乱序方式二使用来进行分组将符合条件的分为同一组必须按照排好序否则分不到一组最佳实践基础的用提供好了自定义复杂的单表查询无需要做结果映射的多表查询复杂结果集自定义及结果封装注解自定义实现对结果集封装配置依赖响应式响应式认证开启基于方法级别的响应式权限控制先配置那些请求需要权限认证那些不需要配置路径请求静态资源下的所有路径都可以访问剩下的资源都需要进行权限认证登录开启默认表单登录安全控制操作构建权限系统授权和只能写一个后面写的生效会覆盖掉前面写的',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-17 21:34:28',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 7.1.1"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://s1.ax1x.com/2022/11/27/zUFla6.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://262259.xyz/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://262259.xyz/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.262259.xyz/" title="博客后端"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://unpkg.com/qexo-static@1.4.0/assets/img/brand/qexo.png" alt="博客后端"/><span class="back-menu-item-text">博客后端</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Nuyoah</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Gitee/" style="font-size: 1.05rem;">Gitee<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 1.05rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JAVA<sup>5</sup></a><a href="/tags/JS/" style="font-size: 1.05rem;">JS<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>1</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>7</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>4</sup></a><a href="/tags/win10/" style="font-size: 1.05rem;">win10<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/" style="font-size: 1.05rem;">个人日记<sup>1</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 1.05rem;">人工智能<sup>15</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF%E4%BA%8E%E9%80%BB%E8%BE%91/" style="font-size: 1.05rem;">数字电路于逻辑<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" style="font-size: 1.05rem;">算法实现<sup>12</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">计算机基础<sup>13</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/03/"><span class="card-archive-list-date">三月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">SpringBoot响应式编程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-09-26T13:26:18.000Z" title="发表于 2024-09-26 21:26:18">2024-09-26</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-01-17T13:34:28.746Z" title="更新于 2025-01-17 21:34:28">2025-01-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>68分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为石家庄"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>石家庄</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://s2.loli.net/2022/11/19/j5yB7kgfqsJA2cz.png?_r_=d1dd1143-5885-6436-3ff8-77d3dfd2c9f0"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"><header><h1 id="CrawlerTitle" itemprop="name headline">SpringBoot响应式编程</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Nuyoah</span><time itemprop="dateCreated datePublished" datetime="2024-09-26T13:26:18.000Z" title="发表于 2024-09-26 21:26:18">2024-09-26</time><time itemprop="dateCreated datePublished" datetime="2025-01-17T13:34:28.746Z" title="更新于 2025-01-17 21:34:28">2025-01-17</time></header><h1 id="function函数式编程"><a class="markdownIt-Anchor" href="#function函数式编程"></a> Function函数式编程</h1>
<p>Function函数在java这个包中定义</p>
<p><strong>java.util.function</strong></p>
<h2 id="消费者consumer接收参数不返回"><a class="markdownIt-Anchor" href="#消费者consumer接收参数不返回"></a> 消费者(consumer:接收参数不返回)</h2>
<p>Consumer是一个函数式接口**@FunctionalInterface在接口上添加这个注解可以帮助扫描该接口是否是函数式接口===&gt;只能有一个为实现的方法**</p>
<p>Consumer里面accept方法是唯一的为实现的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span>;</span><br></pre></td></tr></table></figure>
<p>接收参数但是不返回参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义消费者</span></span><br><span class="line">Consumer&lt;String&gt; consumer = System.out::println;</span><br><span class="line">consumer.accept(<span class="string">&quot;Hello&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="提供者supplier不接收参数但是返回"><a class="markdownIt-Anchor" href="#提供者supplier不接收参数但是返回"></a> 提供者(Supplier:不接收参数但是返回)</h2>
<p>Supplier里面的Get方法就是提供者方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Supplier</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets a result.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不接收参数但是返回参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义提供者</span></span><br><span class="line">Supplier&lt;String&gt; supplier = () -&gt; <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="comment">// 调用提供者的函数</span></span><br><span class="line">supplier.get();</span><br></pre></td></tr></table></figure>
<h2 id="多功能函数function有入参有串"><a class="markdownIt-Anchor" href="#多功能函数function有入参有串"></a> 多功能函数(Function:有入参有串)</h2>
<p>Function中的apply多功能函数，能接口参数也能返回参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Function</span>&lt;T, R&gt; &#123;</span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(T t)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;String, String&gt; function = String::toUpperCase;</span><br><span class="line">function.apply(<span class="string">&quot;Hello&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="普通函数无入参无出参"><a class="markdownIt-Anchor" href="#普通函数无入参无出参"></a> 普通函数(无入参无出参)</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如开一个执行方法就是一个无入参无出参的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">runnable.run();</span><br></pre></td></tr></table></figure>
<h2 id="断言有入参返回boolean"><a class="markdownIt-Anchor" href="#断言有入参返回boolean"></a> 断言(有入参返回Boolean)</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Predicate</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Evaluates this predicate on the given argument.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the input argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the input argument matches the predicate,</span></span><br><span class="line"><span class="comment">     * otherwise &#123;<span class="doctag">@code</span> false&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">test</span><span class="params">(T t)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a composed predicate that represents a short-circuiting logical</span></span><br><span class="line"><span class="comment">     * AND of this predicate and another.  When evaluating the composed</span></span><br><span class="line"><span class="comment">     * predicate, if this predicate is &#123;<span class="doctag">@code</span> false&#125;, then the &#123;<span class="doctag">@code</span> other&#125;</span></span><br><span class="line"><span class="comment">     * predicate is not evaluated.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Any exceptions thrown during evaluation of either predicate are relayed</span></span><br><span class="line"><span class="comment">     * to the caller; if evaluation of this predicate throws an exception, the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> other&#125; predicate will not be evaluated.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> other a predicate that will be logically-ANDed with this</span></span><br><span class="line"><span class="comment">     *              predicate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a composed predicate that represents the short-circuiting logical</span></span><br><span class="line"><span class="comment">     * AND of this predicate and the &#123;<span class="doctag">@code</span> other&#125; predicate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if other is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> Predicate&lt;T&gt; <span class="title function_">and</span><span class="params">(Predicate&lt;? <span class="built_in">super</span> T&gt; other)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(other);</span><br><span class="line">        <span class="keyword">return</span> (t) -&gt; test(t) &amp;&amp; other.test(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span> Predicate&lt;T&gt; <span class="title function_">negate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (t) -&gt; !test(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span> Predicate&lt;T&gt; <span class="title function_">or</span><span class="params">(Predicate&lt;? <span class="built_in">super</span> T&gt; other)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(other);</span><br><span class="line">        <span class="keyword">return</span> (t) -&gt; test(t) || other.test(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &lt;T&gt; Predicate&lt;T&gt; <span class="title function_">isEqual</span><span class="params">(Object targetRef)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">null</span> == targetRef)</span><br><span class="line">                ? Objects::isNull</span><br><span class="line">                : object -&gt; targetRef.equals(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> &lt;T&gt; Predicate&lt;T&gt; <span class="title function_">not</span><span class="params">(Predicate&lt;? <span class="built_in">super</span> T&gt; target)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(target);</span><br><span class="line">        <span class="keyword">return</span> (Predicate&lt;T&gt;)target.negate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过传入参数进行逻辑判断，最后返回true OR false</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;Integer&gt; predicate = (a) -&gt; a&gt;<span class="number">10</span>;</span><br><span class="line"><span class="comment">// 正向判断</span></span><br><span class="line">predicate.test(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// 反向判断</span></span><br><span class="line">predicate.negate().test(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<h1 id="streamapi"><a class="markdownIt-Anchor" href="#streamapi"></a> StreamAPI</h1>
<p>需要三部分</p>
<ol>
<li>将操作对象转换成流</li>
<li>对流进行中间操作
<ol>
<li>filter</li>
<li>map</li>
<li>sorted</li>
</ol>
</li>
<li>对流进行终结操作，<strong>只有在终结操作结束开始后，才会进行中间操作，否则中间操作不会执行</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; integers = List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">integers.stream() <span class="comment">// 转换成流</span></span><br><span class="line">        .filter(integer -&gt; integer % <span class="number">2</span> == <span class="number">0</span>) <span class="comment">// 对流进行中间操作</span></span><br><span class="line">        .max(Integer::compareTo) <span class="comment">// 对流进行终结操作</span></span><br><span class="line">        .ifPresent(System.out::println); <span class="comment">// 对结果进行处理</span></span><br></pre></td></tr></table></figure>
<h2 id="并发不并发"><a class="markdownIt-Anchor" href="#并发不并发"></a> 并发？不并发</h2>
<p><strong>Stream默认是不并发的，和for循环一样</strong></p>
<p>可以使用**.parallel()**操作来让Stream流转换成并发操作</p>
<p><strong>当时用并发之后，需要注意多线程安全问题</strong></p>
<p>**有状态流：不推荐：**在流里面做出对流外面的数据进行操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).stream().filter(i -&gt; &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">            <span class="keyword">return</span> i % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">        &#125;).forEach(list::add);</span><br></pre></td></tr></table></figure>
<p>**无状态流：推荐：**在流内部不对外部进行操作，数据状态只在此函数内有效，不溢出至流外</p>
<h2 id="创建流"><a class="markdownIt-Anchor" href="#创建流"></a> 创建流</h2>
<h3 id="of"><a class="markdownIt-Anchor" href="#of"></a> of</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;Integer&gt; integerStream = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h3 id="builder"><a class="markdownIt-Anchor" href="#builder"></a> builder</h3>
<p>创建流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;Object&gt; build = Stream.builder().add(<span class="string">&quot;11&quot;</span>).add(<span class="string">&quot;22&quot;</span>).add(<span class="string">&quot;33&quot;</span>).build();</span><br></pre></td></tr></table></figure>
<h3 id="concat"><a class="markdownIt-Anchor" href="#concat"></a> concat</h3>
<p>将两个Stream流合并到一起</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;Object&gt; concat = Stream.concat(integerStream, build);</span><br></pre></td></tr></table></figure>
<h3 id="empty"><a class="markdownIt-Anchor" href="#empty"></a> empty</h3>
<p>返回一个空的Stream流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;Object&gt; empty = Stream.empty();</span><br><span class="line">empty.forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="ofnullable"><a class="markdownIt-Anchor" href="#ofnullable"></a> ofNullable</h3>
<p>如果传入参数是null，则返回一个空的Stream流，不是null则创建一个流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;String&gt; aaa = Stream.ofNullable(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">Stream&lt;String&gt; bbb = Stream.ofNullable(<span class="literal">null</span>);</span><br><span class="line">aaa.forEach(System.out::println);</span><br><span class="line">bbb.forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="generate"><a class="markdownIt-Anchor" href="#generate"></a> generate</h3>
<p>通过提供者函数提供的数据生成一个流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;List&lt;Integer&gt;&gt; generate = Stream.generate(() -&gt; Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">generate.forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="集合stream-常用"><a class="markdownIt-Anchor" href="#集合stream-常用"></a> 集合.stream() 常用</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).stream();</span><br></pre></td></tr></table></figure>
<h2 id="中间操作"><a class="markdownIt-Anchor" href="#中间操作"></a> 中间操作</h2>
<p>流里面的<strong>每一个元素都需要走完一个完整的流水线之后，才能轮到下一个元素走流程</strong></p>
<h3 id="filter"><a class="markdownIt-Anchor" href="#filter"></a> filter</h3>
<p>过滤操作</p>
<p><strong>filter函数内部传入的是一个Predicate</strong>，断言操作，需要返回true或false，true则这元素通过审核，可以走下一步，否则直接断在这一步，轮到下一个元素上场</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).stream().filter(a -&gt; a &gt; <span class="number">2</span>).count</span><br></pre></td></tr></table></figure>
<h3 id="map"><a class="markdownIt-Anchor" href="#map"></a> map</h3>
<p><strong>同类：</strong> <strong>mapToInt, mapToLong, mapToDouble</strong></p>
<p>转换操作，一对一，一个元素转换成另一个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).stream().map(t -&gt; t + <span class="number">1</span>).forEach(System.out::println)</span><br></pre></td></tr></table></figure>
<h3 id="flatmap"><a class="markdownIt-Anchor" href="#flatmap"></a> flatMap</h3>
<p><strong>同类：</strong> <strong>flatMapToInt, flatMapToLong, flatMapToDouble</strong></p>
<p>转换操作，一对多，一个元素转换成另多个元素，通过flatMap操作需要返回一个流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .stream()</span><br><span class="line">    .map(t -&gt; t + <span class="number">1</span>)</span><br><span class="line">    .flatMap(t -&gt; Arrays.asList(t, t+<span class="number">1</span>).stream()) <span class="comment">// 将一个元素变成两个元素</span></span><br><span class="line">    .forEach(System.out::println) <span class="comment">// 最后输出有六个元素</span></span><br></pre></td></tr></table></figure>
<h3 id="distinct"><a class="markdownIt-Anchor" href="#distinct"></a> distinct</h3>
<p>去重操作</p>
<h3 id="sorted"><a class="markdownIt-Anchor" href="#sorted"></a> sorted</h3>
<p>排序操作，<strong>可传参数比较器</strong>，不传则默认</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">     .stream()</span><br><span class="line">     .sorted(Integer::compareTo)</span><br><span class="line">     .forEach(System.out::println) </span><br></pre></td></tr></table></figure>
<h3 id="peek"><a class="markdownIt-Anchor" href="#peek"></a> peek</h3>
<p><strong>只对元素进行操作，不需要返回元素</strong></p>
<h3 id="limit"><a class="markdownIt-Anchor" href="#limit"></a> limit</h3>
<p>限流，对流进行限制约束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">     .stream()</span><br><span class="line">     .sorted(Integer::compareTo)</span><br><span class="line">    .limit(<span class="number">1</span>) <span class="comment">// 限流1,将三个元素限成一个</span></span><br><span class="line">     .forEach(System.out::println) </span><br></pre></td></tr></table></figure>
<h3 id="takewhile"><a class="markdownIt-Anchor" href="#takewhile"></a> takeWhile</h3>
<p><strong>进行过滤</strong>，和filter不同的是，filter过滤结果不符合要求之后会检查下一个，<strong>takeWhile不符合操作之后直接中断</strong></p>
<h2 id="终结操作"><a class="markdownIt-Anchor" href="#终结操作"></a> 终结操作</h2>
<h3 id="foreach"><a class="markdownIt-Anchor" href="#foreach"></a> forEach</h3>
<p>遍历操作</p>
<h3 id="count"><a class="markdownIt-Anchor" href="#count"></a> count</h3>
<p>计数操作</p>
<h3 id="toarray"><a class="markdownIt-Anchor" href="#toarray"></a> toArray</h3>
<p>将结果返回成数组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Integer[] array = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).stream()</span><br><span class="line">    .filter(i -&gt; &#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">        <span class="keyword">return</span> i % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;).distinct().sorted(Integer::compareTo).toArray(Integer[]::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure>
<h3 id="collect"><a class="markdownIt-Anchor" href="#collect"></a> collect</h3>
<h4 id="collectorstolist"><a class="markdownIt-Anchor" href="#collectorstolist"></a> Collectors.toList()</h4>
<p>将结果转换成List对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; collect = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .filter(i -&gt; &#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">        <span class="keyword">return</span> i % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;).distinct().sorted(Integer::compareTo).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>
<h4 id="collectorstoset"><a class="markdownIt-Anchor" href="#collectorstoset"></a> Collectors.toSet()</h4>
<p>将结果转换成Set对象，set和list的区别：<strong>SET中的元素不允许重复并且是无需的，LIST中的元素允许重复并且是有序的</strong></p>
<h4 id="collectorstomap"><a class="markdownIt-Anchor" href="#collectorstomap"></a> Collectors.toMap()</h4>
<p>将结果集转化成Map对象</p>
<p>toMap() 需要两个参数</p>
<ul>
<li>参数1：生成键的Function函数</li>
<li>参数2：生成值的Function函数</li>
</ul>
<p><strong>注意：在使用toMap的时候键不能重复，否则会报键重复异常</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Integer&gt; collect = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .filter(i -&gt; &#123;</span><br><span class="line">        list.add(i);</span><br><span class="line">        <span class="keyword">return</span> i % <span class="number">2</span> == <span class="number">0</span>;</span><br><span class="line">    &#125;).distinct().collect(Collectors.toMap(i -&gt; <span class="string">&quot;key_&quot;</span> + i, i -&gt; i));</span><br></pre></td></tr></table></figure>
<p>返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key_2=<span class="number">2</span></span><br><span class="line">key_4=<span class="number">4</span></span><br></pre></td></tr></table></figure>
<h1 id="reactive"><a class="markdownIt-Anchor" href="#reactive"></a> Reactive</h1>
<p>ReactiveStreams是JVM面向流的库的标准和规范</p>
<ol>
<li>
<p>处理可能无限数量的元素</p>
</li>
<li>
<p>有序</p>
</li>
<li>
<p>在组件之间异步传递元素</p>
</li>
<li>
<p>强制性<strong>非阻塞背压模式</strong></p>
<blockquote>
<p>正压：正向压力，数据生产者给消费者的压力，数据生产多少个数据，消费者就需要去消费多少个数据，<strong>一次性生产过多数据，会导致消费时候压力巨大</strong>，例如前台给后端发送一万个请求，后台突然接到如此多的请求，一下子服务器压力倍增，导致服务器宕机</p>
<p>背压：背向压力：不正面对压力，使用流式处理，通过一个缓冲区，将多个数据放到缓冲区中，一条条处理，不管有再多的数据，服务端都是一条条处理，不会造成突然请求过多导致服务器崩溃</p>
</blockquote>
</li>
</ol>
<p>线程的数量是越多越好还是越少越好？</p>
<p>答：<strong>让线程的数量等于CPU的数量的时候最好</strong></p>
<h2 id="思想"><a class="markdownIt-Anchor" href="#思想"></a> 思想</h2>
<p>思想：<strong>让线程一直处于忙碌状态，不是让大量线程一直切换浪费时间</strong></p>
<p>当浏览器发送大量请求的时候，<strong>Tomcat原本做法：会开好多个线程将请求接下，然后把线程分配给CPU，让CPU去处理这些请求</strong>，这样会导致线程频繁切换，浪费大量时间，<strong>流式思想：开一个BOSS线程去将这些请求全部接下，然后放到缓冲区，然后在开和CPU核心数量相同的WORKER线程，让线程去缓冲区中领任务</strong>，当WORKER遇到需要等待的数据时，worker会维护一个自己的 缓冲区，将需要数据等待的工程放到自己的缓冲区中等待数据的到来，然后自己再去主缓冲区中领任务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/12/05/ZpXiNvfrBYa58bs.png" alt="image-20241205230424086" /></p>
<p><strong>目的：<strong>通过全异步的方式、加缓存区构建一个</strong>实时的数据流系统</strong>。Kafka、MQ能构建出大型分布式的响应式系统。</p>
<p>缺本地化的消息系统解决方案:</p>
<ul>
<li>让所有的异步线程能<strong>互相监听消息</strong>，<strong>处理消息</strong>，<strong>构建实时消息处理流</strong></li>
</ul>
<p>**响应式/声明式编程：**说清楚要干什么，最终结果是怎么样即可</p>
<p>数据是自动流的，而不是靠迭代被动流动的</p>
<p>推拉模型：</p>
<blockquote>
<p>推：流模式，上流有数据，自动流到下流</p>
<p>拉：迭代式：自己遍历，自己拉取数据</p>
</blockquote>
<h2 id="api组件"><a class="markdownIt-Anchor" href="#api组件"></a> API组件</h2>
<ol>
<li>Publisher:发布者;<strong>产生数据流</strong></li>
<li>Subscriber:订阅者;<strong>消费数据流</strong></li>
<li>Subscription:订阅关系;
<ol>
<li>订阅关系是发布者和订阅者之间的关键接口。订阅者通过订阅来表示对发布者产生的数据的兴趣。订阅者可以请求一定数量的元素，也可以取消订阅。</li>
</ol>
</li>
<li>Processor:处理器
<ol>
<li>处理器是<strong>同时实现了发布者和订阅者接口的组件</strong>。它可以接收来自一个发布者的数据，进行处理，并将结果发布给下一个订阅者。处理器在Reactor中充当中间环节，代表一个处理阶段，允许你在数据流中进行转换、过滤和其他操作。<br />
这种模型遵循Reactive Streams规范，确保了异步流的一致性和可靠性。</li>
</ol>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241209173148477.png" alt="image-20241209173148477" /></p>
<h3 id="publisher"><a class="markdownIt-Anchor" href="#publisher"></a> Publisher</h3>
<p><strong>用来发布数据，将数据发布到缓冲区中</strong></p>
<p>创建publisher</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个发布者</span></span><br><span class="line">Flow.Publisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">Flow</span>.Publisher&lt;String&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> Flow.Subscriber&lt;? <span class="built_in">super</span> String&gt; subscriber;</span><br><span class="line">    <span class="comment">// 可以通过订阅者来订阅这个发布信息，所以publisher里面有个subscribe方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Flow.Subscriber&lt;? <span class="built_in">super</span> String&gt; subscriber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>创建一个提交发布者，向缓冲区中提交数据，然后订阅者可以从缓冲区中取出数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (SubmissionPublisher&lt;String&gt; stringSubmissionPublisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        stringSubmissionPublisher.submit(<span class="string">&quot;Hello &quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>submissionPublisher通过submit方法将指定数据存入Publisher中的buffer容器中</p>
<ol>
<li>submit通过调用doOffer方法，将item传入</li>
<li>doOffer中有个BufferedSubscription订阅者调用offer方法将item放入缓冲区中</li>
<li>通过调用growAndOffer将数据放入Publisher的缓冲区中</li>
</ol>
<h3 id="subscriber"><a class="markdownIt-Anchor" href="#subscriber"></a> Subscriber</h3>
<p>订阅者，订阅发布者，可以获取到发布者的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line">Flow.Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> <span class="title class_">Flow</span>.Subscriber&lt;&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在订阅时，调用该方法，通过传入订阅关系</span></span><br><span class="line"><span class="comment">     * 订阅关系：发布者和订阅者之间的联系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscription a new subscription</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置本地订阅者，方便后续获取数据</span></span><br><span class="line">        <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;订阅开始了，关系：&quot;</span> + subscription);</span><br><span class="line">        <span class="comment">// 从发布者那获取一条数据，只有获取之后才会给，背压模式</span></span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在下一个数据到来时调用此方法，执行回调，接收到新数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item the item</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(String item)</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，接收到新数据&quot;</span> + item);</span><br><span class="line">        <span class="comment">// 如果传入值等于7则终端订阅，那么也就不会调用onComplete方法</span></span><br><span class="line">        <span class="keyword">if</span> (item.equals(<span class="string">&quot;7&quot;</span>)) subscription.cancel();</span><br><span class="line">        <span class="comment">// 再从发布者那获取一条数据</span></span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发生错误时</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable the exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，发生错误，错误信息：&quot;</span> + throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在完成时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，订阅结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">publisher.subscribe(subscriber);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    publisher.submit(String.valueOf(i));</span><br><span class="line">&#125;</span><br><span class="line">publisher.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主线程不能断，否则不会有反应</span></span><br><span class="line">Thread.sleep(<span class="number">20000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="processor"><a class="markdownIt-Anchor" href="#processor"></a> Processor</h3>
<p>处理器，定义中间操作</p>
<p><strong>每一个中间处理器Processor都是一个发布者和订阅者</strong></p>
<p>Publisher通过subscribe绑定订阅者，Publisher会有一个订阅者列表，里面记录着所有的订阅者，当有数据的时候，所有的订阅者都可以获取到数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241209200650119.png" alt="image-20241209200650119" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义中间处理器</span></span><br><span class="line"><span class="comment">     * 中间处理器既是生产者又是消费者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyProcessor</span> <span class="keyword">extends</span> <span class="title class_">SubmissionPublisher</span>&lt;String&gt; <span class="keyword">implements</span> <span class="title class_">Flow</span>.Processor&lt;String, String&gt;  &#123;</span><br><span class="line">    <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 在订阅时，调用该方法，通过传入订阅关系</span></span><br><span class="line"><span class="comment">         * 订阅关系：发布者和订阅者之间的联系</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> subscription a new subscription</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置本地订阅者，方便后续获取数据</span></span><br><span class="line">        <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">        System.out.println(<span class="string">&quot;中间处理器开始处理数据&quot;</span> + subscription);</span><br><span class="line">        <span class="comment">// 从发布者那获取一条数据，只有获取之后才会给，背压模式</span></span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 在下一个数据到来时调用此方法，执行回调，接收到新数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> item the item</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(String item)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;处理这开始处理数据：&quot;</span> + item);</span><br><span class="line">        <span class="comment">// 将数据进行中间处理</span></span><br><span class="line">        item = item + <span class="string">&quot;: 哈哈&quot;</span>;</span><br><span class="line">        <span class="comment">// 再将数据提交出去</span></span><br><span class="line">        submit(item);</span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 发生错误时</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> throwable the exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;处理器，发生错误，错误信息：&quot;</span> + throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 在完成时</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;处理器，订阅结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>设置关系</strong></p>
<p>设置发布者，中间处理器，和订阅者之间的关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line">Flow.Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> <span class="title class_">Flow</span>.Subscriber&lt;&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在订阅时，调用该方法，通过传入订阅关系</span></span><br><span class="line"><span class="comment">     * 订阅关系：发布者和订阅者之间的联系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscription a new subscription</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置本地订阅者，方便后续获取数据</span></span><br><span class="line">        <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;订阅开始了，关系：&quot;</span> + subscription);</span><br><span class="line">        <span class="comment">// 从发布者那获取一条数据，只有获取之后才会给，背压模式</span></span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在下一个数据到来时调用此方法，执行回调，接收到新数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item the item</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(String item)</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，接收到新数据&quot;</span> + item);</span><br><span class="line">        <span class="comment">// 如果传入值等于7则终端订阅，那么也就不会调用onComplete方法</span></span><br><span class="line">        <span class="keyword">if</span> (item.equals(<span class="string">&quot;7&quot;</span>)) subscription.cancel();</span><br><span class="line">        <span class="comment">// 再从发布者那获取一条数据</span></span><br><span class="line">        subscription.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发生错误时</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable the exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，发生错误，错误信息：&quot;</span> + throwable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在完成时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">&quot;订阅者，订阅结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义中间处理器</span></span><br><span class="line"><span class="type">MyProcessor</span> <span class="variable">processor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProcessor</span>();</span><br><span class="line"><span class="type">MyProcessor</span> <span class="variable">processor2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProcessor</span>();</span><br><span class="line"><span class="type">MyProcessor</span> <span class="variable">processor3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProcessor</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行绑定操作</span></span><br><span class="line">publisher.subscribe(processor1);</span><br><span class="line">processor1.subscribe(processor2);</span><br><span class="line">processor2.subscribe(processor3);</span><br><span class="line">processor3.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    publisher.submit(String.valueOf(i));</span><br><span class="line">&#125;</span><br><span class="line">publisher.close();</span><br><span class="line"></span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<p>响应式编程:</p>
<ol>
<li><strong>底层</strong>：基于<strong>数据缓冲队列</strong>+<strong>消息驱动模型</strong>+<strong>异步回调机制</strong></li>
<li><strong>编码</strong>：<strong>流式编程</strong>+<strong>链式调用</strong>+<strong>声明式API</strong></li>
<li><strong>效果</strong>：<strong>优雅全异步</strong> +<strong>消息实时处理</strong> +<strong>高吞吐量</strong>+<strong>占用少量资源</strong></li>
</ol>
<p>解决痛点：</p>
<p>以前要做高并发系统：缓存，异步，队排好，需要我们手动控制整个逻辑</p>
<p>现在：<strong>全自动控制整个逻辑</strong>，我们只需要组装好数据处理流水线即可</p>
<h1 id="reactor"><a class="markdownIt-Anchor" href="#reactor"></a> Reactor</h1>
<p><strong>少量线程一直运行 &gt; 大量线程切换等待</strong></p>
<p><a target="_blank" rel="noopener" href="https://projectreactor.io/">Reactor官网</a></p>
<p>三大核心</p>
<ol>
<li>Reactor Core：Reactor核心，非阻塞线程</li>
<li>两种数据类型：FLUX多数据，MONO（0或1）</li>
<li>非阻塞IO</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241210224313129.png" alt="image-20241210224313129" /></p>
<h2 id="引入依赖"><a class="markdownIt-Anchor" href="#引入依赖"></a> 引入依赖</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.nuyoah<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ReactiveProgramming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>stream<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>reactor<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">reactor-bom.version</span>&gt;</span>2024.0.0<span class="tag">&lt;/<span class="name">reactor-bom.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">reactor-test.version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">reactor-test.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">reactor-core.version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">reactor-core.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;reactor-bom.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;reactor-core.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;reactor-test.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="flux和mono简单应用"><a class="markdownIt-Anchor" href="#flux和mono简单应用"></a> Flux和Mono简单应用</h2>
<p>数据流：每一个元素从流的源头，开始源源不断，自己往下滚动</p>
<p>onNext：当元素到达时需要处理的操作</p>
<p>onComplete：当元素都处理完之后进行的操作</p>
<p>onError：当元素处理出现错误的时候进行的操作</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241210233139562.png" alt="image-20241210233139562" /></p>
<p><strong>一个数据流：元素（0-N） +  结束信号（1：正常/出错）</strong></p>
<p>流经过运算之后（operator）会得到一个新流</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241211212111097.png" alt="image-20241211212111097" /></p>
<h3 id="flux使用"><a class="markdownIt-Anchor" href="#flux使用"></a> Flux使用</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Flux : N个元素的流</span></span><br><span class="line">    Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流只有在消费的时候才会有用，否则没用</span></span><br><span class="line">    just.subscribe(e -&gt; System.out.println(<span class="string">&quot;e1: &quot;</span> + e));</span><br><span class="line">    <span class="comment">// 流可以有多个订阅者</span></span><br><span class="line">    just.subscribe(e -&gt; System.out.println(<span class="string">&quot;e2: &quot;</span> + e));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个可以自增的流，正常情况下不会自己中值</span></span><br><span class="line">    Flux&lt;Long&gt; interval = Flux.interval(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">    interval.subscribe(e -&gt; System.out.println(<span class="string">&quot;interval: &quot;</span> + e));</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 流是异步的，用子线程来进行流的操作，要保证主线程的不能中断</span></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mono使用"><a class="markdownIt-Anchor" href="#mono使用"></a> Mono使用</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// Mono只能有一个元素或零个元素</span></span><br><span class="line">    Mono&lt;Integer&gt; just = Mono.just(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 只有在订阅之后才会有结果</span></span><br><span class="line">    just.subscribe(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="doonxxx的使用"><a class="markdownIt-Anchor" href="#doonxxx的使用"></a> doOnXXX的使用</h3>
<p>在链式API中下面操作会消耗上面流</p>
<ol>
<li>
<p>doOnComplete()</p>
<p>在流中的元素消费结束之后的回调方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).doOnComplete(() -&gt; System.out.println(<span class="string">&quot;Done&quot;</span>));</span><br><span class="line"><span class="comment">// 流只有在消费的时候才会有用，否则没用</span></span><br><span class="line">just.subscribe(e -&gt; System.out.println(<span class="string">&quot;e1: &quot;</span> + e));</span><br></pre></td></tr></table></figure>
<p>在just中的内容消费结束之后会调用输出Done的方法</p>
</li>
<li>
<p>delayElements()</p>
<p>整流操作，将流中的的元素以相同的时间间隔发布出去</p>
<p>当流中的元素的以不规律的方式传入流中的时候，通过整流操作以规整的方式将数据传出去</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241211220347081.png" alt="image-20241211220347081" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .doOnComplete(() -&gt; System.out.println(<span class="string">&quot;Done&quot;</span>))</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// 流只有在消费的时候才会有用，否则没用</span></span><br><span class="line">just.subscribe(e -&gt; System.out.println(<span class="string">&quot;e1: &quot;</span> + e));</span><br></pre></td></tr></table></figure>
<p>订阅的时候元素流动速度是1s一个</p>
</li>
<li>
<p>doOnCancle</p>
<p>当流被取消的时候，调用此方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">Flux&lt;Integer&gt; integerFlux = just.doOnCancel(() -&gt; System.out.println(<span class="string">&quot;Cancelled&quot;</span>));</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>doOnError()</p>
<p>当流出现错误的时候调用此方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                             .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">Flux&lt;Integer&gt; integerFlux = just.doOnError(e -&gt; System.out.println(<span class="string">&quot;Error&quot;</span>));                         </span><br></pre></td></tr></table></figure>
</li>
<li>
<p>doOnNext</p>
<p>当流下一个元素到达时调用此方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">Flux&lt;Integer&gt; integerFlux = just</span><br><span class="line">    .doOnNext(System.out::println);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>doOnEach</p>
<p>处理所有的流中的元素<strong>包括信号</strong>，doOnNext是处理流中的元素<strong>不包括信号</strong></p>
</li>
<li>
<p>doOnRequest</p>
<p>当使用request方法获取流的时候，会调用此方法，<strong>参数为request请求的数量</strong></p>
<p>使用 integerFlux.subscribe(e -&gt; System.out.println(&quot;e1: &quot; + e)); 这种方法的时候，会一次性调用所有的流，request(Long.MAX_VALUE)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux : N个元素的流</span></span><br><span class="line">Flux&lt;Integer&gt; just = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                             .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">Flux&lt;Integer&gt; integerFlux = just.doOnComplete(() -&gt; System.out.println(<span class="string">&quot;Done&quot;</span>))</span><br><span class="line">                                    .doOnError(e -&gt; System.out.println(<span class="string">&quot;Error&quot;</span>))</span><br><span class="line">                                    .doOnRequest(e -&gt; System.out.println(<span class="string">&quot;Request: &quot;</span> + e))</span><br><span class="line">                                    .doOnCancel(() -&gt; System.out.println(<span class="string">&quot;Cancelled&quot;</span>));</span><br><span class="line">integerFlux.subscribe(e -&gt; System.out.println(<span class="string">&quot;e1: &quot;</span> + e));</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>所有的doOn方法都是消耗上面的流</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Integer&gt; integerFlux = just</span><br><span class="line">    .map(intNum -&gt; <span class="number">10</span>/intNum) <span class="comment">// 将just转换成新流</span></span><br><span class="line">    .doOnError(e -&gt; System.out.println(<span class="string">&quot;10除出错&quot;</span>)) <span class="comment">// 消耗map形成的新流</span></span><br><span class="line">    .map(intNum -&gt; <span class="number">100</span>/intNum) <span class="comment">// 在次操作doOnError之后的流，并形成新流</span></span><br><span class="line">    .doOnError(e -&gt; System.out.println(<span class="string">&quot;100除出错&quot;</span>))</span><br><span class="line">    ;    </span><br></pre></td></tr></table></figure>
<h3 id="信号"><a class="markdownIt-Anchor" href="#信号"></a> 信号</h3>
<p>SUBSCRIBE：被订阅</p>
<p>REQUEST：被请求元素</p>
<p>CANCLE：取消订阅的时候</p>
<p>ON_SUBSCRIBE：在订阅的时候</p>
<p>ON_NEXT：在元素到达的时候</p>
<p>ON_ERROR：在发生错误的时候</p>
<p>ON_COMPLETE：在流正常完成的时候</p>
<p>AFTER_TERMINATE：中断以后</p>
<p>CURRENT_CONTEXT：当前的上下文</p>
<p>ON_CONTEXT：感知上下文</p>
<h2 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h2>
<p>使用 .log方法，同样的，log也是只会记录上一个流处理的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Integer&gt; integerFlux = just</span><br><span class="line">    .map(intNum -&gt; <span class="number">10</span>/intNum) <span class="comment">// 将just转换成新流</span></span><br><span class="line">    .log()</span><br><span class="line">    .map(intNum -&gt; <span class="number">100</span>/intNum) <span class="comment">// 在次操作doOnError之后的流，并形成新流</span></span><br><span class="line">    .log()</span><br><span class="line">    ;    </span><br></pre></td></tr></table></figure>
<h2 id="subscribe"><a class="markdownIt-Anchor" href="#subscribe"></a> subscribe</h2>
<p>流只有在被订阅之后，流中的元素才会被处理，只要不被订阅，则流中的元素所设置的操作都不会被执行</p>
<p>subscribe的几种参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241212214823453.png" alt="image-20241212214823453" /></p>
<h3 id="自定义回调方法"><a class="markdownIt-Anchor" href="#自定义回调方法"></a> 自定义回调方法</h3>
<h4 id="subscribe-2"><a class="markdownIt-Anchor" href="#subscribe-2"></a> subscribe()</h4>
<p><strong>空订阅者</strong>，订阅之后对流中的元素没有进行任何操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(1, 10)</span><br><span class="line">                           .map(i -&gt; &#123;</span><br><span class="line">                               return &quot;哈哈： &quot; + i;</span><br><span class="line">                           &#125;);</span><br><span class="line">// 流被订阅，则map中的操作会背执行</span><br><span class="line">flux.subscribe();</span><br></pre></td></tr></table></figure>
<h4 id="subscribeconsumer"><a class="markdownIt-Anchor" href="#subscribeconsumer"></a> subscribe(consumer)</h4>
<p><strong>传入一个消费者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                           .map(i -&gt; &#123;</span><br><span class="line">                               <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">                               System.out.printf(<span class="string">&quot;元素：%s 到达%n&quot;</span>, i);</span><br><span class="line">                               <span class="keyword">return</span> s;</span><br><span class="line">                           &#125;);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">flux.subscribe(n -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;处理元素值：&quot;</span> + n);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>返回值结果，由此可见，当流被订阅的时候，流中的元素会依次进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">元素：<span class="number">1</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">1</span></span><br><span class="line">元素：<span class="number">2</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">2</span></span><br><span class="line">元素：<span class="number">3</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">3</span></span><br><span class="line">元素：<span class="number">4</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">4</span></span><br><span class="line">元素：<span class="number">5</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">5</span></span><br><span class="line">元素：<span class="number">6</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">6</span></span><br><span class="line">元素：<span class="number">7</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">7</span></span><br><span class="line">元素：<span class="number">8</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">8</span></span><br><span class="line">元素：<span class="number">9</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">9</span></span><br><span class="line">元素：<span class="number">10</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">10</span></span><br></pre></td></tr></table></figure>
<h4 id="subscribeconsumer-errorconsumer"><a class="markdownIt-Anchor" href="#subscribeconsumer-errorconsumer"></a> subscribe(consumer, errorConsumer)</h4>
<p><strong>传入一个消费者和一个错误消费者</strong></p>
<p>当流中出现错误的时候可以由errorconsumer来进行处理，也可由doOnerror来进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">                           .map(i -&gt; &#123;</span><br><span class="line">                               <span class="keyword">if</span> (i == <span class="number">3</span>)&#123;</span><br><span class="line">                                   i = <span class="number">10</span> / (i-<span class="number">3</span>);</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">                               System.out.printf(<span class="string">&quot;元素：%s 到达%n&quot;</span>, i);</span><br><span class="line">                               <span class="keyword">return</span> s;</span><br><span class="line">                           &#125;);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">flux.subscribe(</span><br><span class="line">    	n -&gt; System.out.println(<span class="string">&quot;处理元素值：&quot;</span> + n), <span class="comment">// 对流进行操作</span></span><br><span class="line">        throwable -&gt; System.out.println(<span class="string">&quot;出现错误：&quot;</span>+throwable.getMessage()) <span class="comment">// 当出现异常时，由此消费者处理</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>返回结果，当出现错误的时候，错误结果被errorConsumer进行处理，流中值运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">元素：<span class="number">1</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">1</span></span><br><span class="line">元素：<span class="number">2</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">2</span></span><br><span class="line">出现错误：/ by zero</span><br></pre></td></tr></table></figure>
<h4 id="subscribeconsumer-errorconsumer-completeconsumer"><a class="markdownIt-Anchor" href="#subscribeconsumer-errorconsumer-completeconsumer"></a> subscribe(consumer, errorConsumer, completeConsumer)</h4>
<p>传入三个消费者，第一个正常消费，第二个捕获错误信息，第三个捕获完成信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">                           .map(i -&gt; &#123;</span><br><span class="line">                               <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">                               System.out.printf(<span class="string">&quot;元素：%s 到达%n&quot;</span>, i);</span><br><span class="line">                               <span class="keyword">return</span> s;</span><br><span class="line">                           &#125;);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">flux.subscribe(</span><br><span class="line">        n -&gt; System.out.println(<span class="string">&quot;处理元素值：&quot;</span> + n),</span><br><span class="line">        throwable -&gt; System.out.println(<span class="string">&quot;出现错误：&quot;</span>+throwable.getMessage()),</span><br><span class="line">        () -&gt; System.out.println(<span class="string">&quot;流正常结束&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>结果显示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">元素：<span class="number">1</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">1</span></span><br><span class="line">元素：<span class="number">2</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">2</span></span><br><span class="line">元素：<span class="number">3</span> 到达</span><br><span class="line">处理元素值：哈哈： <span class="number">3</span></span><br><span class="line">流正常结束</span><br></pre></td></tr></table></figure>
<h3 id="自定义消费者"><a class="markdownIt-Anchor" href="#自定义消费者"></a> 自定义消费者</h3>
<p>实现<strong>BaseSubscriber</strong>进行消费者的自定义实现</p>
<p><strong>消费者中有各种回调方法</strong></p>
<p>可以实现如下方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241212220444722.png" alt="image-20241212220444722" /></p>
<h4 id="实现自定义消费者basesubscriber"><a class="markdownIt-Anchor" href="#实现自定义消费者basesubscriber"></a> 实现自定义消费者BaseSubscriber</h4>
<p><strong>BaseSubscriber中实现的很多方法方便我们调用，例如request等等</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">                           .map(i -&gt; &#123;</span><br><span class="line">                               <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">                               System.out.printf(<span class="string">&quot;元素：%s 到达%n&quot;</span>, i);</span><br><span class="line">                               <span class="keyword">return</span> s;</span><br><span class="line">                           &#125;);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">flux.subscribe(</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;String&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;开始订阅&quot;</span>);</span><br><span class="line">               request(<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(String value)</span> &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;元素到达&quot;</span> + value);</span><br><span class="line">               request(<span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnComplete</span><span class="params">()</span> &#123;</span><br><span class="line">               <span class="built_in">super</span>.hookOnComplete();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">               <span class="built_in">super</span>.hookOnError(throwable);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnCancel</span><span class="params">()</span> &#123;</span><br><span class="line">               <span class="built_in">super</span>.hookOnCancel();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="取消流"><a class="markdownIt-Anchor" href="#取消流"></a> 取消流</h4>
<p>流可以被消费者使用cancel方法随时取消流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .map(i -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">        System.out.printf(<span class="string">&quot;元素：%s 到达%n&quot;</span>, i);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">flux.subscribe(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;开始订阅&quot;</span>);</span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(String value)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.contains(<span class="string">&quot;2&quot;</span>)) cancel();</span><br><span class="line">            System.out.println(<span class="string">&quot;元素到达&quot;</span> + value);</span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnCancel</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;流被取消了&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="背压backpressure"><a class="markdownIt-Anchor" href="#背压backpressure"></a> 背压（Backpressure）</h2>
<p>是消费者像生产者请求数据的时候，生产者才会给消费者数据，请求一个给一个，请求几个给几个。</p>
<p>好处：虽然生产者多很多数据，但是只有在消费者请求的时候才能给消费者数据，不会因为生产数据过多导致消费者压力过大崩溃</p>
<h2 id="请求重塑reshape-request"><a class="markdownIt-Anchor" href="#请求重塑reshape-request"></a> 请求重塑（Reshape Request）</h2>
<h3 id="buffer"><a class="markdownIt-Anchor" href="#buffer"></a> .buffer</h3>
<p>通过设置缓冲区，将流中的元素进行缓冲区分开，默认缓冲区为1</p>
<p><strong>request(N)：找发布者请求N次数据，总共能得到N*bufferSize个数据</strong></p>
<p>当不使用buffer的时候，我们通过request(1) 是请求了一个数据，当时用buffer之后，我们通过request(1) 是请求了1*buffersize个数据</p>
<p>request3和buffer(3) 不一样，request3表明一次请求三个数据，那么生产者会一次发一条数据，发三次，使用buffer(3)生产者会一次发三个数据发一次。<strong>用doOnNext的话就是第一个触发了三次doOnNext，第二个触发了一次doOnNext</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个流，当流没有被订阅的时候，map中的操作不会被执行</span></span><br><span class="line">Flux&lt;List&lt;String&gt;&gt; buffer = Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .map(i -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;哈哈： &quot;</span> + i;</span><br><span class="line">    &#125;)</span><br><span class="line">    .buffer(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// 流被订阅，则map中的操作会背执行</span></span><br><span class="line">buffer.subscribe(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;List&lt;String&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;开始订阅&quot;</span>);</span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(List&lt;String&gt; value)</span> &#123;</span><br><span class="line">            System.out.println(value);</span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">开始订阅</span><br><span class="line">[哈哈： <span class="number">1</span>, 哈哈： <span class="number">2</span>]</span><br><span class="line">[哈哈： <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<h3 id="limitreatn"><a class="markdownIt-Anchor" href="#limitreatn"></a> .limitReat(N)</h3>
<p>限制请求速率，并且有<strong>预抓取策略</strong>，当设置的请求大小中<strong>已经与75%的数据被消费了之后</strong>，会<strong>自动请求下一个请求速率*75%的元素</strong></p>
<p>发布者发布100个数据，并设置请求速率为10，那么在第一次请求的时候会请求10个，当10个中75%的数据被消费之后，会自动请求下面75%的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .log()</span><br><span class="line">    .limitRate(<span class="number">10</span>) <span class="comment">// 设置请求速率是10个</span></span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.512</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)</span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.522</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | request(<span class="number">10</span>)</span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.523</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.523</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">2</span>)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">3</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">4</span>)</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">5</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">6</span>)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">7</span>)</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.524</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">8</span>)</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.525</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | request(<span class="number">8</span>)  <span class="comment">// 请求已经到75%了，再从新请求75%的数据</span></span><br><span class="line"><span class="number">23</span>:<span class="number">10</span>:<span class="number">20.525</span> [main] INFO reactor.Flux.Range<span class="number">.1</span> -- | onNext(<span class="number">9</span>)</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>buffer是放到缓冲区中request一次请求buffer个数据，limitReat是一次性取设置的速率次数的值，如果buffer是10，limitReat是100，如果不适用限流的话会一次性全部取出，进行限流之后第一次会请求100次一次是buffer大小的数据，从第二次开始实行预抓取策略，请求的次数是设置的75%</p>
<h2 id="编程式创建流"><a class="markdownIt-Anchor" href="#编程式创建流"></a> 编程式创建流</h2>
<p>想通过自定义一系列函数来创建序列，可以有以下几种方式</p>
<h3 id="同步generate"><a class="markdownIt-Anchor" href="#同步generate"></a> 同步generate</h3>
<p>通过设置初始值来开始元素的生成</p>
<p><strong>通过sink的next方法来处理我们需要发布什么数据出去</strong></p>
<p>通过return来决定下一次处理数据的最新状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Object&gt; generate = Flux.generate(</span><br><span class="line">    () -&gt; <span class="number">0</span>,  <span class="comment">// 初始State值</span></span><br><span class="line">    (state, sink) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (state &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            sink.next(state); <span class="comment">// 元素传递</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sink.complete(); <span class="comment">// 完成信号</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">generate.log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h3 id="异步-多线程create"><a class="markdownIt-Anchor" href="#异步-多线程create"></a> 异步-多线程create</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Flux.create(fluxSink -&gt; &#123;</span><br><span class="line">    <span class="type">MyListener</span> <span class="variable">myListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyListener</span>(fluxSink);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        myListener.online(<span class="string">&quot;hh-&quot;</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).subscribe();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FluxSink&lt;Object&gt; fluxSink;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyListener</span><span class="params">(FluxSink&lt;Object&gt; fluxSink)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fluxSink = fluxSink;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">online</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        System.out.println(username+<span class="string">&quot;上线了&quot;</span>);</span><br><span class="line">        fluxSink.next(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义处理方法-handle"><a class="markdownIt-Anchor" href="#自定义处理方法-handle"></a> 自定义处理方法 handle</h3>
<p>在上面的一系列方法中例如 .map, .filter中进行流的中间操作，现在可以使用自定义处理方法来处理操作</p>
<p>**handle和map的区别：**map需要返回值类型必须是统一的，handle没有这个限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="comment">// 自定义处理方法</span></span><br><span class="line">    .handle((value, sink) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;value: &quot;</span> + value);</span><br><span class="line">        <span class="comment">// 自定义处理方法</span></span><br><span class="line">        value = value * <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 将处理后的值进行发布</span></span><br><span class="line">        sink.next(value);</span><br><span class="line">    &#125;)</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h2 id="线程和调度"><a class="markdownIt-Anchor" href="#线程和调度"></a> 线程和调度</h2>
<p>Schedulers.immediate() : 默认线程池</p>
<p>Schedulers.single() ： 创建一个单个线程池</p>
<p>Schedulers.boundedElastic() ： 创建一个多个线程池，线程个数 10*cpu核心数，存活时间60s</p>
<p><strong>使用publishOn切换发布者线程，使用subscribeOn切换接受者线程池</strong></p>
<p>如果不切换线程池的话，上面一些操作默认都是在主线程下执行的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .publishOn(Schedulers.boundedElastic())</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p><strong>只要发布者不指定线程，则默认使用订阅者的线程</strong>，因为流只有在被订阅的时候才会流动。</p>
<h2 id="常用操作"><a class="markdownIt-Anchor" href="#常用操作"></a> 常用操作</h2>
<h3 id="filter-2"><a class="markdownIt-Anchor" href="#filter-2"></a> Filter</h3>
<p>过滤操作，需要返回true或false，false的过滤掉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    .filter(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p>结果只有为偶数的元素流下来了</p>
<p>首先是流被订阅</p>
<p>后来请求无限个元素</p>
<p>最后偶数元素到达</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.918</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onSubscribe([Fuseable] FluxFilterFuseable.FilterFuseableSubscriber)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.923</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | request(unbounded)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onNext(<span class="number">2</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onNext(<span class="number">4</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onNext(<span class="number">6</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onNext(<span class="number">8</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onNext(<span class="number">10</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">24</span>:<span class="number">21.924</span> [main] INFO reactor.Flux.FilterFuseable<span class="number">.1</span> -- | onComplete()</span><br></pre></td></tr></table></figure>
<p>将日志打印在上面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    .log()</span><br><span class="line">    .filter(i -&gt; i % <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p>首先订阅元素</p>
<p>其次是订阅者请求无限个元素</p>
<p>第一个元素到达</p>
<p>filter发现第一个元素无法对3取余，所以请求了下一个元素，第二元素也无法对3取余，filter有请求了一次，直到第三个符合要求，就没有在请求了，<strong>背压模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.507</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onSubscribe([Synchronous Fuseable] FluxArray.ArrayConditionalSubscription)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.512</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | request(unbounded)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.513</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onNext(<span class="number">1</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.513</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | request(<span class="number">1</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onNext(<span class="number">2</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | request(<span class="number">1</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onNext(<span class="number">3</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onNext(<span class="number">4</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | request(<span class="number">1</span>)</span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">24.514</span> [main] INFO reactor.Flux.Array<span class="number">.1</span> -- | onComplete()</span><br></pre></td></tr></table></figure>
<h3 id="flatmap-2"><a class="markdownIt-Anchor" href="#flatmap-2"></a> FlatMap</h3>
<p>将流一个元素转换成多个元素，无序的发往下流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">&quot;zhang san&quot;</span>, <span class="string">&quot;li si&quot;</span>)</span><br><span class="line">        .flatMap(i -&gt; &#123;</span><br><span class="line">            String[] s = i.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Flux.fromArray(s);</span><br><span class="line">        &#125;)</span><br><span class="line">        .log()</span><br><span class="line">        .subscribe();</span><br></pre></td></tr></table></figure>
<p>输入日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.772</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onSubscribe(FluxFlatMap.FlatMapMain)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.777</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- request(unbounded)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.778</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onNext(zhang)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.778</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onNext(san)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.779</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onNext(li)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.779</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onNext(si)</span><br><span class="line"><span class="number">21</span>:<span class="number">48</span>:<span class="number">29.779</span> [main] INFO reactor.Flux.FlatMap<span class="number">.1</span> -- onComplete()</span><br></pre></td></tr></table></figure>
<h3 id="concatmap"><a class="markdownIt-Anchor" href="#concatmap"></a> concatMap</h3>
<p>同样是将一个元素转换成多个元素，但是concatMap是有序的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    .concatMap(i -&gt; Flux.just(i, i*<span class="number">2</span>))</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p><strong>为什么FlatMap是无序的而concatMap是有序的？</strong></p>
<ol>
<li>因为FlatMap是并发处理元素的，当一个元素到达之后，Flat进行元素的处理，不等这个元素处理完flatmap就会请求下一个元素</li>
<li>当第一个元素处理慢，而第二个元素处理快的时候，第二个元素就会优先流往下流，导致顺序出错</li>
</ol>
<h3 id="concat-2"><a class="markdownIt-Anchor" href="#concat-2"></a> concat</h3>
<p>将两个流转换合并成新流，不做任何操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.concat(Flux.range(<span class="number">1</span>, <span class="number">3</span>), Flux.range(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h3 id="concatwith"><a class="markdownIt-Anchor" href="#concatwith"></a> concatWith</h3>
<p>将老流连接上新流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    .concatWith(Flux.just(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h3 id="transform"><a class="markdownIt-Anchor" href="#transform"></a> Transform</h3>
<p>转换流中的数据</p>
<p>将流中的数据整体转换成另一种数据</p>
<p>transform接收的是一个上流传过来的Flux流，将流中的元素进行转换之后，送个下流</p>
<p><strong>一个流的一个Transform只会执行一次</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">Flux&lt;String&gt; transformFlux = Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">                                 .transform(value -&gt; &#123;</span><br><span class="line">                                     System.out.println(<span class="string">&quot;Transform执行了-&quot;</span> + atomic.get());</span><br><span class="line">                                     <span class="keyword">if</span> (atomic.getAndIncrement() == <span class="number">1</span>) &#123;</span><br><span class="line">                                         <span class="keyword">return</span> value.map(String::toUpperCase);</span><br><span class="line">                                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                         <span class="keyword">return</span> value;</span><br><span class="line">                                     &#125;</span><br><span class="line">                                 &#125;);</span><br><span class="line">transformFlux.subscribe(System.out::println);</span><br><span class="line">transformFlux.subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<p>执行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transform执行了-<span class="number">1</span></span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br></pre></td></tr></table></figure>
<h3 id="transformdeferred"><a class="markdownIt-Anchor" href="#transformdeferred"></a> transformDeferred</h3>
<p>同样是将流转换成一个新流，不过是有一个订阅者就会执行一次转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line">Flux&lt;String&gt; transformFlux = Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">    .transformDeferred(value -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Transform执行了-&quot;</span> + atomic.get());</span><br><span class="line">        <span class="keyword">if</span> (atomic.getAndIncrement() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value.map(String::toUpperCase);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">transformFlux.subscribe(System.out::println);</span><br><span class="line">transformFlux.subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<p>执行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Transform执行了-<span class="number">1</span></span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">Transform执行了-<span class="number">2</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<h3 id="empty-2"><a class="markdownIt-Anchor" href="#empty-2"></a> Empty</h3>
<p>发布出一个空元素</p>
<p>如果想要发布出一个空元素，需要使用Empty来进行发布</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Object&gt; empty = Mono.empty();</span><br><span class="line">empty.defaultIfEmpty(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h3 id="defaultifempty"><a class="markdownIt-Anchor" href="#defaultifempty"></a> defaultIfEmpty</h3>
<p>可以判断当流中的元素为空的时候，设置一个默认值</p>
<p><strong>静态兜底方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Object&gt; empty = Mono.empty();</span><br><span class="line">empty.defaultIfEmpty(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p><strong>switchIfEmpty</strong></p>
<p><strong>动态兜底方法</strong></p>
<p>判断流中元素是否为空，如果为空怎调用一个方法来返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">emptyTest</span><span class="params">()</span> &#123;</span><br><span class="line">    Mono&lt;Object&gt; empty = Mono.empty();</span><br><span class="line">    empty.switchIfEmpty(haha())</span><br><span class="line">        .subscribe(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Mono&lt;?&gt; haha() &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.just(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="merge"><a class="markdownIt-Anchor" href="#merge"></a> merge</h3>
<p>将多个流进行合并，并且按照元素发布的时间进行合并</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241219231252652.png" alt="image-20241219231252652" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux.merge(Flux.range(<span class="number">1</span>, <span class="number">3</span>), Flux.range(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="mergewith"><a class="markdownIt-Anchor" href="#mergewith"></a> mergeWith</h3>
<p>将老流合并到新流中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .mergeWith(Flux.range(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="mergesequential"><a class="markdownIt-Anchor" href="#mergesequential"></a> mergeSequential</h3>
<p>按照那个流先发先合并那个</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241219232654006.png" alt="image-20241219232654006" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux.mergeSequential(Flux.range(<span class="number">1</span>, <span class="number">3</span>), Flux.range(<span class="number">3</span>, <span class="number">5</span>))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="zip"><a class="markdownIt-Anchor" href="#zip"></a> zip</h3>
<p>将多个流中的元素进行打包，打包成一个元组</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241219233406701.png" alt="image-20241219233406701" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Flux.zip(Flux.range(<span class="number">1</span>, <span class="number">3</span>), Flux.range(<span class="number">3</span>, <span class="number">5</span>), Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>))</span><br><span class="line">    .map(tuple -&gt; &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">t1</span> <span class="operator">=</span> tuple.getT1();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">t2</span> <span class="operator">=</span> tuple.getT2();</span><br><span class="line">        <span class="type">String</span> <span class="variable">t3</span> <span class="operator">=</span> tuple.getT3();</span><br><span class="line">        <span class="keyword">return</span> t1 + t2 + t3;</span><br><span class="line">    &#125;)</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<h3 id="next"><a class="markdownIt-Anchor" href="#next"></a> next</h3>
<p>直接获取第一个数据，无需通过订阅者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    .next()</span><br><span class="line">    .block();</span><br></pre></td></tr></table></figure>
<h2 id="错误处理"><a class="markdownIt-Anchor" href="#错误处理"></a> 错误处理</h2>
<p>错误是一种中断信息，不是流结束信息</p>
<p>订阅者可以感知流的正确与错误信息</p>
<h3 id="默认"><a class="markdownIt-Anchor" href="#默认"></a> 默认</h3>
<p>在订阅的时候，可以传入三个消费者</p>
<p>流正常时的消费者，流错误时的消费者，流结束时的消费者</p>
<h3 id="onerrorreturn"><a class="markdownIt-Anchor" href="#onerrorreturn"></a> onErrorReturn</h3>
<p><strong>捕获并返回</strong></p>
<p>Catch and return a static default value.</p>
<p>在命令式编程中，以下面这种方式捕获并返回信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> doSomethingDangerous(i); </span><br><span class="line">        <span class="type">String</span> <span class="variable">v2</span> <span class="operator">=</span> doSecondTransform(v1); </span><br><span class="line">        System.out.println(<span class="string">&quot;RECEIVED &quot;</span> + v2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;CAUGHT &quot;</span> + t); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在流式编程中使用<strong>onErrorReturn</strong>方法实现上面的方式</p>
<p><strong>onErrorReturn</strong>无法直接跟在流初始化的后面，需要跟在中间操作后面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">10</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::doSomethingDangerous)</span><br><span class="line">    .onErrorReturn(<span class="string">&quot;RECOVERED&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>特性</strong></p>
<ol>
<li>会捕获处理异常，消费者无异常感知</li>
<li>返回一个默认值</li>
<li>中断流操作，流正常完成</li>
</ol>
<h3 id="onerrorresume"><a class="markdownIt-Anchor" href="#onerrorresume"></a> onErrorResume</h3>
<p><strong>捕获并调用回调方法</strong></p>
<p>在命令式编程中此方法是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  v1 = callExternalService(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">  v1 = getFromCache(<span class="string">&quot;key1&quot;</span>); <span class="comment">// 捕获异常后调用此方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调用回调函数"><a class="markdownIt-Anchor" href="#调用回调函数"></a> 调用回调函数</h4>
<p>Catch and execute an alternative path with a fallback method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::doSomethingDangerousOn30)</span><br><span class="line">    .onErrorResume(err -&gt; Mono.just(<span class="number">40</span>)); </span><br></pre></td></tr></table></figure>
<p><strong>特性</strong></p>
<ol>
<li>可以捕获异常，消费者无感知</li>
<li>当发生异常之后会调用一个自定义方法</li>
<li>流中断，正常返回</li>
</ol>
<h4 id="捕获并根据错误处理"><a class="markdownIt-Anchor" href="#捕获并根据错误处理"></a> 捕获并根据错误处理</h4>
<p>Catch and dynamically compute a fallback value.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::doSomethingDangerousOn30)</span><br><span class="line">    .onErrorResume(err -&gt; handleErrorMethod(error)); </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="onerrormap"><a class="markdownIt-Anchor" href="#onerrormap"></a> onErrorMap</h3>
<h4 id="捕获并抛出自定义异常"><a class="markdownIt-Anchor" href="#捕获并抛出自定义异常"></a> 捕获并抛出自定义异常</h4>
<p><strong>使用onErrorResume+Flux.error</strong>执行该操作</p>
<p>Catch, wrap to a <code>BusinessException</code>, and re-throw.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::doSomethingDangerousOn30)</span><br><span class="line">    .onErrorResume(err -&gt; Flux.error(<span class="keyword">new</span> <span class="title class_">MyException</span>(error))); </span><br></pre></td></tr></table></figure>
<p><strong>消费者会感知到异常</strong></p>
<p>使用<strong>onErrorMap来执行该操作</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::doSomethingDangerousOn30)</span><br><span class="line">    .onErrorMap(err -&gt; <span class="keyword">new</span> <span class="title class_">MyException</span>(error)); </span><br></pre></td></tr></table></figure>
<p><strong>特点</strong></p>
<ol>
<li>捕获异常</li>
<li>抛出新异常</li>
<li>消费者有感知</li>
<li>流异常结束</li>
</ol>
<h3 id="doonerror"><a class="markdownIt-Anchor" href="#doonerror"></a> doOnError</h3>
<p>Catch, log an error-specific message, and re-throw.</p>
<p><strong>捕获异常并且对异常进行记录</strong>，消费者有感知</p>
<p>在命令式编程中实现方法如此</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> callExternalService(k);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (RuntimeException error) &#123;</span><br><span class="line">  <span class="comment">//make a record of the error</span></span><br><span class="line">  log(<span class="string">&quot;uh oh, falling back, service failed for key &quot;</span> + k);</span><br><span class="line">  <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在响应式编程中实现方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::myMethod)</span><br><span class="line">    .doOnError(error -&gt; &#123;</span><br><span class="line">        log.error(<span class="string">&quot;感知到异常&quot;</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p><strong>特点</strong></p>
<ol>
<li>捕获异常，并做一些自己的事情</li>
<li>将异常继续向下抛出</li>
<li>不吃掉异常，只感知异常</li>
</ol>
<h3 id="dofinally"><a class="markdownIt-Anchor" href="#dofinally"></a> doFinally</h3>
<p>Use the <code>finally</code> block to clean up resources or a Java 7 “try-with-resource” construct.</p>
<p><strong>无论是流正常结束还是异常结束都会执行doFinally里面的方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::myMethod)</span><br><span class="line">    .doFinally(<span class="built_in">this</span>::myMethod)</span><br></pre></td></tr></table></figure>
<h3 id="onerrorcontinue"><a class="markdownIt-Anchor" href="#onerrorcontinue"></a> onErrorContinue</h3>
<p><strong>当异常出现的时候处理异常并继续执行</strong>，不会中断流的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    .map(<span class="built_in">this</span>::myMethod)</span><br><span class="line">    .onErrorContinue((err, value) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;error = &quot;</span> + err);</span><br><span class="line">        System.out.println(<span class="string">&quot;value = &quot;</span> + value);</span><br><span class="line">        log.error(<span class="string">&quot;发现&#123;&#125;有问题，并继续执行&quot;</span>, value);</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="onerrorstop"><a class="markdownIt-Anchor" href="#onerrorstop"></a> onErrorStop</h3>
<p>当发生错误的时候从源头中断流</p>
<p>一个流有多个订阅者，如果其中一个使用了onErrorStop之后并且发生异常了，那么其他正常的订阅者也会被停止。</p>
<p>如果不适用该操作，那么其中一个出现错误了，其他的不会被停止</p>
<h3 id="onerrorcomplete"><a class="markdownIt-Anchor" href="#onerrorcomplete"></a> onErrorComplete</h3>
<p>将流错误信号转换成正常结束信号，<strong>也会中断流</strong></p>
<h2 id="超时and重试"><a class="markdownIt-Anchor" href="#超时and重试"></a> 超时And重试</h2>
<p>设置超时时间，如果流在规定的超时时间内无法到达下流，则会异常</p>
<p><strong>timeout</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">    .onErrorResume(err -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;超时啦&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    &#125;)</span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<p>设置重试机制</p>
<p><strong>retry</strong>重试的时候会将流中的元素从头到尾重新请求一遍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">2</span>))</span><br><span class="line">    .retry(<span class="number">3</span>) <span class="comment">// 将流中的元素从头到尾重新请求最多3次</span></span><br><span class="line">    .log()</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>
<h2 id="sinks工具类"><a class="markdownIt-Anchor" href="#sinks工具类"></a> Sinks工具类</h2>
<p>Sinks 数据管道，所有数据都是顺着这个管道向下走</p>
<h3 id="many"><a class="markdownIt-Anchor" href="#many"></a> many</h3>
<p>发送Flux数据</p>
<h4 id="unicast"><a class="markdownIt-Anchor" href="#unicast"></a> unicast</h4>
<p>单播，只有一条管道，<strong>只能绑定一个消费者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个Sinks对象</span></span><br><span class="line">Sinks.Many&lt;Object&gt; many = Sinks.many()</span><br><span class="line">    .unicast()</span><br><span class="line">    .onBackpressureBuffer();</span><br><span class="line"><span class="comment">// 向Sinks中存放数据</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        many.tryEmitNext(<span class="string">&quot;a-&quot;</span>+i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Sinks转换成Flux对象并订阅</span></span><br><span class="line">many.asFlux().subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<p>如果上述Sinks创建的对象被多个订阅者订阅的话会报错</p>
<p><strong>默认订阅者是从订阅开始的时候开始接受元素</strong></p>
<h4 id="multicast"><a class="markdownIt-Anchor" href="#multicast"></a> multicast</h4>
<p>多播模式可以被多个订阅者订阅</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;Object&gt; many = Sinks.many()</span><br><span class="line">    .multicast().onBackpressureBuffer();</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        many.tryEmitNext(<span class="string">&quot;a-&quot;</span>+i);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line">many.asFlux().subscribe(a -&gt; System.out.println(<span class="string">&quot;v1-&quot;</span> + a));</span><br><span class="line"></span><br><span class="line">many.asFlux().subscribe(a -&gt; System.out.println(<span class="string">&quot;v2-&quot;</span> + a));</span><br></pre></td></tr></table></figure>
<h4 id="replay"><a class="markdownIt-Anchor" href="#replay"></a> replay</h4>
<p>重放，使用该方法会让管道能够重放，<strong>是否给后来的订阅者发送之前发送过的数据</strong>。</p>
<p><strong>底层：用队列存放之前发送过的数据</strong></p>
<p>用来判断订阅者接受订阅之后发送的数据，还是可以接受订阅之前发送的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;Object&gt; many = Sinks.many()</span><br><span class="line">    .replay()</span><br><span class="line">    .limit(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        many.tryEmitNext(<span class="string">&quot;a-&quot;</span>+i);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line">many.asFlux().subscribe(a -&gt; System.out.println(<span class="string">&quot;v1-&quot;</span> + a));</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    many.asFlux().subscribe(a -&gt; System.out.println(<span class="string">&quot;v2-&quot;</span> + a));</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出结果</p>
<p>从第五秒开始一下订阅之前发过的三个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">v1-a-<span class="number">0</span></span><br><span class="line">v1-a-<span class="number">1</span></span><br><span class="line">v1-a-<span class="number">2</span></span><br><span class="line">v1-a-<span class="number">3</span></span><br><span class="line">v1-a-<span class="number">4</span></span><br><span class="line">v2-a-<span class="number">2</span> <span class="comment">// </span></span><br><span class="line">v2-a-<span class="number">3</span></span><br><span class="line">v2-a-<span class="number">4</span></span><br><span class="line">v1-a-<span class="number">5</span></span><br><span class="line">v2-a-<span class="number">5</span></span><br><span class="line">v1-a-<span class="number">6</span></span><br><span class="line">v2-a-<span class="number">6</span></span><br><span class="line">v1-a-<span class="number">7</span></span><br><span class="line">v2-a-<span class="number">7</span></span><br><span class="line">v1-a-<span class="number">8</span></span><br><span class="line">v2-a-<span class="number">8</span></span><br><span class="line">v1-a-<span class="number">9</span></span><br><span class="line">v2-a-<span class="number">9</span></span><br></pre></td></tr></table></figure>
<h3 id="cache-缓存数据"><a class="markdownIt-Anchor" href="#cache-缓存数据"></a> cache 缓存数据</h3>
<p>缓存发布的信息，不设置缓存信息，默认缓存所有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Integer&gt; integerFlux = Flux.range(<span class="number">1</span>, <span class="number">15</span>)</span><br><span class="line">    .delayElements(Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .cache(<span class="number">1</span>);</span><br><span class="line">integerFlux.subscribe(a -&gt; System.out.println(<span class="string">&quot;v1-&quot;</span> + a));</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">9000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    integerFlux.subscribe(a -&gt; System.out.println(<span class="string">&quot;v2-&quot;</span> + a));</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<h3 id="block-阻塞获取"><a class="markdownIt-Anchor" href="#block-阻塞获取"></a> block 阻塞获取</h3>
<p>阻塞，<strong>当想要拿到Flux流中的数据的时候可以使用block来获取</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; block = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .map(i -&gt; i + <span class="number">10</span>)</span><br><span class="line">    .collectList() <span class="comment">// 将流转换成数据</span></span><br><span class="line">    .block(); <span class="comment">// 阻塞获取所有的数据</span></span><br><span class="line">System.out.println(block);</span><br></pre></td></tr></table></figure>
<h3 id="parallel-并发线程"><a class="markdownIt-Anchor" href="#parallel-并发线程"></a> parallel 并发线程</h3>
<p>有1000000哥数据，现在想要通过8个线程来处理操作，每个线程处理100个数据，直到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; block = Flux.range(<span class="number">1</span>, <span class="number">1000000</span>)</span><br><span class="line">    .buffer(<span class="number">10</span>)</span><br><span class="line">    .parallel(<span class="number">8</span>)</span><br><span class="line">    .runOn(Schedulers.newParallel(<span class="string">&quot;yy&quot;</span>))</span><br><span class="line">    .flatMap(Flux::fromIterable)</span><br><span class="line">    .collectSortedList(Integer::compareTo)</span><br><span class="line">    .block();</span><br></pre></td></tr></table></figure>
<h3 id="context"><a class="markdownIt-Anchor" href="#context"></a> Context</h3>
<p><strong>设置上下文操作</strong>，通过设置COntext中的内容，让上流够拿到下流中的参数，上流能够拿到下流中的最近一次的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">    .transformDeferredContextual((flux, context) -&gt; &#123;</span><br><span class="line">        System.out.println(flux); <span class="comment">// 上流传下来的数据</span></span><br><span class="line">        System.out.println(context); <span class="comment">// 下流传上来的数据</span></span><br><span class="line">        <span class="keyword">return</span> flux.map(i -&gt; i + <span class="string">&quot;====&quot;</span> + context.get(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">    &#125;)</span><br><span class="line">    .contextWrite(Context.of(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;haha&quot;</span>))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>
<p>因为在响应式编程中，整体的流程有所改变，所以需要通过设置上下文的方式来进行参数的传递</p>
<p>在响应式编程中，先是通过DAO层获取数据，Service层定于DAO层获取的数据，最后Controller层订阅Service处理的数据，最后返回给前端</p>
<p>在这个过程中，DAO作为资源发布者，从数据库中读取数据，最后经过一系列处理操作，返回个前台</p>
<p>以前：<strong>浏览器</strong> —&gt;  <strong>Controller</strong> ----&gt; <strong>Service</strong> —&gt;  <strong>Dao</strong></p>
<p>现在：<strong>DAO</strong> ----&gt; <strong>Service</strong> ----&gt; <strong>Controller</strong> ----&gt; <strong>浏览器</strong></p>
<h1 id="webflux"><a class="markdownIt-Anchor" href="#webflux"></a> WebFlux</h1>
<p>底层基于Netty+reactor+SpringWeb完成一个全异步非阻塞的<strong>web响应式框架</strong></p>
<p>底层：异步 + 消息队列 + 事件回调 = 整套系统</p>
<p>优点：使用少量资源处理大量请求</p>
<h2 id="组件对比"><a class="markdownIt-Anchor" href="#组件对比"></a> 组件对比</h2>
<table>
<thead>
<tr>
<th style="text-align:center">API功能</th>
<th style="text-align:center">Servlet-阻塞式Web</th>
<th style="text-align:center">WebFlux-响应式Web</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">前端控制器</td>
<td style="text-align:center">DispatcherServlet</td>
<td style="text-align:center">DispatcherHandler</td>
</tr>
<tr>
<td style="text-align:center">处理器</td>
<td style="text-align:center">Controller</td>
<td style="text-align:center">WebHandler/Controller</td>
</tr>
<tr>
<td style="text-align:center">请求/响应</td>
<td style="text-align:center">ServletRequest/ServletResponse</td>
<td style="text-align:center">ServletWebExchange：ServerRequest/ServerResponse</td>
</tr>
<tr>
<td style="text-align:center">过滤器</td>
<td style="text-align:center">Filter(HttpFilter)</td>
<td style="text-align:center">WebFilter</td>
</tr>
<tr>
<td style="text-align:center">异常处理器</td>
<td style="text-align:center">HandlerExceptionResolver</td>
<td style="text-align:center">DispatchExceptionHandler</td>
</tr>
<tr>
<td style="text-align:center">Web配置</td>
<td style="text-align:center">@EnableWebMvc</td>
<td style="text-align:center">@EnableWebFlux</td>
</tr>
<tr>
<td style="text-align:center">自定义配置</td>
<td style="text-align:center">WebMvcConfigurer</td>
<td style="text-align:center">WebFluxConfigurer</td>
</tr>
<tr>
<td style="text-align:center">返回结果</td>
<td style="text-align:center">任意</td>
<td style="text-align:center">Mono，Flux，任意</td>
</tr>
<tr>
<td style="text-align:center">返送Rest请求</td>
<td style="text-align:center">RestTemplate</td>
<td style="text-align:center">WebClient</td>
</tr>
</tbody>
</table>
<h2 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h2>
<h3 id="引入依赖-2"><a class="markdownIt-Anchor" href="#引入依赖-2"></a> 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h3>
<p>在这个里面，返回值为List类型用Flux返回， 返回值为实体类型的用Mono接受</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> CustomerRepository customerRepository;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">MyRestController</span><span class="params">(UserRepository userRepository, CustomerRepository customerRepository)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.userRepository = userRepository;</span><br><span class="line">		<span class="built_in">this</span>.customerRepository = customerRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/&#123;userId&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.userRepository.findById(userId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/&#123;userId&#125;/customers&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Flux&lt;Customer&gt; <span class="title function_">getUserCustomers</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.userRepository.findById(userId).flatMapMany(<span class="built_in">this</span>.customerRepository::findByUser);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@DeleteMapping(&quot;/&#123;userId&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.userRepository.deleteById(userId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="流程转换"><a class="markdownIt-Anchor" href="#流程转换"></a> 流程转换</h3>
<p>以前：<strong>浏览器</strong> —&gt;  <strong>Controller</strong> ----&gt; <strong>Service</strong> —&gt;  <strong>Dao</strong></p>
<p>现在：<strong>DAO</strong> ----&gt; <strong>Service</strong> ----&gt; <strong>Controller</strong> ----&gt; <strong>浏览器</strong></p>
<h2 id="处理流程"><a class="markdownIt-Anchor" href="#处理流程"></a> 处理流程</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 自己创建一个能处理Http请求的处理器</span></span><br><span class="line"><span class="comment">         * 参数：请求， 相应</span></span><br><span class="line"><span class="comment">         * 返回值： Mono&lt;void&gt; 代表处理完成信号</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="type">HttpHandler</span> <span class="variable">httpHandler</span> <span class="operator">=</span> (serverHttpRequest, serverHttpResponse) -&gt; &#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serverHttpRequest.getURI();</span><br><span class="line">        System.out.println(uri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//            serverHttpResponse.getCookies();</span></span><br><span class="line">        <span class="comment">//            serverHttpResponse.getHeaders();</span></span><br><span class="line">        <span class="comment">//            serverHttpResponse.getStatusCode();</span></span><br><span class="line">        <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 启动一个服务器，监听8080端口，接收数据，拿到数据之后交给Handler处理数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ReactorHttpHandlerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReactorHttpHandlerAdapter</span>(httpHandler);</span><br><span class="line">    HttpServer.create()</span><br><span class="line">        .host(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">        .port(<span class="number">8080</span>)</span><br><span class="line">        .handle(adapter)</span><br><span class="line">        .bindNow();</span><br><span class="line"></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="简化开发"><a class="markdownIt-Anchor" href="#简化开发"></a> 简化开发</h3>
<p>在Webflux开发中SpringBoot中的开放方式基本支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/aa&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">aa</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/bb&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">bb</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;bb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;cc&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">cc</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.just(<span class="string">&quot;c1&quot;</span>, <span class="string">&quot;c2&quot;</span>, <span class="string">&quot;c3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sse&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">sse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">                       .map(i -&gt; <span class="string">&quot;sse-&quot;</span>+i)</span><br><span class="line">                       .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="sse"><a class="markdownIt-Anchor" href="#sse"></a> SSE</h3>
<p><strong>ServerSendEvent</strong></p>
<p>完整的处理流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/sse&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;ServerSendEvent&lt;String&gt;&gt; <span class="title function_">sse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.range(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">        .map(i -&gt; &#123;</span><br><span class="line">            <span class="comment">// 构建ServerSendEvent</span></span><br><span class="line">            <span class="keyword">return</span> ServerSendEvent.builder(<span class="string">&quot;ha-&quot;</span>+i) <span class="comment">// 设置数据</span></span><br><span class="line">                .id(i + <span class="string">&quot;&quot;</span>)  <span class="comment">// 设置ID</span></span><br><span class="line">                .comment(<span class="string">&quot;hei-&quot;</span>+i) <span class="comment">// 设置评论</span></span><br><span class="line">                .event(<span class="string">&quot;haha&quot;</span>) <span class="comment">// 设置事件</span></span><br><span class="line">                .build(); <span class="comment">// 建立操作 </span></span><br><span class="line">        &#125;)</span><br><span class="line">        .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>SSE和webSocket的区别：</strong></p>
<ol>
<li>SSE是单通道，只能后端持续的给前台发送数据</li>
<li>webSocket是多通道，后端可以给前台发送数据，前台也能够给后台发送数据</li>
</ol>
<h2 id="dispatcherhandler"><a class="markdownIt-Anchor" href="#dispatcherhandler"></a> DispatcherHandler</h2>
<p>包含三个处理器</p>
<p><strong>HandlerMapping：请求映射处理器</strong>，保存每个请求由那个方法进行处理</p>
<p><strong>HandlerAdapter：处理适配器</strong>，反射执行目标方法</p>
<p><strong>HandlerResultHandler：处理器结果处理器</strong></p>
<p><strong>对比</strong></p>
<ol>
<li>
<p>SpringMVc：DispatcherServlet 有一个 doDispatch() 方法，来处理所有请求;</p>
</li>
<li>
<p>WebFlux：DispatcherHandler 有一个 handle(） 方法，来处理所有请求;</p>
</li>
</ol>
<h3 id="handle源码"><a class="markdownIt-Anchor" href="#handle源码"></a> handle源码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">handle</span><span class="params">(ServerWebExchange exchange)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.createNotFoundError();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CorsUtils.isPreFlightRequest(exchange.getRequest()) ? <span class="built_in">this</span>.handlePreFlight(exchange) : Flux.fromIterable(<span class="built_in">this</span>.handlerMappings)</span><br><span class="line">            .concatMap((mapping) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> mapping.getHandler(exchange);</span><br><span class="line">            &#125;)</span><br><span class="line">            .next()</span><br><span class="line">            .switchIfEmpty(<span class="built_in">this</span>.createNotFoundError())</span><br><span class="line">            .onErrorResume((ex) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.handleResultMono(exchange, Mono.error(ex));</span><br><span class="line">            &#125;)</span><br><span class="line">            .flatMap((handler) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.handleRequestWith(exchange, handler);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;R&gt; Mono&lt;R&gt; <span class="title function_">createNotFoundError</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.defer(() -&gt; &#123;  </span><br><span class="line">        <span class="type">Exception</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseStatusException</span>(HttpStatus.NOT_FOUND);</span><br><span class="line">        <span class="keyword">return</span> Mono.error(ex);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">handleRequestWith</span><span class="params">(ServerWebExchange exchange, Object handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtils.nullSafeEquals(exchange.getResponse().getStatusCode(), HttpStatus.FORBIDDEN)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.handlerAdapters != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> <span class="built_in">this</span>.handlerAdapters.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">                <span class="type">HandlerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> (HandlerAdapter)var3.next();</span><br><span class="line">                <span class="keyword">if</span> (adapter.supports(handler)) &#123;</span><br><span class="line">                    Mono&lt;HandlerResult&gt; resultMono = adapter.handle(exchange, handler);</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.handleResultMono(exchange, resultMono);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No HandlerAdapter: &quot;</span> + handler));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>所有的请求和相应都封装在ServerWebExchange对象中，通过handle方法进行处理</li>
<li>首先如果没有任何请求映射器，则直接返回错误信息，新建一个错误信息并返回
<ol>
<li>通过Mono.deffer方式创建一个错误对象，直到流被订阅的时候才会实例化错误对象</li>
<li>如果不适用Mono.deffer方法将操作进行封装，那么在返回Mono.error错误对象的时候，都会新建一个ResponseStatusException对象，这就会导致，流还没有被订阅的时候，错误对象已经创建出来了</li>
<li>通过使用Differ创建的错误流，只有在流由订阅者，并且流被激活的时候才会动态调用此方法，延迟加载</li>
</ol>
</li>
<li>最后通过三元表达式，来判断是否是跨域请求，如果是跨域请求则需要预检查</li>
<li>Flux流式操作，先找到HandlerMapping，在获取handlerMapping，通过调用Adapter处理请求，期间的错误由onErrorResume处理
<ol>
<li>通过concatMap获取那个Mapping能够处理该请求</li>
<li>通过next获取第一个能处理该请求的handler，如果是空则将流抛出异常，通过异常处理方法处理此异常</li>
<li>如果没有错误则通用handleRequestWith处理此请求</li>
</ol>
</li>
</ol>
<h3 id="核心"><a class="markdownIt-Anchor" href="#核心"></a> 核心</h3>
<p>handleRequestWith 和 handlerResult</p>
<p>handleRequestWith：编写了handlerAdapters怎么处理请求</p>
<p>handleResultMono：处理结果</p>
<h2 id="注解开发"><a class="markdownIt-Anchor" href="#注解开发"></a> 注解开发</h2>
<h3 id="目标方法传参"><a class="markdownIt-Anchor" href="#目标方法传参"></a> 目标方法传参</h3>
<table>
<thead>
<tr>
<th style="text-align:center">Controller参数</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>ServerWebExchange</code></td>
<td style="text-align:center">封装了请求和相应</td>
</tr>
<tr>
<td style="text-align:center"><code>ServerHttpRequest</code>, <code>ServerHttpResponse</code></td>
<td style="text-align:center">请求和相应</td>
</tr>
<tr>
<td style="text-align:center"><code>WebSession</code></td>
<td style="text-align:center">可以访问Session对象</td>
</tr>
<tr>
<td style="text-align:center">org.springframework.http.HttpMethod</td>
<td style="text-align:center">获取请求方法，post，get</td>
</tr>
<tr>
<td style="text-align:center"><code>@PathVariable</code></td>
<td style="text-align:center">路径参数标注点</td>
</tr>
<tr>
<td style="text-align:center"><code>@RequestParam</code></td>
<td style="text-align:center">请求参数</td>
</tr>
<tr>
<td style="text-align:center">`@RequestHeader</td>
<td style="text-align:center">获取请求头</td>
</tr>
<tr>
<td style="text-align:center"><code>@CookieValue</code></td>
<td style="text-align:center">获取Cookie值</td>
</tr>
<tr>
<td style="text-align:center"><code>@RequestBody</code></td>
<td style="text-align:center">获取请求体中包含的数据</td>
</tr>
<tr>
<td style="text-align:center"><code>HttpEntity&lt;B&gt;</code></td>
<td style="text-align:center">获取请求头和请求体</td>
</tr>
<tr>
<td style="text-align:center"><code>@RequestPart</code></td>
<td style="text-align:center">获取文件上传数据 multipart/from-data</td>
</tr>
<tr>
<td style="text-align:center"><code>java.util.Map</code> or <code>org.springframework.ui.Model</code></td>
<td style="text-align:center">For access to the model that is used in HTML controllers and is exposed to templates as part of view rendering.</td>
</tr>
<tr>
<td style="text-align:center"><code>Errors</code> or <code>BindingResult</code></td>
<td style="text-align:center">数据校验</td>
</tr>
<tr>
<td style="text-align:center"><code>@SessionAttribute</code></td>
<td style="text-align:center">获取Session对象</td>
</tr>
<tr>
<td style="text-align:center"><code>@RequestAttribute</code></td>
<td style="text-align:center">获取转发请求</td>
</tr>
</tbody>
</table>
<h3 id="返回值写法"><a class="markdownIt-Anchor" href="#返回值写法"></a> 返回值写法</h3>
<table>
<thead>
<tr>
<th style="text-align:center">Controller返回值</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>@ResponseBody</code></td>
<td style="text-align:center">将相应的数据写出去，如果是对象则自动转换成JSON</td>
</tr>
<tr>
<td style="text-align:center"><code>HttpEntity&lt;B&gt;</code>, <code>ResponseEntity&lt;B&gt;</code></td>
<td style="text-align:center">支持快捷自定义相应内容</td>
</tr>
<tr>
<td style="text-align:center"><code>HttpHeaders</code></td>
<td style="text-align:center">没有响应体只有相应头</td>
</tr>
<tr>
<td style="text-align:center"><code>ErrorResponse</code></td>
<td style="text-align:center">快速构建错误相应</td>
</tr>
<tr>
<td style="text-align:center"><code>ProblemDetail</code></td>
<td style="text-align:center">To render an RFC 9457 error response with details in the body, see <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/web/webflux/ann-rest-exceptions.html">Error Responses</a></td>
</tr>
<tr>
<td style="text-align:center"><code>String</code></td>
<td style="text-align:center">返回字符串可以被视图解析器处理</td>
</tr>
<tr>
<td style="text-align:center"><code>View</code></td>
<td style="text-align:center">返回视图对象</td>
</tr>
<tr>
<td style="text-align:center"><code>Rendering</code></td>
<td style="text-align:center">也是一种视图对象</td>
</tr>
<tr>
<td style="text-align:center"><code>FragmentsRendering</code>, <code>Flux&lt;Fragment&gt;</code>, <code>Collection&lt;Fragment&gt;</code></td>
<td style="text-align:center">For rendering one or more fragments each with its own view and model. See <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/web/webflux-view.html#webflux-view-fragments">HTML Fragments</a> for more details.</td>
</tr>
<tr>
<td style="text-align:center"><code>void</code></td>
<td style="text-align:center">仅代表相应完成</td>
</tr>
<tr>
<td style="text-align:center"><code>Flux&lt;ServerSentEvent&gt;</code>, <code>Observable&lt;ServerSentEvent&gt;</code>, or other reactive type</td>
<td style="text-align:center">使用<code>text/event-stream</code>完成SSE效果</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/entity&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">entity</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity</span><br><span class="line">        .status(<span class="number">200</span>)</span><br><span class="line">        .contentType(MediaType.TEXT_EVENT_STREAM)</span><br><span class="line">        .body(<span class="string">&quot;hhh&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/baidu&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Rendering <span class="title function_">baidu</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Rendering.redirectTo(<span class="string">&quot;http://www.baidu.com&quot;</span>).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件上传"><a class="markdownIt-Anchor" href="#文件上传"></a> 文件上传</h3>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/web/webflux/controller/ann-methods/multipart-forms.html">Multipart Content :: Spring Framework</a></p>
<p>以前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyForm</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> MultipartFile file;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;/form&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">handleFormUpload</span><span class="params">(MyForm form, BindingResult errors)</span> &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在：<strong>通过Filepart来获取上传文件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handle</span><span class="params">(<span class="meta">@RequestPart(&quot;meta-data&quot;)</span> Part metadata, </span></span><br><span class="line"><span class="params">		<span class="meta">@RequestPart(&quot;file-data&quot;)</span> FilePart file)</span> &#123; </span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="错误处理-2"><a class="markdownIt-Anchor" href="#错误处理-2"></a> 错误处理</h3>
<p><strong>ErrorResponse</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/error&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ErrorResponse <span class="title function_">errorResponse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RuntimeException</span> <span class="variable">runtimeException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">    <span class="keyword">return</span> ErrorResponse.builder(runtimeException, HttpStatusCode.valueOf(<span class="number">500</span>), <span class="string">&quot;hhh&quot;</span>)</span><br><span class="line">                   .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义webflux配置"><a class="markdownIt-Anchor" href="#自定义webflux配置"></a> 自定义WebFlux配置</h3>
<p>通过创建config类，实现WebFluxConfigurer类的自动装配</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20241224231228219.png" alt="image-20241224231228219" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebFluxConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebFluxConfigurer <span class="title function_">webFluxConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebFluxConfigurer</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">               <span class="comment">// 配置跨域设置</span></span><br><span class="line">               registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                       .allowedOrigins(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                       .allowedMethods(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                       .allowedOrigins(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="filter过滤器"><a class="markdownIt-Anchor" href="#filter过滤器"></a> Filter过滤器</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;请求到目标方法执勤啊&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange)</span><br><span class="line">                .doFinally(signalType -&gt; System.out.println(<span class="string">&quot;请求完目标方法之后&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="rdbc"><a class="markdownIt-Anchor" href="#rdbc"></a> RDBC</h1>
<p><a target="_blank" rel="noopener" href="https://r2dbc.io/">R2DBC官网</a></p>
<h2 id="用例"><a class="markdownIt-Anchor" href="#用例"></a> 用例</h2>
<h3 id="引入依赖-3"><a class="markdownIt-Anchor" href="#引入依赖-3"></a> 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.asyncer/r2dbc-mysql --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.asyncer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="代码"><a class="markdownIt-Anchor" href="#代码"></a> 代码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 建立Mysql工厂连接配置项</span></span><br><span class="line">    <span class="type">MySqlConnectionConfiguration</span> <span class="variable">mySqlConnectionConfiguration</span> <span class="operator">=</span> MySqlConnectionConfiguration.builder()</span><br><span class="line">        .password(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">        .database(<span class="string">&quot;db2024&quot;</span>)</span><br><span class="line">        .host(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">// 创建连接工厂</span></span><br><span class="line">    <span class="type">MySqlConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> MySqlConnectionFactory.from(mySqlConnectionConfiguration);</span><br><span class="line">    <span class="comment">// 通过连接工厂获取发布者信息，并通过MONO包装成流</span></span><br><span class="line">    Mono.from(connectionFactory.create())</span><br><span class="line">        .flatMapMany(connection -&gt; connection.createStatement(<span class="string">&quot;select * from security_user where id like ?id&quot;</span>)</span><br><span class="line">                     .bind(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;%1%&quot;</span>)</span><br><span class="line">                     .execute())</span><br><span class="line">        .flatMap(result -&gt; result.map(readable -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> readable.get(<span class="string">&quot;id&quot;</span>, String.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> readable.get(<span class="string">&quot;username&quot;</span>, String.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> readable.get(<span class="string">&quot;password&quot;</span>, String.class);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, username, password);</span><br><span class="line">        &#125;))</span><br><span class="line">        .subscribe(System.out::println);</span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="优势"><a class="markdownIt-Anchor" href="#优势"></a> 优势</h3>
<p>在传统的JDBC中如果我们通过分页查询数据的时候，查询第一页就发送一条SQL，建立一个链接，获取数据，关闭链接</p>
<p>在R2dbc中我们一共建立一个链接，并且不会关闭，通过take获取数据，获取几个数据，数据库就返回几个数据，不用频繁查询，构建连接</p>
<h2 id="整合springboot"><a class="markdownIt-Anchor" href="#整合springboot"></a> 整合SpringBoot</h2>
<h3 id="引入依赖-4"><a class="markdownIt-Anchor" href="#引入依赖-4"></a> 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--响应式Spring Data R2dbc--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--响应式WEB--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="整合配置"><a class="markdownIt-Anchor" href="#整合配置"></a> 整合配置</h3>
<ol>
<li>R2dbcAutoConfiguration：主要提供了连接工厂，连接池等操作</li>
<li>R2dbcDataAutoConfiguration：主要提供了r2dbcEntityTemplate 可以进行CRUD操作
<ul>
<li>r2dbcEntityTemplate ，操作数据的响应式客户端，提供CRUD</li>
<li>数据类型映射关系，转换器，自定义r2dbcCustomConversions 转换器组件</li>
<li>数据类型转换：VARCHAR -&gt; String等操作</li>
</ul>
</li>
<li>R2dbcRepositoriesAutoConfiguration：开启Spring Data声明式接口方式CRUD
<ul>
<li>例如Mybatis-Plus：提供了BaseMapper和IService等，自带了CRUD操作</li>
<li>Spring data：提供了CRUD接口，不用写任何实现类的情况下，可直接具备CRUD操作</li>
</ul>
</li>
</ol>
<h2 id="r2dbcentitytemplate"><a class="markdownIt-Anchor" href="#r2dbcentitytemplate"></a> R2dbcEntityTemplate</h2>
<p>QBC：Query By Criteria</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R2DbcTest</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用情况很少，几乎不用，可以查看文档</span></span><br><span class="line"><span class="comment">     * https://docs.spring.io/spring-data/relational/reference/r2dbc/getting-started.html</span></span><br><span class="line"><span class="comment">     * 缺点：join操作不好做</span></span><br><span class="line"><span class="comment">     * 单表用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> R2dbcEntityTemplate r2dbcEntityTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">r2dbcEntityTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.empty()</span><br><span class="line">            .and(<span class="string">&quot;id&quot;</span>).is(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(criteria);</span><br><span class="line">        r2dbcEntityTemplate.select(query, User.class)</span><br><span class="line">            .subscribe(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="databaseclient"><a class="markdownIt-Anchor" href="#databaseclient"></a> DatabaseClient</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R2DbcTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 贴近底层，join操作好做，写SQL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DatabaseClient databaseClient;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">databaseClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        databaseClient.sql(<span class="string">&quot;select * from security_user&quot;</span>)</span><br><span class="line">                .fetch()</span><br><span class="line">                .all()</span><br><span class="line">                .map(map -&gt; &#123;</span><br><span class="line">                    System.out.println(map);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                &#125;)</span><br><span class="line">                .subscribe(System.out::println);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试-</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/relational/reference/r2dbc/repositories.html">R2DBC Repositories :: Spring Data Relational</a></p>
<h2 id="r2dbcrepository"><a class="markdownIt-Anchor" href="#r2dbcrepository"></a> R2dbcRepository</h2>
<h3 id="简单查询"><a class="markdownIt-Anchor" href="#简单查询"></a> 简单查询</h3>
<p>类似Mybatis-Plus中的IService，和BaseMapper</p>
<p>继承了很多CURD实现方法</p>
<p>QBE: Query BY Example</p>
<ol>
<li>
<p>实现配置信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableR2dbcRepositories</span> <span class="comment">// 开启R2dbcRepository</span></span><br><span class="line"><span class="meta">@Configuration</span>  <span class="comment">// 表明是一个配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R2DbcConfiguration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>继承R2dbcRepository接口，泛型第一个是该接口的实体类，第二个是该接口的主键类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepositories</span> <span class="keyword">extends</span> <span class="title class_">R2dbcRepository</span>&lt;User, String&gt; &#123;</span><br><span class="line">    <span class="comment">// 继承了很多CURD实现方法</span></span><br><span class="line">    <span class="comment">// QBE: Query BY Example</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * select * from security_user where id = ? and username like ?</span></span><br><span class="line"><span class="comment">     * 只限制单表复杂查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 参数ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 参数name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> UserList</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Flux&lt;User&gt; <span class="title function_">findAllByIdIsAndUserNameLike</span><span class="params">(String id, String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用接口信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userRepositories</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    userRepositories.findAll()</span><br><span class="line">        .subscribe(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>通过给接口命名来查询指定信息，例如下面的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * select * from security_user where id = ? and username like ?</span></span><br><span class="line"><span class="comment">     * 只限制单表复杂查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 参数ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 参数name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> UserList</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">Flux&lt;User&gt; <span class="title function_">findAllByIdIsAndUserNameLike</span><span class="params">(String id, String name)</span>;</span><br></pre></td></tr></table></figure>
<p>通过指定SQL查询语句来查询指定信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义查询语句</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回指定结果信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Query(&quot;SELECT * FROM security_user&quot;)</span></span><br><span class="line">Flux&lt;User&gt; <span class="title function_">myMethod</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<h3 id="复杂查询"><a class="markdownIt-Anchor" href="#复杂查询"></a> 复杂查询</h3>
<p>现在用户表和图书表，一个图书对应一个作者，一个作者对应多个图书</p>
<h4 id="一对一"><a class="markdownIt-Anchor" href="#一对一"></a> 一对一</h4>
<p>**一对一：**查询图书的时候将其对应的作者的信息查询出来</p>
<ol>
<li>
<p>定义实体类：在图书对象中封装用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table(&quot;t_book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="keyword">private</span> String authorId;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Transient</span> <span class="comment">// 标明次对象不是t_book里面的表</span></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义查询方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookRepositories</span> <span class="keyword">extends</span> <span class="title class_">R2dbcRepository</span>&lt;Book, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(&quot;select b.*, u.USERNAME author_name from t_book b &quot; +</span></span><br><span class="line"><span class="meta">           &quot; left join security_user u on b.author_id = u.ID &quot; +</span></span><br><span class="line"><span class="meta">           &quot; where b.id = :bookId&quot;)</span></span><br><span class="line">    Mono&lt;Book&gt; <span class="title function_">findBookAndAuthor</span><span class="params">(<span class="meta">@Param(&quot;bookId&quot;)</span> String bookId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>定义转换器：将查询出来的结果生成book对象并返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReadingConverter</span> <span class="comment">// 读取数据数据的时候，将row转换成Book对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;Row, Book&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">convert</span><span class="params">(Row source)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> source.get(<span class="string">&quot;id&quot;</span>, String.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> source.get(<span class="string">&quot;title&quot;</span>, String.class);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">createTime</span> <span class="operator">=</span> source.get(<span class="string">&quot;create_time&quot;</span>, LocalDateTime.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorId</span> <span class="operator">=</span> source.get(<span class="string">&quot;author_id&quot;</span>, String.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorName</span> <span class="operator">=</span> source.get(<span class="string">&quot;author_name&quot;</span>, String.class);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 设置图书对象</span></span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">        book.setId(id);</span><br><span class="line">        book.setTitle(title);</span><br><span class="line">        book.setCreateTime(createTime);</span><br><span class="line">        book.setAuthorId(authorId);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 设置用户对象</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(id);</span><br><span class="line">        user.setUserName(authorName);</span><br><span class="line">        book.setUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>注册转换器：在R2DBC配置中设置转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableR2dbcRepositories</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R2DbcConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> R2dbcCustomConversions <span class="title function_">r2dbcCustomConversions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R2dbcCustomConversions.of(MySqlDialect.INSTANCE, <span class="keyword">new</span> <span class="title class_">BookConverter</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>查询操作：直接查询出图书及其作者信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userRepositories</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    bookRepositories.findBookAndAuthor(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">        .subscribe(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>SpringData 在发现方法签名返回值是Book对象的时候就会调用自己设置BookConverter将返回值封装成Book对象</strong></p>
<p>**缺陷：<strong>如果设置了转化器，那么Repository中的所有返回类型是Book的方法都会去用这个转换器进行转换，在转换器中设置了</strong>String authorId = source.get(“author_id”, String.class);**这个方式去获取作者的id和姓名，在使用简单查询的时候，例如findbyId的时候，返回值结果中没有author_id这一项，会导致转换器报错，</p>
<p><strong>解决方法：</strong></p>
<ol>
<li>设置新Vo类 + 新Respository + 新映射类进行结果映射</li>
<li>在转换器中进行校验，**source.getMetadata().contains(“author_name”)**来判断返回结果是否有这一列，如果有再进行结果映射</li>
</ol>
<h4 id="一对多"><a class="markdownIt-Anchor" href="#一对多"></a> 一对多</h4>
<p>**一对多：**通过查出作者及其所有图书信息</p>
<p>结果信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/image-20250114225156011.png" alt="image-20250114225156011" /></p>
<p>**方式一：**通过使用groupby 将user_id分组，user_id一样的分为同一组，<strong>可以乱序</strong></p>
<p>**方式二：**使用BufferUntilChange来进行分组，将符合条件的分为同一组，<strong>必须按照user_id排好序</strong>，否则分不到一组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; block = databaseClient.sql(<span class="string">&quot;SELECT a.id user_id, a.USERNAME username , b.* FROM security_user a&quot;</span> +</span><br><span class="line">                                      <span class="string">&quot; LEFT JOIN t_book b ON a.ID = b.author_id&quot;</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .all()</span><br><span class="line">    .bufferUntilChanged(rowMap -&gt; Long.parseLong(rowMap.get(<span class="string">&quot;user_id&quot;</span>).toString()))</span><br><span class="line">    .map(bookList -&gt; &#123;</span><br><span class="line">        Map&lt;String, Object&gt; first = bookList.get(<span class="number">0</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(first.get(<span class="string">&quot;user_id&quot;</span>).toString());</span><br><span class="line">        user.setUserName(first.get(<span class="string">&quot;username&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line">        List&lt;Book&gt; list = bookList.stream()</span><br><span class="line">            .map(book -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (book.get(<span class="string">&quot;id&quot;</span>) == <span class="literal">null</span> || StringUtils.isBlank(book.get(<span class="string">&quot;id&quot;</span>).toString())) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">tempBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                tempBook.setId(book.get(<span class="string">&quot;id&quot;</span>).toString());</span><br><span class="line">                tempBook.setTitle(book.get(<span class="string">&quot;title&quot;</span>).toString());</span><br><span class="line">                tempBook.setAuthorId(book.get(<span class="string">&quot;author_id&quot;</span>).toString());</span><br><span class="line">                <span class="keyword">return</span> tempBook;</span><br><span class="line">            &#125;)</span><br><span class="line">            .filter(Objects::nonNull)</span><br><span class="line">            .toList();</span><br><span class="line">        user.setBooks(list);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;)</span><br><span class="line">    .collectList()</span><br><span class="line">    .block();</span><br><span class="line">System.out.println(block);</span><br></pre></td></tr></table></figure>
<h2 id="最佳实践"><a class="markdownIt-Anchor" href="#最佳实践"></a> 最佳实践</h2>
<ol>
<li>Spring Data R2DBC，基础的CRUD 用R2dbcRepository提供好了</li>
<li>自定义复杂的SOL(单表):@Query查询; 无需要做结果映射的</li>
<li>多表查询复杂结果集:
<ol>
<li>DataBaseClient 自定义SQL及结果封装</li>
<li>@Query注解 + 自定义Converter 实现对结果集封装</li>
</ol>
</li>
</ol>
<h1 id="springsecurity"><a class="markdownIt-Anchor" href="#springsecurity"></a> SpringSecurity</h1>
<h2 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h2>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.asyncer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--响应式Spring Data R2dbc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--响应式WEB--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="认证"><a class="markdownIt-Anchor" href="#认证"></a> 认证</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableReactiveMethodSecurity</span> <span class="comment">// 开启基于方法级别的响应式权限控制</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor = @__(@Autowired))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AppReactiveUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    SecurityWebFilterChain <span class="title function_">springSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先配置那些请求需要权限认证，那些不需要</span></span><br><span class="line">        http.authorizeExchange(authorize -&gt; &#123;</span><br><span class="line">            <span class="comment">// 配置路径请求 静态资源下的所有路径都可以访问</span></span><br><span class="line">            authorize.matchers(PathRequest.toStaticResources().atCommonLocations()).permitAll();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 剩下的资源都需要进行权限认证 （登录）</span></span><br><span class="line">            authorize.anyExchange().authenticated();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启默认表单登录</span></span><br><span class="line">        http.formLogin();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 安全控制操作</span></span><br><span class="line">        http.csrf(ServerHttpSecurity.CsrfSpec::disable);</span><br><span class="line"></span><br><span class="line">        http.authenticationManager(<span class="keyword">new</span> <span class="title class_">UserDetailsRepositoryReactiveAuthenticationManager</span>(userDetailsService));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建权限系统</span></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="授权"><a class="markdownIt-Anchor" href="#授权"></a> 授权</h2>
<h3 id="userdetailsservice"><a class="markdownIt-Anchor" href="#userdetailsservice"></a> UserDetailsService</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor = @__(@Autowired))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppReactiveUserDetailsService</span> <span class="keyword">implements</span> <span class="title class_">ReactiveUserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DatabaseClient databaseClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;UserDetails&gt; <span class="title function_">findByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> databaseClient.sql(<span class="string">&quot;SELECT u.*, r.`name` r_name, r.id rid,  r.`value` r_value, p.id pid, p.`value` p_value, p.description p_description FROM t_user u\n&quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;LEFT JOIN t_user_role ur ON ur.user_id = u.id\n&quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;LEFT JOIN t_roles r ON r.id = ur.role_id\n&quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;LEFT JOIN t_role_perm rp ON rp.role_id = r.id\n&quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;LEFT JOIN t_perm p ON p.id = rp.perm_id &quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;WHERE u.username = ?username &quot;</span> +</span><br><span class="line">                                  <span class="string">&quot;ORDER BY u.id DESC&quot;</span>)</span><br><span class="line">            .bind(<span class="number">0</span>, username)</span><br><span class="line">            .fetch()</span><br><span class="line">            .all()</span><br><span class="line">            .bufferUntilChanged(row -&gt; row.get(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">            .map(rows -&gt; &#123;</span><br><span class="line">                Map&lt;String, Object&gt; stringObjectMap = rows.get(<span class="number">0</span>);</span><br><span class="line">                HashSet&lt;String&gt; roelNameSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">                HashSet&lt;String&gt; permNameSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">                rows.forEach(row -&gt; &#123;</span><br><span class="line">                    roelNameSet.add(row.get(<span class="string">&quot;r_name&quot;</span>).toString());</span><br><span class="line">                    permNameSet.add(row.get(<span class="string">&quot;p_value&quot;</span>).toString());</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> User.builder()</span><br><span class="line">                    .username(stringObjectMap.get(<span class="string">&quot;username&quot;</span>).toString())</span><br><span class="line">                    .password(stringObjectMap.get(<span class="string">&quot;password&quot;</span>).toString())</span><br><span class="line">                    .roles(roelNameSet.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]))  <span class="comment">// role 和 Authorization只能写一个，后面写的生效，会覆盖掉前面写的</span></span><br><span class="line">                    <span class="comment">//                                          .authorities(permNameSet.toArray(new String[0]))</span></span><br><span class="line">                    .build();</span><br><span class="line">            &#125;)</span><br><span class="line">            .next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="preauthorize"><a class="markdownIt-Anchor" href="#preauthorize"></a> PreAuthorize</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;view&#x27;)&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/haha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">haha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;Haha&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Nuyoah</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/')">SpringBoot响应式编程</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/weL31EHsON5ldDU.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/08/16/2yRjVx9gFKQaidA.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringBoot响应式编程&amp;url=http://262259.xyz/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/&amp;pic=https://s2.loli.net/2022/11/19/j5yB7kgfqsJA2cz.png?_r_=d1dd1143-5885-6436-3ff8-77d3dfd2c9f0" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://262259.xyz" target="_blank">Nuyoah</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2022/11/08/b5885d06cbc7f57b.png?_r_=865128d7-fc1a-ec0d-5e92-8abc6fd4499a" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/24/JUC/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/a12d8f3566c2a6c1.png?_r_=1e65b57f-a7be-96d0-49dd-6bb6646d0d9e" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JUC</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/10/BIyWjOplvbE29hn.jpg?_r_=72f90032-8817-66d4-8111-2c0023ca911c" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringSecurity</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display: none">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Nuyoah</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/zjhinsist" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2152889763@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#function%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text"> Function函数式编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85consumer%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0%E4%B8%8D%E8%BF%94%E5%9B%9E"><span class="toc-number">1.1.</span> <span class="toc-text"> 消费者(consumer:接收参数不返回)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85supplier%E4%B8%8D%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0%E4%BD%86%E6%98%AF%E8%BF%94%E5%9B%9E"><span class="toc-number">1.2.</span> <span class="toc-text"> 提供者(Supplier:不接收参数但是返回)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0function%E6%9C%89%E5%85%A5%E5%8F%82%E6%9C%89%E4%B8%B2"><span class="toc-number">1.3.</span> <span class="toc-text"> 多功能函数(Function:有入参有串)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0%E6%97%A0%E5%85%A5%E5%8F%82%E6%97%A0%E5%87%BA%E5%8F%82"><span class="toc-number">1.4.</span> <span class="toc-text"> 普通函数(无入参无出参)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E8%A8%80%E6%9C%89%E5%85%A5%E5%8F%82%E8%BF%94%E5%9B%9Eboolean"><span class="toc-number">1.5.</span> <span class="toc-text"> 断言(有入参返回Boolean)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#streamapi"><span class="toc-number">2.</span> <span class="toc-text"> StreamAPI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E4%B8%8D%E5%B9%B6%E5%8F%91"><span class="toc-number">2.1.</span> <span class="toc-text"> 并发？不并发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B5%81"><span class="toc-number">2.2.</span> <span class="toc-text"> 创建流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#of"><span class="toc-number">2.2.1.</span> <span class="toc-text"> of</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builder"><span class="toc-number">2.2.2.</span> <span class="toc-text"> builder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concat"><span class="toc-number">2.2.3.</span> <span class="toc-text"> concat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#empty"><span class="toc-number">2.2.4.</span> <span class="toc-text"> empty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ofnullable"><span class="toc-number">2.2.5.</span> <span class="toc-text"> ofNullable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generate"><span class="toc-number">2.2.6.</span> <span class="toc-text"> generate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E5%90%88stream-%E5%B8%B8%E7%94%A8"><span class="toc-number">2.2.7.</span> <span class="toc-text"> 集合.stream() 常用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E6%93%8D%E4%BD%9C"><span class="toc-number">2.3.</span> <span class="toc-text"> 中间操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filter"><span class="toc-number">2.3.1.</span> <span class="toc-text"> filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map"><span class="toc-number">2.3.2.</span> <span class="toc-text"> map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flatmap"><span class="toc-number">2.3.3.</span> <span class="toc-text"> flatMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#distinct"><span class="toc-number">2.3.4.</span> <span class="toc-text"> distinct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sorted"><span class="toc-number">2.3.5.</span> <span class="toc-text"> sorted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#peek"><span class="toc-number">2.3.6.</span> <span class="toc-text"> peek</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit"><span class="toc-number">2.3.7.</span> <span class="toc-text"> limit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#takewhile"><span class="toc-number">2.3.8.</span> <span class="toc-text"> takeWhile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%88%E7%BB%93%E6%93%8D%E4%BD%9C"><span class="toc-number">2.4.</span> <span class="toc-text"> 终结操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#foreach"><span class="toc-number">2.4.1.</span> <span class="toc-text"> forEach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#count"><span class="toc-number">2.4.2.</span> <span class="toc-text"> count</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#toarray"><span class="toc-number">2.4.3.</span> <span class="toc-text"> toArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collect"><span class="toc-number">2.4.4.</span> <span class="toc-text"> collect</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#collectorstolist"><span class="toc-number">2.4.4.1.</span> <span class="toc-text"> Collectors.toList()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#collectorstoset"><span class="toc-number">2.4.4.2.</span> <span class="toc-text"> Collectors.toSet()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#collectorstomap"><span class="toc-number">2.4.4.3.</span> <span class="toc-text"> Collectors.toMap()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reactive"><span class="toc-number">3.</span> <span class="toc-text"> Reactive</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E6%83%B3"><span class="toc-number">3.1.</span> <span class="toc-text"> 思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#api%E7%BB%84%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> API组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#publisher"><span class="toc-number">3.2.1.</span> <span class="toc-text"> Publisher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subscriber"><span class="toc-number">3.2.2.</span> <span class="toc-text"> Subscriber</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#processor"><span class="toc-number">3.2.3.</span> <span class="toc-text"> Processor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reactor"><span class="toc-number">4.</span> <span class="toc-text"> Reactor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flux%E5%92%8Cmono%E7%AE%80%E5%8D%95%E5%BA%94%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text"> Flux和Mono简单应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flux%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text"> Flux使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mono%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text"> Mono使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#doonxxx%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.3.</span> <span class="toc-text"> doOnXXX的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7"><span class="toc-number">4.2.4.</span> <span class="toc-text"> 信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">4.3.</span> <span class="toc-text"> 日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#subscribe"><span class="toc-number">4.4.</span> <span class="toc-text"> subscribe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"><span class="toc-number">4.4.1.</span> <span class="toc-text"> 自定义回调方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#subscribe-2"><span class="toc-number">4.4.1.1.</span> <span class="toc-text"> subscribe()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#subscribeconsumer"><span class="toc-number">4.4.1.2.</span> <span class="toc-text"> subscribe(consumer)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#subscribeconsumer-errorconsumer"><span class="toc-number">4.4.1.3.</span> <span class="toc-text"> subscribe(consumer, errorConsumer)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#subscribeconsumer-errorconsumer-completeconsumer"><span class="toc-number">4.4.1.4.</span> <span class="toc-text"> subscribe(consumer, errorConsumer, completeConsumer)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">4.4.2.</span> <span class="toc-text"> 自定义消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E8%B4%B9%E8%80%85basesubscriber"><span class="toc-number">4.4.2.1.</span> <span class="toc-text"> 实现自定义消费者BaseSubscriber</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E6%B5%81"><span class="toc-number">4.4.2.2.</span> <span class="toc-text"> 取消流</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E5%8E%8Bbackpressure"><span class="toc-number">4.5.</span> <span class="toc-text"> 背压（Backpressure）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%87%8D%E5%A1%91reshape-request"><span class="toc-number">4.6.</span> <span class="toc-text"> 请求重塑（Reshape Request）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#buffer"><span class="toc-number">4.6.1.</span> <span class="toc-text"> .buffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limitreatn"><span class="toc-number">4.6.2.</span> <span class="toc-text"> .limitReat(N)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E5%88%9B%E5%BB%BA%E6%B5%81"><span class="toc-number">4.7.</span> <span class="toc-text"> 编程式创建流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5generate"><span class="toc-number">4.7.1.</span> <span class="toc-text"> 同步generate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5-%E5%A4%9A%E7%BA%BF%E7%A8%8Bcreate"><span class="toc-number">4.7.2.</span> <span class="toc-text"> 异步-多线程create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95-handle"><span class="toc-number">4.7.3.</span> <span class="toc-text"> 自定义处理方法 handle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%B0%83%E5%BA%A6"><span class="toc-number">4.8.</span> <span class="toc-text"> 线程和调度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">4.9.</span> <span class="toc-text"> 常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filter-2"><span class="toc-number">4.9.1.</span> <span class="toc-text"> Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flatmap-2"><span class="toc-number">4.9.2.</span> <span class="toc-text"> FlatMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concatmap"><span class="toc-number">4.9.3.</span> <span class="toc-text"> concatMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concat-2"><span class="toc-number">4.9.4.</span> <span class="toc-text"> concat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concatwith"><span class="toc-number">4.9.5.</span> <span class="toc-text"> concatWith</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transform"><span class="toc-number">4.9.6.</span> <span class="toc-text"> Transform</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transformdeferred"><span class="toc-number">4.9.7.</span> <span class="toc-text"> transformDeferred</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#empty-2"><span class="toc-number">4.9.8.</span> <span class="toc-text"> Empty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defaultifempty"><span class="toc-number">4.9.9.</span> <span class="toc-text"> defaultIfEmpty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#merge"><span class="toc-number">4.9.10.</span> <span class="toc-text"> merge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mergewith"><span class="toc-number">4.9.11.</span> <span class="toc-text"> mergeWith</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mergesequential"><span class="toc-number">4.9.12.</span> <span class="toc-text"> mergeSequential</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zip"><span class="toc-number">4.9.13.</span> <span class="toc-text"> zip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#next"><span class="toc-number">4.9.14.</span> <span class="toc-text"> next</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">4.10.</span> <span class="toc-text"> 错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4"><span class="toc-number">4.10.1.</span> <span class="toc-text"> 默认</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrorreturn"><span class="toc-number">4.10.2.</span> <span class="toc-text"> onErrorReturn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrorresume"><span class="toc-number">4.10.3.</span> <span class="toc-text"> onErrorResume</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">4.10.3.1.</span> <span class="toc-text"> 调用回调函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E5%B9%B6%E6%A0%B9%E6%8D%AE%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">4.10.3.2.</span> <span class="toc-text"> 捕获并根据错误处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrormap"><span class="toc-number">4.10.4.</span> <span class="toc-text"> onErrorMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E5%B9%B6%E6%8A%9B%E5%87%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8"><span class="toc-number">4.10.4.1.</span> <span class="toc-text"> 捕获并抛出自定义异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#doonerror"><span class="toc-number">4.10.5.</span> <span class="toc-text"> doOnError</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dofinally"><span class="toc-number">4.10.6.</span> <span class="toc-text"> doFinally</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrorcontinue"><span class="toc-number">4.10.7.</span> <span class="toc-text"> onErrorContinue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrorstop"><span class="toc-number">4.10.8.</span> <span class="toc-text"> onErrorStop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onerrorcomplete"><span class="toc-number">4.10.9.</span> <span class="toc-text"> onErrorComplete</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E6%97%B6and%E9%87%8D%E8%AF%95"><span class="toc-number">4.11.</span> <span class="toc-text"> 超时And重试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sinks%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">4.12.</span> <span class="toc-text"> Sinks工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#many"><span class="toc-number">4.12.1.</span> <span class="toc-text"> many</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unicast"><span class="toc-number">4.12.1.1.</span> <span class="toc-text"> unicast</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#multicast"><span class="toc-number">4.12.1.2.</span> <span class="toc-text"> multicast</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#replay"><span class="toc-number">4.12.1.3.</span> <span class="toc-text"> replay</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cache-%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-number">4.12.2.</span> <span class="toc-text"> cache 缓存数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#block-%E9%98%BB%E5%A1%9E%E8%8E%B7%E5%8F%96"><span class="toc-number">4.12.3.</span> <span class="toc-text"> block 阻塞获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parallel-%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.12.4.</span> <span class="toc-text"> parallel 并发线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#context"><span class="toc-number">4.12.5.</span> <span class="toc-text"> Context</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webflux"><span class="toc-number">5.</span> <span class="toc-text"> WebFlux</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%AF%B9%E6%AF%94"><span class="toc-number">5.1.</span> <span class="toc-text"> 组件对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">5.2.</span> <span class="toc-text"> 准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.2.2.</span> <span class="toc-text"> 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.2.3.</span> <span class="toc-text"> 流程转换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text"> 处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E5%BC%80%E5%8F%91"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 简化开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sse"><span class="toc-number">5.3.2.</span> <span class="toc-text"> SSE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dispatcherhandler"><span class="toc-number">5.4.</span> <span class="toc-text"> DispatcherHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#handle%E6%BA%90%E7%A0%81"><span class="toc-number">5.4.1.</span> <span class="toc-text"> handle源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83"><span class="toc-number">5.4.2.</span> <span class="toc-text"> 核心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%8F%91"><span class="toc-number">5.5.</span> <span class="toc-text"> 注解开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E4%BC%A0%E5%8F%82"><span class="toc-number">5.5.1.</span> <span class="toc-text"> 目标方法传参</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%86%99%E6%B3%95"><span class="toc-number">5.5.2.</span> <span class="toc-text"> 返回值写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">5.5.3.</span> <span class="toc-text"> 文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-2"><span class="toc-number">5.5.4.</span> <span class="toc-text"> 错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89webflux%E9%85%8D%E7%BD%AE"><span class="toc-number">5.5.5.</span> <span class="toc-text"> 自定义WebFlux配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">5.5.6.</span> <span class="toc-text"> Filter过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rdbc"><span class="toc-number">6.</span> <span class="toc-text"> RDBC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BE%8B"><span class="toc-number">6.1.</span> <span class="toc-text"> 用例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-3"><span class="toc-number">6.1.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">6.1.2.</span> <span class="toc-text"> 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">6.1.3.</span> <span class="toc-text"> 优势</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%90%88springboot"><span class="toc-number">6.2.</span> <span class="toc-text"> 整合SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-4"><span class="toc-number">6.2.1.</span> <span class="toc-text"> 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.2.</span> <span class="toc-text"> 整合配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#r2dbcentitytemplate"><span class="toc-number">6.3.</span> <span class="toc-text"> R2dbcEntityTemplate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#databaseclient"><span class="toc-number">6.4.</span> <span class="toc-text"> DatabaseClient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#r2dbcrepository"><span class="toc-number">6.5.</span> <span class="toc-text"> R2dbcRepository</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.1.</span> <span class="toc-text"> 简单查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.5.2.</span> <span class="toc-text"> 复杂查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">6.5.2.1.</span> <span class="toc-text"> 一对一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">6.5.2.2.</span> <span class="toc-text"> 一对多</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">6.6.</span> <span class="toc-text"> 最佳实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#springsecurity"><span class="toc-number">7.</span> <span class="toc-text"> SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">7.1.</span> <span class="toc-text"> 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">7.2.</span> <span class="toc-text"> 认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">7.3.</span> <span class="toc-text"> 授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#userdetailsservice"><span class="toc-number">7.3.1.</span> <span class="toc-text"> UserDetailsService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#preauthorize"><span class="toc-number">7.3.2.</span> <span class="toc-text"> PreAuthorize</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/27/%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD/" title="文件的上传和下载"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/b5885d06cbc7f57b.png?_r_=865128d7-fc1a-ec0d-5e92-8abc6fd4499a" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件的上传和下载"/></a><div class="content"><a class="title" href="/2024/10/27/%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8A%E4%BC%A0%E5%92%8C%E4%B8%8B%E8%BD%BD/" title="文件的上传和下载">文件的上传和下载</a><time datetime="2024-10-27T01:50:10.000Z" title="发表于 2024-10-27 09:50:10">2024-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/" title="SpringSecurity"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/10/BIyWjOplvbE29hn.jpg?_r_=72f90032-8817-66d4-8111-2c0023ca911c" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringSecurity"/></a><div class="content"><a class="title" href="/2024/10/15/SpringSecurity%E5%A4%8D%E4%B9%A0/" title="SpringSecurity">SpringSecurity</a><time datetime="2024-10-15T00:39:29.000Z" title="发表于 2024-10-15 08:39:29">2024-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" title="SpringBoot响应式编程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/19/j5yB7kgfqsJA2cz.png?_r_=d1dd1143-5885-6436-3ff8-77d3dfd2c9f0" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringBoot响应式编程"/></a><div class="content"><a class="title" href="/2024/09/26/SpringBoot%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B/" title="SpringBoot响应式编程">SpringBoot响应式编程</a><time datetime="2024-09-26T13:26:18.000Z" title="发表于 2024-09-26 21:26:18">2024-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/24/JUC/" title="JUC"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s3.bmp.ovh/imgs/2022/11/08/a12d8f3566c2a6c1.png?_r_=1e65b57f-a7be-96d0-49dd-6bb6646d0d9e" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JUC"/></a><div class="content"><a class="title" href="/2024/09/24/JUC/" title="JUC">JUC</a><time datetime="2024-09-24T13:41:04.000Z" title="发表于 2024-09-24 21:41:04">2024-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/05/SpringBoot%E4%B8%ADnew%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C-Autowrite%E6%B3%A8%E5%85%A5%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8C%BA%E5%88%AB/" title="new与@Autowrite创建对象的区别"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2022/11/10/An5KBXLNYlODop3.jpg?_r_=d3eabe9b-059d-51d8-f5d8-8e193c8a6967" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="new与@Autowrite创建对象的区别"/></a><div class="content"><a class="title" href="/2024/09/05/SpringBoot%E4%B8%ADnew%E5%87%BA%E6%9D%A5%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%92%8C-Autowrite%E6%B3%A8%E5%85%A5%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8C%BA%E5%88%AB/" title="new与@Autowrite创建对象的区别">new与@Autowrite创建对象的区别</a><time datetime="2024-09-05T14:03:05.000Z" title="发表于 2024-09-05 22:03:05">2024-09-05</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="Nuyoah" target="_blank">Nuyoah</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">85</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://262259.xyz/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a><a class="back-menu-item" href="https://262259.xyz/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s1.ax1x.com/2022/11/27/zUFla6.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.262259.xyz/" title="博客后端"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://unpkg.com/qexo-static@1.4.0/assets/img/brand/qexo.png" alt="博客后端"/><span class="back-menu-item-text">博客后端</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Gitee/" style="font-size: 0.88rem;">Gitee<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 0.88rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JAVA<sup>5</sup></a><a href="/tags/JS/" style="font-size: 0.88rem;">JS<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>7</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>2</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem;">hexo<sup>4</sup></a><a href="/tags/win10/" style="font-size: 0.88rem;">win10<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/" style="font-size: 0.88rem;">个人日记<sup>1</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 0.88rem;">人工智能<sup>15</sup></a><a href="/tags/%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF%E4%BA%8E%E9%80%BB%E8%BE%91/" style="font-size: 0.88rem;">数字电路于逻辑<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" style="font-size: 0.88rem;">算法实现<sup>12</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">计算机基础<sup>13</sup></a></div></div><hr/></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Nuyoah 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.262259.xyz/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.262259.xyz/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.262259.xyz/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>